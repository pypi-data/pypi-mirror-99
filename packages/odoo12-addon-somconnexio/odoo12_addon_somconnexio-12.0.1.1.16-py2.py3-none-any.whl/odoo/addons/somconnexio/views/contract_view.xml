<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <record id="contract_contract_form_view" model="ir.ui.view">
    <field name="name">contract.contract.form.view</field>
    <field name="model">contract.contract</field>
    <field name="inherit_id" ref="contract.contract_contract_customer_form_view" />
    <field name="arch" type="xml">
      <field name="partner_id" position="attributes">
        <attribute name="domain">[('customer','=',True), ('parent_id', '=', False)]</attribute>
      </field>
      <field name="partner_id" position="after">
        <field name="partner_priority"/>
      </field>
      <field name="contract_template_id" position="attributes">
        <attribute name="invisible">1</attribute>
      </field>
      <field name="fiscal_position_id" position="attributes">
        <attribute name="invisible">1</attribute>
      </field>
      <field name="tag_ids" position="attributes">
        <attribute name="invisible">1</attribute>
      </field>
      <field name="pricelist_id" position="attributes">
        <attribute name="invisible">1</attribute>
      </field>
      <field name="recurring_next_date" position="attributes">
        <attribute name="invisible">1</attribute>
      </field>
      <field name="contract_template_id" position="after">
        <field name="available_email_ids" invisible="True"/>
        <field name="email_ids" widget="many2many_tags_contract_email"
               options="{'no_create_edit':True}"
               context="{'email_tags': True}"
               domain="[('id', 'in', available_email_ids)]"
        />
        <field name="code" position="move"/>
        <field name="ticket_number" />
      </field>
      <group name="main" position="after">
        <group name="contract_service">
          <group>
            <field name="is_broadband" invisible="1" />
            <field name="service_contract_type" invisible="1"/>
            <field name="service_partner_id"
                   attrs="{'invisible': [('is_broadband','=',False)]}" />
            <field name="mobile_contract_service_info_id"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'mobile')]}" />
            <field name="adsl_service_contract_info_id"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'adsl')]}" />
            <field name="vodafone_fiber_service_contract_info_id"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'vodafone')]}" />
            <field name="mm_fiber_service_contract_info_id"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'masmovil')]}" />
            <field name="icc"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'mobile')]}" />
            <field name="ppp_user"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'adsl')]}" />
            <field name="ppp_password"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'adsl')]}" />
            <field name="endpoint_user"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'adsl')]}" />
            <field name="endpoint_password"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'adsl')]}" />
            <field name="vodafone_id"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'vodafone')]}" />
            <field name="vodafone_offer_code"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'vodafone')]}" />
            <field name="mm_id"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'masmovil')]}" />
          </group>
          <group>
            <field name="current_tariff_product"/>
            <field name="service_technology_id" />
            <field name="service_supplier_id" />
            <field name="administrative_number"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'adsl')]}" />
            <field name="router_product_id"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'adsl')]}" />
            <field name="router_lot_id"
                   attrs="{'invisible': ['!',('service_contract_type', '=', 'adsl')]}" />
          </group>
        </group>
      </group>
      <field name="date_end" position="after">
        <field name="date_start"/>
      </field>
      <xpath expr="//field[@name='contract_line_ids']/tree/field[@name='name']" position="attributes">
        <attribute name="invisible">1</attribute>
      </xpath>
      <xpath expr="//field[@name='contract_line_ids']/tree/button[@name='cancel']" position="attributes">
        <attribute name="invisible">1</attribute>
      </xpath>
      <xpath expr="//field[@name='contract_line_ids']/tree/button[@name='action_stop_plan_successor']" position="attributes">
        <attribute name="invisible">1</attribute>
      </xpath>
      <xpath expr="//field[@name='contract_line_ids']/tree/button[@name='action_stop']" position="attributes">
        <attribute name="invisible">1</attribute>
      </xpath>
      <xpath expr="//field[@name='contract_line_ids']/tree" position="attributes">
        <attribute name="delete">false</attribute>
      </xpath>
    </field>
  </record>
  <record id="contract_contract_form_admin_view" model="ir.ui.view">
    <field name="name">contract.contract.form.admin.view</field>
    <field name="model">contract.contract</field>
    <field name="inherit_id" ref="somconnexio.contract_contract_form_view" />
    <field name="groups_id" eval="[(6,0,[ref('somconnexio.group_somconnexio_admin')])]" />
    <field name="arch" type="xml">
      <xpath expr="//field[@name='contract_line_ids']/tree" position="attributes">
        <attribute name="delete">true</attribute>
      </xpath>
    </field>
  </record>

  <record id="broadband_contract_search_view" model="ir.ui.view">
      <field name="name">broadband search view</field>
      <field name="model">contract.contract</field>
      <field name="arch" type="xml">
        <search>
          <field name="name"
                  filter_domain="['|','|','|','|','|','|',('name', 'ilike', self),('code', 'ilike', self),('phone_number', 'ilike', self),('partner_id', 'ilike', self),('partner_id.vat', 'ilike', self),('vodafone_id', 'ilike', self), ('mm_id', 'ilike', self)]"/>
          <field name="journal_id"/>
          <field name="pricelist_id"/>
          <separator/>
          <separator/>
          <filter name="not_finished"
                  string="In progress"
                  domain="['|', ('date_end', '&gt;=', context_today().strftime('%Y-%m-%d')), '&amp;', ('date_end', '=', False), ('recurring_next_date', '!=', False)]"
          />
          <filter name="finished"
                  string="Finished"
                  domain="[('date_end', '&lt;', context_today().strftime('%Y-%m-%d'))]"
          />
          <separator/>
          <filter string="MásMóvil" name="service_supplier_id"
                  domain="[('service_supplier_id', '=', %(service_supplier_masmovil)d)]"/>
          <filter string="Jazztel" name="service_supplier_id"
                  domain="[('service_supplier_id', '=', %(service_supplier_jazztel)d)]"/>
          <filter string="Vodafone" name="service_supplier_id"
                  domain="[('service_supplier_id', '=', %(service_supplier_vodafone)d)]"/>
          <separator/>
          <field name="partner_id"/>
          <field name="commercial_partner_id"/>
          <filter string="Archived"
                  domain="[('active', '=', False)]"
                  name="inactive"/>
          <group expand="0" string="Group By...">
              <filter name="service_supplier_id"
                      string="Supplier"
                      context="{'group_by':'service_supplier_id'}"/>
              <filter string="Associated Partner"
                      name="group_by_partner"
                      domain="[]"
                      context="{'group_by':'partner_id'}"/>
              <filter name="commercial_partner_groupby"
                      string="Commercial Entity"
                      context="{'group_by': 'commercial_partner_id'}"/>
              <filter name="group_by_next_invoice"
                      string="Next Invoice"
                      domain="[('recurring_next_date', '!=', False)]"
                      context="{'group_by':'recurring_next_date'}"
              />
              <filter name="group_by_date_end"
                      string="Date End"
                      domain="[]"
                      context="{'group_by':'date_end'}"
              />
            </group>
        </search>
      </field>
    </record>

  <record id="mobile_contract_search_view" model="ir.ui.view">
    <field name="name">contract.contract search view (in contract)</field>
    <field name="model">contract.contract</field>
    <field name="inherit_id" ref="contract.contract_contract_search_view" />
    <field name="arch" type="xml">
      <filter name="finished" position="attributes">
        <attribute name="domain">[('date_end', '&lt;', context_today().strftime('%Y-%m-%d'))]</attribute>
      </filter>
      <field name="name" position="attributes">
        <attribute name="filter_domain">['|','|','|','|','|','|',('name', 'ilike', self),('code', 'ilike', self),('phone_number', 'ilike', self),('partner_id', 'ilike', self),('partner_id.vat', 'ilike', self),('vodafone_id', 'ilike', self), ('mm_id', 'ilike', self)]</attribute>
      </field>
    </field>
  </record>

  <act_window id="action_contracts_mobile" name="Mobile Contracts"
              res_model="contract.contract" view_mode="tree,form"
              domain="[('service_technology_id.name', '=', 'Mobile')]" />

  <record id="contract_contract_tree_mobile_view" model="ir.ui.view">
    <field name="name">contract.tree.mobile.view</field>
    <field name="model">contract.contract</field>
    <field name="arch" type="xml">
      <tree>
        <field name="id" widget="open_tab"/>
        <field name="code"/>
        <field name="partner_id"/>
        <field name="active" invisible="1"/>
        <field name="company_id" groups="base.group_multi_company"/>
        <field name="phone_number" />
        <field name="icc" />
        <field name="is_terminated" />
        <field name="date_start" />
        <field name="date_end" />
        <field name="current_tariff_product" />
      </tree>
    </field>
  </record>
  <record id="contract_contract_tree_broadband_view" model="ir.ui.view">
    <field name="name">contract.tree.broadband.view</field>
    <field name="model">contract.contract</field>
    <field name="arch" type="xml">
      <tree>
        <field name="id" widget="open_tab"/>
        <field name="code"/>
        <field name="partner_id"/>
        <field name="active" invisible="1"/>
        <field name="company_id" groups="base.group_multi_company"/>
        <field name="phone_number" />
        <field name="service_supplier_id"/>
        <field name="vodafone_id" />
        <field name="vodafone_offer_code" />
        <field name="mm_id" />
        <field name="is_terminated" />
        <field name="date_start" />
        <field name="date_end" />
        <field name="current_tariff_product" />
      </tree>
    </field>
  </record>
  <record model="ir.actions.act_window.view" id="action_contracts_mobile_tree">
    <field name="sequence">0</field>
    <field name="view_mode">tree</field>
    <field name="view_id" ref="contract_contract_tree_mobile_view" />
    <field name="act_window_id" ref="action_contracts_mobile" />
  </record>
  <record model="ir.actions.act_window.view" id="action_contracts_mobile_form">
    <field name="sequence">1</field>
    <field name="view_mode">form</field>
    <field name="view_id" ref="contract_contract_form_view" />
    <field name="act_window_id" ref="action_contracts_mobile" />
  </record>

  <menuitem id="menu_contracts_mobile" name="Mobile Contracts"
            action="action_contracts_mobile"
            web_icon="somconnexio,static/description/mobile_contract.png"/>

  <act_window id="action_contracts_broadband" name="Broadband Contracts"
              res_model="contract.contract" view_mode="tree,form"
              domain="['|',('service_technology_id.name', '=', 'Fiber'),('service_technology_id.name', '=', 'ADSL')]" />

  <record model="ir.actions.act_window.view" id="action_contracts_broadband_tree">
    <field name="sequence">0</field>
    <field name="view_mode">tree</field>
    <field name="view_id" ref="contract_contract_tree_broadband_view" />
    <field name="act_window_id" ref="action_contracts_broadband" />
  </record>
  <record model="ir.actions.act_window.view" id="action_contracts_broadband_form">
    <field name="sequence">1</field>
    <field name="view_mode">form</field>
    <field name="view_id" ref="contract_contract_form_view" />
    <field name="act_window_id" ref="action_contracts_broadband" />
  </record>

  <menuitem id="menu_contracts_broadband" name="Broadband Contracts"
            action="action_contracts_broadband"
            web_icon="somconnexio,static/description/broadband_contract.png" />
  <record id="contract_contract_customer_tree_view" model="ir.ui.view">
    <field name="name">contract.customer.tree.view</field>
    <field name="model">contract.contract</field>
    <field name="arch" type="xml">
      <tree>
        <field name="code" />
        <field name="partner_id"/>
        <field name="date_start" />
        <field name="date_end" />
        <field name="current_tariff_product" />
        <field name="service_technology_id" />
        <field name="service_supplier_id" />
        <field name="phone_number"/>
        <field name="is_terminated" />
        <field name="payment_mode_id" />
      </tree>
    </field>
  </record>
  <record id="contract.action_customer_contract_view_tree" model="ir.actions.act_window.view">
    <field name="view_id" ref="contract_contract_customer_tree_view"/>
  </record>
  <record id="act_contract_contract_2_mail_activity" model="ir.actions.act_window">
      <field name="name">Activities</field>
      <field name="res_model">mail.activity</field>
      <field name="view_type">form</field>
      <field name="view_mode">tree,form</field>
      <field name="context">{'search_default_res_id': active_id, 'search_default_res_model': 'contract.contract'}</field>
  </record>

  <record id="contract_contract_view_buttons" model="ir.ui.view">
    <field name="name">contract.contract.view.buttons</field>
    <field name="model">contract.contract</field>
    <field name="inherit_id" ref="contract.contract_contract_form_view" />
    <field name="priority" eval="3"/>
    <field name="arch" type="xml">
        <button name="toggle_active" position="before">
            <button class="oe_stat_button" type="action" name="%(somconnexio.act_contract_contract_2_mail_activity)d"
                icon="fa-clock-o">
                <field name="mail_activity_count" widget="statinfo"/>
            </button>
        </button>
    </field>
  </record>


  <record id="somconnexio.action_contracts_broadband" model="ir.actions.act_window">
    <field name="search_view_id" ref="somconnexio.broadband_contract_search_view"/>
  </record>

  <record id="somconnexio.action_contracts_mobile" model="ir.actions.act_window">
    <field name="search_view_id" ref="somconnexio.mobile_contract_search_view"/>
  </record>

</odoo>

