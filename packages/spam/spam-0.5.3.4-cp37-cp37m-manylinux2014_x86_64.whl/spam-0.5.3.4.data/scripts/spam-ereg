#!python

"""
This python script is a graphical tool for aligning 3D images by eye using QT5 and SPAM functions
Copyright (C) 2020 SPAM Contributors

This program is free software: you can redistribute it and/or modify it
under the terms of the GNU General Public License as published by the Free
Software Foundation, either version 3 of the License, or (at your option)
any later version.

This program is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
more details.

You should have received a copy of the GNU General Public License along with
this program.  If not, see <http://www.gnu.org/licenses/>.
"""

import sys
import os
from PyQt5.QtWidgets import QApplication, QWidget, QFileDialog, QGridLayout
import spam.visual.visualClass as visual
import numpy
import tifffile


def main():
    app = QApplication(sys.argv)
    # load parameters from sys.argv and if none have been called open a file manager to select them
    try:
        binning = int(sys.argv[1])
    except:
        print("usage : spam-ereg BINNING [Im1 Im2 Phi]")
        print("binning = 1")
        binning = 1

    try:
        fileName1 = sys.argv[2]
        fileName2 = sys.argv[3]
        images = [tifffile.imread(fileName1), tifffile.imread(fileName2)]
    except:
        images = []
        fileName1 = QFileDialog.getOpenFileName(None, 'Open Image 1', os.getcwd())[0]
        images.append(tifffile.imread(fileName1))
        fileName2 = QFileDialog.getOpenFileName(None, 'Open Image 2', os.path.dirname(os.path.realpath(fileName1)))[0]
        images.append(tifffile.imread(fileName2))

    try:
        f = numpy.genfromtxt(sys.argv[4], delimiter="\t", names=True)
        Phi = numpy.array([[float(f["Fzz"]), float(f["Fzy"] ), float(f["Fzx"]), float(f['Zdisp'])],
                           [float(f["Fyz"]), float(f["Fyy"]), float(f["Fyx"]), float(f['Ydisp'])],
                           [float(f["Fxz"]), float(f["Fxy"]), float(f["Fxx"]), float(f['Xdisp'])],
                           [0, 0, 0, 1]])
    except:
        try:
            f = numpy.genfromtxt(QFileDialog.getOpenFileName(None, '(optional) Open Phi TSV', os.path.dirname(os.path.realpath(fileName1)))[0], delimiter="\t", names=True)
            Phi = numpy.array([[float(f["Fzz"]), float(f["Fzy"]), float(f["Fzx"]), float(f['Zdisp'])],
                               [float(f["Fyz"]), float(f["Fyy"]), float(f["Fyx"]), float(f['Ydisp'])],
                               [float(f["Fxz"]), float(f["Fxy"]), float(f["Fxx"]), float(f['Xdisp'])],
                               [0, 0, 0, 1]])
        except:
            Phi = numpy.eye(4, 4)
    window = QWidget()
    mainWindowGrid = QGridLayout(window)
    eregWidget = visual.ereg(images, Phi, binning, [fileName1, fileName2])
    mainWindowGrid.addWidget(eregWidget, 1, 1)
    window.show()
    eregWidget.show()
    sys.exit(app.exec_())


if __name__ == '__main__':
    main()
