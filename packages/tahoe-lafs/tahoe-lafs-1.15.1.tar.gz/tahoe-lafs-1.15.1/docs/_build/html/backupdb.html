
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>The Tahoe BackupDB &#8212; Tahoe-LAFS 1.x documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Developer Guide" href="developer-guide.html" />
    <link rel="prev" title="Avoiding Write Collisions in Tahoe" href="write_coordination.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="developer-guide.html" title="Developer Guide"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="write_coordination.html" title="Avoiding Write Collisions in Tahoe"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Tahoe-LAFS 1.x documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-tahoe-backupdb">
<h1>The Tahoe BackupDB<a class="headerlink" href="#the-tahoe-backupdb" title="Permalink to this headline">¶</a></h1>
<ol class="arabic simple">
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#schema">Schema</a></li>
<li><a class="reference internal" href="#upload-operation">Upload Operation</a></li>
<li><a class="reference internal" href="#directory-operations">Directory Operations</a></li>
</ol>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>To speed up backup operations, Tahoe maintains a small database known as the
“backupdb”. This is used to avoid re-uploading files which have already been
uploaded recently.</p>
<p>This database lives in <code class="docutils literal notranslate"><span class="pre">~/.tahoe/private/backupdb.sqlite</span></code>, and is a SQLite
single-file database. It is used by the “<code class="docutils literal notranslate"><span class="pre">tahoe</span> <span class="pre">backup</span></code>” command. In the
future, it may optionally be used by other commands such as “<code class="docutils literal notranslate"><span class="pre">tahoe</span> <span class="pre">cp</span></code>”.</p>
<p>The purpose of this database is twofold: to manage the file-to-cap
translation (the “upload” step) and the directory-to-cap translation (the
“mkdir-immutable” step).</p>
<p>The overall goal of optimizing backup is to reduce the work required when the
source disk has not changed (much) since the last backup. In the ideal case,
running “<code class="docutils literal notranslate"><span class="pre">tahoe</span> <span class="pre">backup</span></code>” twice in a row, with no intervening changes to the
disk, will not require any network traffic. Minimal changes to the source
disk should result in minimal traffic.</p>
<p>This database is optional. If it is deleted, the worst effect is that a
subsequent backup operation may use more effort (network bandwidth, CPU
cycles, and disk IO) than it would have without the backupdb.</p>
<p>The database uses sqlite3, which is included as part of the standard Python
library with Python 2.5 and later. For Python 2.4, Tahoe will try to install the
“pysqlite” package at build-time, but this will succeed only if sqlite3 with
development headers is already installed.  On Debian and Debian derivatives
you can install the “python-pysqlite2” package (which, despite the name,
actually provides sqlite3 rather than sqlite2). On old distributions such
as Debian etch (4.0 “oldstable”) or Ubuntu Edgy (6.10) the “python-pysqlite2”
package won’t work, but the “sqlite3-dev” package will.</p>
</div>
<div class="section" id="schema">
<h2>Schema<a class="headerlink" href="#schema" title="Permalink to this headline">¶</a></h2>
<p>The database contains the following tables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">version</span>
<span class="p">(</span>
 <span class="n">version</span> <span class="n">integer</span>  <span class="c1"># contains one row, set to 1</span>
<span class="p">);</span>

<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">local_files</span>
<span class="p">(</span>
 <span class="n">path</span>  <span class="n">varchar</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>  <span class="n">PRIMARY</span> <span class="n">KEY</span> <span class="o">--</span> <span class="n">index</span><span class="p">,</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">absolute</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="n">encoded</span> <span class="n">local</span> <span class="n">filename</span>
 <span class="n">size</span>  <span class="n">integer</span><span class="p">,</span>         <span class="o">--</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_SIZE</span><span class="p">]</span>
 <span class="n">mtime</span> <span class="n">number</span><span class="p">,</span>          <span class="o">--</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MTIME</span><span class="p">]</span>
 <span class="n">ctime</span> <span class="n">number</span><span class="p">,</span>          <span class="o">--</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_CTIME</span><span class="p">]</span>
 <span class="n">fileid</span> <span class="n">integer</span>
<span class="p">);</span>

<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">caps</span>
<span class="p">(</span>
 <span class="n">fileid</span> <span class="n">integer</span> <span class="n">PRIMARY</span> <span class="n">KEY</span> <span class="n">AUTOINCREMENT</span><span class="p">,</span>
 <span class="n">filecap</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="n">UNIQUE</span>    <span class="o">--</span> <span class="n">URI</span><span class="p">:</span><span class="n">CHK</span><span class="p">:</span><span class="o">...</span>
<span class="p">);</span>

<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">last_upload</span>
<span class="p">(</span>
 <span class="n">fileid</span> <span class="n">INTEGER</span> <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">,</span>
 <span class="n">last_uploaded</span> <span class="n">TIMESTAMP</span><span class="p">,</span>
 <span class="n">last_checked</span> <span class="n">TIMESTAMP</span>
<span class="p">);</span>

<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">directories</span>
<span class="p">(</span>
 <span class="n">dirhash</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">,</span>
 <span class="n">dircap</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
 <span class="n">last_uploaded</span> <span class="n">TIMESTAMP</span><span class="p">,</span>
 <span class="n">last_checked</span> <span class="n">TIMESTAMP</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="upload-operation">
<h2>Upload Operation<a class="headerlink" href="#upload-operation" title="Permalink to this headline">¶</a></h2>
<p>The upload process starts with a pathname (like <code class="docutils literal notranslate"><span class="pre">~/.emacs</span></code>) and wants to end up
with a file-cap (like <code class="docutils literal notranslate"><span class="pre">URI:CHK:...</span></code>).</p>
<p>The first step is to convert the path to an absolute form
(<code class="docutils literal notranslate"><span class="pre">/home/warner/.emacs</span></code>) and do a lookup in the local_files table. If the path
is not present in this table, the file must be uploaded. The upload process
is:</p>
<ol class="arabic simple">
<li>record the file’s size, ctime (which is the directory-entry change time or
file creation time depending on OS) and modification time</li>
<li>upload the file into the grid, obtaining an immutable file read-cap</li>
<li>add an entry to the ‘caps’ table, with the read-cap, to get a fileid</li>
<li>add an entry to the ‘last_upload’ table, with the current time</li>
<li>add an entry to the ‘local_files’ table, with the fileid, the path,
and the local file’s size/ctime/mtime</li>
</ol>
<p>If the path <em>is</em> present in ‘local_files’, the easy-to-compute identifying
information is compared: file size and ctime/mtime. If these differ, the file
must be uploaded. The row is removed from the local_files table, and the
upload process above is followed.</p>
<p>If the path is present but ctime or mtime differs, the file may have changed.
If the size differs, then the file has certainly changed. At this point, a
future version of the “backup” command might hash the file and look for a
match in an as-yet-defined table, in the hopes that the file has simply been
moved from somewhere else on the disk. This enhancement requires changes to
the Tahoe upload API before it can be significantly more efficient than
simply handing the file to Tahoe and relying upon the normal convergence to
notice the similarity.</p>
<p>If ctime, mtime, or size is different, the client will upload the file, as
above.</p>
<p>If these identifiers are the same, the client will assume that the file is
unchanged (unless the <code class="docutils literal notranslate"><span class="pre">--ignore-timestamps</span></code> option is provided, in which
case the client always re-uploads the file), and it may be allowed to skip
the upload. For safety, however, we require the client periodically perform a
filecheck on these probably-already-uploaded files, and re-upload anything
that doesn’t look healthy. The client looks the fileid up in the
‘last_checked’ table, to see how long it has been since the file was last
checked.</p>
<p>A “random early check” algorithm should be used, in which a check is
performed with a probability that increases with the age of the previous
results. E.g. files that were last checked within a month are not checked,
files that were checked 5 weeks ago are re-checked with 25% probability, 6
weeks with 50%, more than 8 weeks are always checked. This reduces the
“thundering herd” of filechecks-on-everything that would otherwise result
when a backup operation is run one month after the original backup. If a
filecheck reveals the file is not healthy, it is re-uploaded.</p>
<p>If the filecheck shows the file is healthy, or if the filecheck was skipped,
the client gets to skip the upload, and uses the previous filecap (from the
‘caps’ table) to add to the parent directory.</p>
<p>If a new file is uploaded, a new entry is put in the ‘caps’ and ‘last_upload’
table, and an entry is made in the ‘local_files’ table to reflect the mapping
from local disk pathname to uploaded filecap. If an old file is re-uploaded,
the ‘last_upload’ entry is updated with the new timestamps. If an old file is
checked and found healthy, the ‘last_upload’ entry is updated.</p>
<p>Relying upon timestamps is a compromise between efficiency and safety: a file
which is modified without changing the timestamp or size will be treated as
unmodified, and the “<code class="docutils literal notranslate"><span class="pre">tahoe</span> <span class="pre">backup</span></code>” command will not copy the new contents
into the grid. The <code class="docutils literal notranslate"><span class="pre">--no-timestamps</span></code> option can be used to disable this
optimization, forcing every byte of the file to be hashed and encoded.</p>
</div>
<div class="section" id="directory-operations">
<h2>Directory Operations<a class="headerlink" href="#directory-operations" title="Permalink to this headline">¶</a></h2>
<p>Once the contents of a directory are known (a filecap for each file, and a
dircap for each directory), the backup process must find or create a tahoe
directory node with the same contents. The contents are hashed, and the hash
is queried in the ‘directories’ table. If found, the last-checked timestamp
is used to perform the same random-early-check algorithm described for files
above, but no new upload is performed. Since “<code class="docutils literal notranslate"><span class="pre">tahoe</span> <span class="pre">backup</span></code>” creates immutable
directories, it is perfectly safe to re-use a directory from a previous
backup.</p>
<p>If not found, the web-API “mkdir-immutable” operation is used to create a new
directory, and an entry is stored in the table.</p>
<p>The comparison operation ignores timestamps and metadata, and pays attention
solely to the file names and contents.</p>
<p>By using a directory-contents hash, the “<code class="docutils literal notranslate"><span class="pre">tahoe</span> <span class="pre">backup</span></code>” command is able to
re-use directories from other places in the backed up data, or from old
backups. This means that renaming a directory and moving a subdirectory to a
new parent both count as “minor changes” and will result in minimal Tahoe
operations and subsequent network traffic (new directories will be created
for the modified directory and all of its ancestors). It also means that you
can perform a backup (“#1”), delete a file or directory, perform a backup
(“#2”), restore it, and then the next backup (“#3”) will re-use the
directories from backup #1.</p>
<p>The best case is a null backup, in which nothing has changed. This will
result in minimal network bandwidth: one directory read and two modifies. The
<code class="docutils literal notranslate"><span class="pre">Archives/</span></code> directory must be read to locate the latest backup, and must be
modified to add a new snapshot, and the <code class="docutils literal notranslate"><span class="pre">Latest/</span></code> directory will be updated to
point to that same snapshot.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The Tahoe BackupDB</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#schema">Schema</a></li>
<li><a class="reference internal" href="#upload-operation">Upload Operation</a></li>
<li><a class="reference internal" href="#directory-operations">Directory Operations</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="write_coordination.html"
                        title="previous chapter">Avoiding Write Collisions in Tahoe</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="developer-guide.html"
                        title="next chapter">Developer Guide</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/backupdb.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="developer-guide.html" title="Developer Guide"
             >next</a> |</li>
        <li class="right" >
          <a href="write_coordination.html" title="Avoiding Write Collisions in Tahoe"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Tahoe-LAFS 1.x documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, The Tahoe-LAFS Developers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>