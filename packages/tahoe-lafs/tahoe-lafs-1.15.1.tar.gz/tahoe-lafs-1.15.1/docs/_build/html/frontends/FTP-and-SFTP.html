
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Tahoe-LAFS SFTP and FTP Frontends &#8212; Tahoe-LAFS 1.x documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Download status" href="download-status.html" />
    <link rel="prev" title="The Tahoe REST-ful Web API" href="webapi.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="download-status.html" title="Download status"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="webapi.html" title="The Tahoe REST-ful Web API"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Tahoe-LAFS 1.x documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tahoe-lafs-sftp-and-ftp-frontends">
<h1>Tahoe-LAFS SFTP and FTP Frontends<a class="headerlink" href="#tahoe-lafs-sftp-and-ftp-frontends" title="Permalink to this headline">¶</a></h1>
<ol class="arabic simple">
<li><a class="reference internal" href="#sftp-ftp-background">SFTP/FTP Background</a></li>
<li><a class="reference internal" href="#tahoe-lafs-support">Tahoe-LAFS Support</a></li>
<li><a class="reference internal" href="#creating-an-account-file">Creating an Account File</a></li>
<li><a class="reference internal" href="#running-an-account-server-accounts-url">Running An Account Server (accounts.url)</a></li>
<li><a class="reference internal" href="#configuring-sftp-access">Configuring SFTP Access</a></li>
<li><a class="reference internal" href="#configuring-ftp-access">Configuring FTP Access</a></li>
<li><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li><a class="reference internal" href="#immutable-and-mutable-files">Immutable and Mutable Files</a></li>
<li><a class="reference internal" href="#known-issues">Known Issues</a></li>
</ol>
<div class="section" id="sftp-ftp-background">
<h2>SFTP/FTP Background<a class="headerlink" href="#sftp-ftp-background" title="Permalink to this headline">¶</a></h2>
<p>FTP is the venerable internet file-transfer protocol, first developed in
1971. The FTP server usually listens on port 21. A separate connection is
used for the actual data transfers, either in the same direction as the
initial client-to-server connection (for PORT mode), or in the reverse
direction (for PASV) mode. Connections are unencrypted, so passwords, file
names, and file contents are visible to eavesdroppers.</p>
<p>SFTP is the modern replacement, developed as part of the SSH “secure shell”
protocol, and runs as a subchannel of the regular SSH connection. The SSH
server usually listens on port 22. All connections are encrypted.</p>
<p>Both FTP and SFTP were developed assuming a UNIX-like server, with accounts
and passwords, octal file modes (user/group/other, read/write/execute), and
ctime/mtime timestamps.</p>
<p>We recommend SFTP over FTP, because the protocol is better, and the server
implementation in Tahoe-LAFS is more complete. See <a class="reference internal" href="#known-issues">Known Issues</a>, below,
for details.</p>
</div>
<div class="section" id="tahoe-lafs-support">
<h2>Tahoe-LAFS Support<a class="headerlink" href="#tahoe-lafs-support" title="Permalink to this headline">¶</a></h2>
<p>All Tahoe-LAFS client nodes can run a frontend SFTP server, allowing regular
SFTP clients (like <code class="docutils literal notranslate"><span class="pre">/usr/bin/sftp</span></code>, the <code class="docutils literal notranslate"><span class="pre">sshfs</span></code> FUSE plugin, and many
others) to access the file store. They can also run an FTP server, so FTP
clients (like <code class="docutils literal notranslate"><span class="pre">/usr/bin/ftp</span></code>, <code class="docutils literal notranslate"><span class="pre">ncftp</span></code>, and others) can too. These
frontends sit at the same level as the web-API interface.</p>
<p>Since Tahoe-LAFS does not use user accounts or passwords, the SFTP/FTP
servers must be configured with a way to first authenticate a user (confirm
that a prospective client has a legitimate claim to whatever authorities we
might grant a particular user), and second to decide what directory cap
should be used as the root directory for a log-in by the authenticated user.
A username and password can be used; as of Tahoe-LAFS v1.11, RSA or DSA
public key authentication is also supported.</p>
<p>Tahoe-LAFS provides two mechanisms to perform this user-to-cap mapping.
The first (recommended) is a simple flat file with one account per line.
The second is an HTTP-based login mechanism.</p>
</div>
<div class="section" id="creating-an-account-file">
<h2>Creating an Account File<a class="headerlink" href="#creating-an-account-file" title="Permalink to this headline">¶</a></h2>
<p>To use the first form, create a file (for example <code class="docutils literal notranslate"><span class="pre">BASEDIR/private/accounts</span></code>)
in which each non-comment/non-blank line is a space-separated line of
(USERNAME, PASSWORD, ROOTCAP), like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">cat</span> <span class="n">BASEDIR</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">accounts</span>
<span class="c1"># This is a password line: username password cap</span>
<span class="n">alice</span> <span class="n">password</span> <span class="n">URI</span><span class="p">:</span><span class="n">DIR2</span><span class="p">:</span><span class="n">ioej8xmzrwilg772gzj4fhdg7a</span><span class="p">:</span><span class="n">wtiizszzz2rgmczv4wl6bqvbv33ag4kvbr6prz3u6w3geixa6m6a</span>
<span class="n">bob</span> <span class="n">sekrit</span> <span class="n">URI</span><span class="p">:</span><span class="n">DIR2</span><span class="p">:</span><span class="mi">6</span><span class="n">bdmeitystckbl9yqlw7g56f4e</span><span class="p">:</span><span class="n">serp5ioqxnh34mlbmzwvkp3odehsyrr7eytt5f64we3k9hhcrcja</span>

<span class="c1"># This is a public key line: username keytype pubkey cap</span>
<span class="c1"># (Tahoe-LAFS v1.11 or later)</span>
<span class="n">carol</span> <span class="n">ssh</span><span class="o">-</span><span class="n">rsa</span> <span class="n">AAAA</span><span class="o">...</span> <span class="n">URI</span><span class="p">:</span><span class="n">DIR2</span><span class="p">:</span><span class="n">ovjy4yhylqlfoqg2vcze36dhde</span><span class="p">:</span><span class="mi">4</span><span class="n">d4f47qko2xm5g7osgo2yyidi5m4muyo2vjjy53q4vjju2u55mfa</span>
</pre></div>
</div>
<p>For public key authentication, the keytype may be either “ssh-rsa” or “ssh-dsa”.
To avoid ambiguity between passwords and public key types, a password cannot
start with “ssh-“.</p>
<p>Now add an <code class="docutils literal notranslate"><span class="pre">accounts.file</span></code> directive to your <code class="docutils literal notranslate"><span class="pre">tahoe.cfg</span></code> file, as described in
the next sections.</p>
</div>
<div class="section" id="running-an-account-server-accounts-url">
<h2>Running An Account Server (accounts.url)<a class="headerlink" href="#running-an-account-server-accounts-url" title="Permalink to this headline">¶</a></h2>
<p>The accounts.url directive allows access requests to be controlled by an
HTTP-based login service, useful for centralized deployments. This was used
by AllMyData to provide web-based file access, where the service used a
simple PHP script and database lookups to map an account email address and
password to a Tahoe-LAFS directory cap. The service will receive a
multipart/form-data POST, just like one created with a &lt;form&gt; and &lt;input&gt;
fields, with three parameters:</p>
<ul class="simple">
<li>action: “authenticate” (this is a static string)</li>
<li>email: USERNAME (Tahoe-LAFS has no notion of email addresses, but the
authentication service uses them as account names, so the interface
presents this argument as “email” rather than “username”).</li>
<li>passwd: PASSWORD</li>
</ul>
<p>It should return a single string that either contains a Tahoe-LAFS directory
cap (URI:DIR2:…), or “0” to indicate a login failure.</p>
<p>Tahoe-LAFS recommends the service be secure, preferably localhost-only.  This
makes it harder for attackers to brute force the password or use DNS
poisoning to cause the Tahoe-LAFS gateway to talk with the wrong server,
thereby revealing the usernames and passwords.</p>
<p>Public key authentication is not supported when an account server is used.</p>
</div>
<div class="section" id="configuring-sftp-access">
<h2>Configuring SFTP Access<a class="headerlink" href="#configuring-sftp-access" title="Permalink to this headline">¶</a></h2>
<p>The Tahoe-LAFS SFTP server requires a host keypair, just like the regular SSH
server. It is important to give each server a distinct keypair, to prevent
one server from masquerading as different one. The first time a client
program talks to a given server, it will store the host key it receives, and
will complain if a subsequent connection uses a different key. This reduces
the opportunity for man-in-the-middle attacks to just the first connection.</p>
<p>Exercise caution when connecting to the SFTP server remotely. The AES
implementation used by the SFTP code does not have defenses against timing
attacks. The code for encrypting the SFTP connection was not written by the
Tahoe-LAFS team, and we have not reviewed it as carefully as we have reviewed
the code for encrypting files and directories in Tahoe-LAFS itself. (See
<a class="reference external" href="https://twistedmatrix.com/trac/ticket/4633">Twisted ticket #4633</a> for a possible fix to this issue.)</p>
<p>If you can connect to the SFTP server (which is provided by the Tahoe-LAFS
gateway) only from a client on the same host, then you would be safe from any
problem with the SFTP connection security. The examples given below enforce
this policy by including “:interface=127.0.0.1” in the “port” option, which
causes the server to only accept connections from localhost.</p>
<p>You will use directives in the tahoe.cfg file to tell the SFTP code where to
find these keys. To create one, use the <code class="docutils literal notranslate"><span class="pre">ssh-keygen</span></code> tool (which comes with
the standard OpenSSH client distribution):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">cd</span> <span class="n">BASEDIR</span>
<span class="o">%</span> <span class="n">ssh</span><span class="o">-</span><span class="n">keygen</span> <span class="o">-</span><span class="n">f</span> <span class="n">private</span><span class="o">/</span><span class="n">ssh_host_rsa_key</span>
</pre></div>
</div>
<p>The server private key file must not have a passphrase.</p>
<p>Then, to enable the SFTP server with an accounts file, add the following
lines to the BASEDIR/tahoe.cfg file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">sftpd</span><span class="p">]</span>
<span class="n">enabled</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">tcp</span><span class="p">:</span><span class="mi">8022</span><span class="p">:</span><span class="n">interface</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>
<span class="n">host_pubkey_file</span> <span class="o">=</span> <span class="n">private</span><span class="o">/</span><span class="n">ssh_host_rsa_key</span><span class="o">.</span><span class="n">pub</span>
<span class="n">host_privkey_file</span> <span class="o">=</span> <span class="n">private</span><span class="o">/</span><span class="n">ssh_host_rsa_key</span>
<span class="n">accounts</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">private</span><span class="o">/</span><span class="n">accounts</span>
</pre></div>
</div>
<p>The SFTP server will listen on the given port number and on the loopback
interface only. The “accounts.file” pathname will be interpreted relative to
the node’s BASEDIR.</p>
<p>Or, to use an account server instead, do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">sftpd</span><span class="p">]</span>
<span class="n">enabled</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">tcp</span><span class="p">:</span><span class="mi">8022</span><span class="p">:</span><span class="n">interface</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>
<span class="n">host_pubkey_file</span> <span class="o">=</span> <span class="n">private</span><span class="o">/</span><span class="n">ssh_host_rsa_key</span><span class="o">.</span><span class="n">pub</span>
<span class="n">host_privkey_file</span> <span class="o">=</span> <span class="n">private</span><span class="o">/</span><span class="n">ssh_host_rsa_key</span>
<span class="n">accounts</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">login</span>
</pre></div>
</div>
<p>You can provide both accounts.file and accounts.url, although it probably
isn’t very useful except for testing.</p>
<p>For further information on SFTP compatibility and known issues with various
clients and with the sshfs filesystem, see <a class="reference external" href="https://tahoe-lafs.org/trac/tahoe-lafs/wiki/SftpFrontend">wiki:SftpFrontend</a></p>
</div>
<div class="section" id="configuring-ftp-access">
<h2>Configuring FTP Access<a class="headerlink" href="#configuring-ftp-access" title="Permalink to this headline">¶</a></h2>
<p>To enable the FTP server with an accounts file, add the following lines to
the BASEDIR/tahoe.cfg file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ftpd</span><span class="p">]</span>
<span class="n">enabled</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">tcp</span><span class="p">:</span><span class="mi">8021</span><span class="p">:</span><span class="n">interface</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>
<span class="n">accounts</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">private</span><span class="o">/</span><span class="n">accounts</span>
</pre></div>
</div>
<p>The FTP server will listen on the given port number and on the loopback
interface only. The “accounts.file” pathname will be interpreted relative to
the node’s BASEDIR.</p>
<p>To enable the FTP server with an account server instead, provide the URL of
that server in an “accounts.url” directive:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ftpd</span><span class="p">]</span>
<span class="n">enabled</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">tcp</span><span class="p">:</span><span class="mi">8021</span><span class="p">:</span><span class="n">interface</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>
<span class="n">accounts</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">login</span>
</pre></div>
</div>
<p>You can provide both accounts.file and accounts.url, although it probably
isn’t very useful except for testing.</p>
<p>FTP provides no security, and so your password or caps could be eavesdropped
if you connect to the FTP server remotely. The examples above include
“:interface=127.0.0.1” in the “port” option, which causes the server to only
accept connections from localhost.</p>
<p>Public key authentication is not supported for FTP.</p>
</div>
<div class="section" id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h2>
<p>The Tahoe-LAFS SFTP server requires the Twisted “Conch” component (a “conch”
is a twisted shell, get it?). Many Linux distributions package the Conch code
separately: debian puts it in the “python-twisted-conch” package.</p>
</div>
<div class="section" id="immutable-and-mutable-files">
<h2>Immutable and Mutable Files<a class="headerlink" href="#immutable-and-mutable-files" title="Permalink to this headline">¶</a></h2>
<p>All files created via SFTP (and FTP) are immutable files. However, files can
only be created in writeable directories, which allows the directory entry to
be relinked to a different file. Normally, when the path of an immutable file
is opened for writing by SFTP, the directory entry is relinked to another
file with the newly written contents when the file handle is closed. The old
file is still present on the grid, and any other caps to it will remain
valid. (See <a class="reference internal" href="../garbage-collection.html"><span class="doc">Garbage Collection in Tahoe</span></a> for how to reclaim the space used by
files that are no longer needed.)</p>
<p>The ‘no-write’ metadata field of a directory entry can override this
behaviour. If the ‘no-write’ field holds a true value, then a permission
error will occur when trying to write to the file, even if it is in a
writeable directory. This does not prevent the directory entry from being
unlinked or replaced.</p>
<p>When using sshfs, the ‘no-write’ field can be set by clearing the ‘w’ bits in
the Unix permissions, for example using the command <code class="docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">444</span> <span class="pre">path/to/file</span></code>.
Note that this does not mean that arbitrary combinations of Unix permissions
are supported. If the ‘w’ bits are cleared on a link to a mutable file or
directory, that link will become read-only.</p>
<p>If SFTP is used to write to an existing mutable file, it will publish a new
version when the file handle is closed.</p>
</div>
<div class="section" id="known-issues">
<h2>Known Issues<a class="headerlink" href="#known-issues" title="Permalink to this headline">¶</a></h2>
<div class="section" id="known-issues-in-the-sftp-frontend">
<h3>Known Issues in the SFTP Frontend<a class="headerlink" href="#known-issues-in-the-sftp-frontend" title="Permalink to this headline">¶</a></h3>
<p>Upload errors may not be reported when writing files using SFTP via sshfs
(<a class="reference external" href="https://tahoe-lafs.org/trac/tahoe-lafs/ticket/1059">ticket #1059</a>).</p>
<p>Non-ASCII filenames are supported with SFTP only if the client encodes
filenames as UTF-8 (<a class="reference external" href="https://tahoe-lafs.org/trac/tahoe-lafs/ticket/1089">ticket #1089</a>).</p>
<p>See also <a class="reference external" href="https://tahoe-lafs.org/trac/tahoe-lafs/wiki/SftpFrontend">wiki:SftpFrontend</a>.</p>
</div>
<div class="section" id="known-issues-in-the-ftp-frontend">
<h3>Known Issues in the FTP Frontend<a class="headerlink" href="#known-issues-in-the-ftp-frontend" title="Permalink to this headline">¶</a></h3>
<p>Mutable files are not supported by the FTP frontend (<a class="reference external" href="https://tahoe-lafs.org/trac/tahoe-lafs/ticket/680">ticket #680</a>).</p>
<p>Non-ASCII filenames are not supported by FTP (<a class="reference external" href="https://tahoe-lafs.org/trac/tahoe-lafs/ticket/682">ticket #682</a>).</p>
<p>The FTP frontend sometimes fails to report errors, for example if an upload
fails because it does meet the “servers of happiness” threshold (<a class="reference external" href="https://tahoe-lafs.org/trac/tahoe-lafs/ticket/1081">ticket
#1081</a>).</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tahoe-LAFS SFTP and FTP Frontends</a><ul>
<li><a class="reference internal" href="#sftp-ftp-background">SFTP/FTP Background</a></li>
<li><a class="reference internal" href="#tahoe-lafs-support">Tahoe-LAFS Support</a></li>
<li><a class="reference internal" href="#creating-an-account-file">Creating an Account File</a></li>
<li><a class="reference internal" href="#running-an-account-server-accounts-url">Running An Account Server (accounts.url)</a></li>
<li><a class="reference internal" href="#configuring-sftp-access">Configuring SFTP Access</a></li>
<li><a class="reference internal" href="#configuring-ftp-access">Configuring FTP Access</a></li>
<li><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li><a class="reference internal" href="#immutable-and-mutable-files">Immutable and Mutable Files</a></li>
<li><a class="reference internal" href="#known-issues">Known Issues</a><ul>
<li><a class="reference internal" href="#known-issues-in-the-sftp-frontend">Known Issues in the SFTP Frontend</a></li>
<li><a class="reference internal" href="#known-issues-in-the-ftp-frontend">Known Issues in the FTP Frontend</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="webapi.html"
                        title="previous chapter">The Tahoe REST-ful Web API</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="download-status.html"
                        title="next chapter">Download status</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/frontends/FTP-and-SFTP.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="download-status.html" title="Download status"
             >next</a> |</li>
        <li class="right" >
          <a href="webapi.html" title="The Tahoe REST-ful Web API"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Tahoe-LAFS 1.x documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, The Tahoe-LAFS Developers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>