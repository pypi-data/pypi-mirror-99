Algorithm descriptions
======================


Overview
********

SICOR is subdivided into two sequential main algorithms: the retrieval of the three phases of water and the calculation
of the surface reflectance. The latter requires the output from the water retrieval to accurately model the level 2a
spectra. The input requires an EnMAP level 1b product generated by the EnPT EnMAP data reader and an options file in
json format. Via the options file, the user is able to set the path to the atmospheric Look-Up-Table (LUT), decide
whether the algorithm should retrieve vapor, liquid and ice or only vapor and liquid, and set the number of cpu's used
for processing. All other relevant parameters are retrieved from the EnMAP product metadata file during the EnPT
reader process.




Three Phases of Water Retrieval
*******************************

SICOR uses sufficient narrow bands in the NIR to identify and quantify water in different states. The path lengths of
water vapor, liquid water and ice are simultaneously estimated by applying a physically-based inversion of an
atmospheric radiative transfer model (RTM) which is linked to a well-parameterized surface reflectance model. The latter
incorporates the Beer-Lambert law to express the radiation absorption as a function of the path length of pure liquid
water and ice. While water vapor can be inferred from the RTM simulations, the surface reflectance model enables the
retrieval of the other two phases. The approach is based on the decoupling of the overlapping absorption lines of water
vapor, liquid water and ice. The lines of liquid water and ice are shifted towards longer wavelengths. This
displacement, in combination with the moderate absorption energies enables a spectroscopic separation of the three
phases.




Forward Operator (FO)
*********************

Both the retrieval of the three phases of water and the modeling of the surface reflectance are based on the inversion
of a well-parameterized forward model (FO), which models the TOA radiance spectra. The water retrieval uses the FO to
estimate the values of vapor, liquid and ice by minimizing the difference between modeled and measured spectra.
The minimization uses a predefined cost function in an iterative optimization procedure. The modeling of the surface
reflectance applies the FO based on the retrieved combined atmospheric and surface state vector. Besides the path
lengths of the three water phases, the FO additionally requires state vector parameters such as observation geometry,
surface elevation and aerosol optical thickness (AOT). All these additional parameters are obtained from the metadata of
the input EnMAP dataset.




Atmospheric Model
*****************

Assuming clear sky and a plane-parallel atmosphere as well as a Lambertian surface, SICOR models the TOA radiance by a
simplified solution of the radiative transfer equation following the approach of Chandrasekhar (1960). To decrease the
computational burden and to increase the processing speed, the needed atmospheric components were previously calculated
for different atmospheric cases and stored in a multidimensional LUT.




Surface Reflectance Model
*************************

For the three phases of water retrieval, SICOR models the surface reflectance as a linear change in reflectance with
wavelength attenuated by the spectrally dependent absorption for liquid water and ice based on the Beer-Lambert law.
The wavelength dependent absorption coefficients of liquid water and ice are calculated by using the imaginary part of
the complex index of refraction k. To obtain k, SICOR uses the table of Kedenburg et al. (2012) for liquid water and
the values from Warren (1984) for ice.




Inversion
*********

SICOR iteratively adjusts water vapor, liquid water, and ice path lengths to match modeled and measured spectra within
the selected water absorption feature. For EnMAP datasets, the 1140 nm window is applied due to the VNIR and SWIR
detector overlapping around the 940 nm feature. The matching of the spectra is evaluated by a predefined cost function
and at each iteration step, the needed atmospheric parameters are obtained by a multidimensional interpolation within
the LUT. SICOR applies optimal estimation according to Rodgers (2000) to the iteration procedure.




Optimal Estimation
******************

Optimal estimation enables the possibility to incorporate an error vector in terms of measurement, forward model, and
a priori uncertainties.
