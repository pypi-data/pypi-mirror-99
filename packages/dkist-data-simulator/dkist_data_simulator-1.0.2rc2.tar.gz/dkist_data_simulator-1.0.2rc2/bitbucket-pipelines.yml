image: python:3.8.6

definitions:
  steps:
    - step: &test
        caches:
          - pip
        name: Test
        script:
          - pip install -U pip
          - pip install tox codecov
          - tox -e py38-test
          - codecov
    - step: &push
        caches:
          - pip
        name: Push
        script:
          - pip install -U pip
          - pip install twine pep517
          - python -m pep517.build --binary --source --out-dir wheelhouse .
          - python -m twine upload --skip-existing wheelhouse/*

pipelines:
  default:
    - step: *test
  tags:
    'v*':
      - step: *test
      - step: *push
