variables:
    image: "harbor.bigo.sg/mlplat/docker:latest"

stages: 
    - test
    - report
    - deploy

bmlx_test:
    image: harbor.bigo.sg/mlplat/bmlx-build:1.0.0  # test should use xdl version
    stage: test
    script:
        - git submodule update --init --recursive
        - pip install bmlx==2.4.0 # install latest bmlx
        - pip install pytest
        - python setup.py install --user
        - pip install --user -U pytest pytest-cov coverage
        - pytest bmlx_components
    coverage: '/TOTAL.*\s+(\d+%)$/'
    only:
        refs:
        - master
        - develop
        - merge_requests
    artifacts:
        paths:
        - build/coverage_report/
        expire_in: 1 day
    except:
        refs:
        - tags
    tags:
        - k8s
        - sg

pages:
    stage: report
    before_script: 
        - "true"
    script:
        - mkdir -p public/coverage
        - cp -rf build/coverage_report/* public/coverage
    only:
        refs:
        - master
    artifacts:
        paths:
        - public
    except:
        refs:
        - tags
    tags:
        - k8s
        - sg

pypi_deploy:
    stage: deploy
    image: ${image}
    script:
        - git submodule update --init --recursive
        - python setup.py sdist
        - twine upload --verbose --skip-existing dist/*
        - twine upload --verbose --skip-existing --repository-url http://pypi.mlp.bigo.inner/ dist/*
    only:
        - /^(\d+\.)?(\d+\.)?(\*|\d+\.)?(\*|\d+)$/
    tags:
        - k8s
        - sg