image: python:3.8
definitions:
  services:
    redis:
      image: redis
    broker:
      image: rabbitmq:3
      environment:
        RABBITMQ_DEFAULT_USER: guest
        RABBITMQ_DEFAULT_PASS: guest
      ports:
        - 5672:5672
  steps:
    - step: &lint
        caches:
          - pip
        name: Lint
        script:
          - pip install pre-commit
          - pre-commit install
          - pre-commit run --all-files
    - step: &scan
        caches:
          - pip
        name: Scan
        script:
          - pip install .
          - pip install safety
          - safety check --full-report
    - step: &test
        caches:
          - pip
        name: Test
        script:
          - pip install .[test]
          - pytest --cov -m "not development" dkist_processing_common
        services:
          - redis
          - broker
    - step: &push
        caches:
          - pip
        name: Push
        script:
          - python setup.py sdist
          - pip install twine
          - twine upload dist/*

pipelines:
  default:
    - step: *lint
    - step: *test
    - step: *scan
  tags:
    'v*':
      - step: *lint
      - step: *test
      - step: *scan
      - step: *push
