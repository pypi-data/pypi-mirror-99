name: Release Workflow
on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: deploy
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: '3.7'

      - name: Install
        run: python -m pip install pip setuptools sphinx wheel twine importlib-metadata -U

      - name: Build API
        run: make build-api

      - name: Commit API client changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "chore: Update API client" -a || true

      - name: Build
        run: python setup.py sdist bdist_wheel

      - name: Python Semantic Release
        uses: relekang/python-semantic-release@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pypi_token: ${{ secrets.PYPI_TOKEN }}

  docs:
    name: docs
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: '3.7'

      - name: Install Deps
        run: python -m pip install pip setuptools sphinx importlib-metadata -U

      - name: Setup Install
        run: python -m pip install .

      - name: Docs Install
        run: python -m pip install -e ".[docs]"

      - name: Commit documentation changes
        run: |
          python setup.py build_sphinx
          mkdir -p docs
          cp -r doc/_build/html/* docs/
          cd docs
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "chore: Update documentation" -a || true
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          branch: gh-pages
          directory: docs
          force: true
          github_token: ${{ secrets.GITHUB_TOKEN }}


