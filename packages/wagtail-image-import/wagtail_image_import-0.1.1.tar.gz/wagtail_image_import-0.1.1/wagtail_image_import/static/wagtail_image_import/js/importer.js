!function(e){var t={};function n(a){if(t[a])return t[a].exports;var l=t[a]={i:a,l:!1,exports:{}};return e[a].call(l.exports,l,l.exports,n),l.l=!0,l.exports}n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var l in e)n.d(a,l,function(t){return e[t]}.bind(null,l));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t){const n=window.React,a=window.ReactDOM,l=window.wagtail.components.Icon;function r(e){const[t,a]=n.useState([]),[l,r]=n.useState(void 0),[c,s]=n.useState(void 0),[u,p]=n.useState(e.collections[0][0]);return t&&t.length?l?n.createElement(i,{imageImports:t.map(e=>{const t=e.id;return l[t],imageImport={drive_id:t,name:e.name,progress:0,action:l[t]||"keep",thumbnail:e.thumbnailLink,wagtail_id:"replace"==l[t]?c[t].wagtail_id:null}}).filter(e=>!("cancel"==e.action)),csrfToken:e.csrfToken,collection:u,tagitOpts:e.tagitOpts,indexUrl:e.indexUrl}):n.createElement(d,{imageData:t,duplicateReviewUrl:e.duplicateReviewUrl,onConfirmDuplicateActions:r,onGetDuplicateData:s}):n.createElement(n.Fragment,null,n.createElement(m,{appId:e.appId,pickerApiKey:e.pickerApiKey,clientId:e.clientId,scope:"https://www.googleapis.com/auth/documents.readonly https://www.googleapis.com/auth/drive.readonly",onGetImageData:a,driveParent:e.driveParent||"root"}),n.createElement(o,{collections:e.collections,selected:u,onChange:e=>{p(e.target.value)}}))}function o(e){return n.createElement("div",{class:"field nice-padding import-selector"},n.createElement("label",{for:"id_addimage_collection"},"Add to collection:"),n.createElement("div",{class:"field-content"},n.createElement("select",{id:"id_addimage_collection",name:"collection",value:e.selected,onChange:e.onChange},e.collections.map(e=>n.createElement("option",{value:e[0]},e[1])))))}function i(e){const[t,a]=n.useState(!1),[l,r]=n.useState(e.imageImports),o=gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;function i(e,t,n){let a=[...l];a[n][e]=t,r(a)}function s(t,n){a(!0);var l=new XMLHttpRequest;l.addEventListener("load",r=>{i("progress",50,n),function(t,n,l){let r=new FormData;r.append("drive_id",n.drive_id),r.append("wagtail_id",n.wagtail_id),r.append("action",n.action),r.append("name",n.name),r.append("collection",e.collection),r.append("image_file",t);var o=new XMLHttpRequest;o.addEventListener("load",async e=>{let t=await o.response;t=JSON.parse(t),i("imported",!0,l),a(!1),i("error",t.error,l),i("form",t.form,l),i("edit_action",t.edit_action,l),i("delete_action",t.delete_action,l),i("progress",100,l)}),o.addEventListener("error",async e=>{a(!1),i("error","Failed to upload to Wagtail",l)}),o.upload.addEventListener("progress",e=>{e.lengthComputable&&i("progress",Math.round(50+100*e.loaded/(2*e.total)),l)}),o.open("POST",window.location),o.setRequestHeader("X-CSRFToken",e.csrfToken),o.setRequestHeader("X-Requested-With","XMLHttpRequest"),o.send(r)}(new File([l.response],t.name),t,n)}),l.addEventListener("error",()=>{i("progress",0,n),a(!1),i("error","Failed to import from Google",n)}),l.addEventListener("progress",e=>{e.lengthComputable&&i("progress",Math.round(100*e.loaded/(2*e.total)),n)}),l.open("GET","https://www.googleapis.com/drive/v3/files/"+t.drive_id+"?alt=media"),l.responseType="blob",l.setRequestHeader("Authorization","Bearer "+o),l.send()}n.useEffect(()=>{if(!t){const e=l.findIndex(e=>!e.error&&!e.imported),t=l[e];t&&s(t,e)}},[t]);const d=l.reduce((e,t)=>e+t.progress/l.length,0),u=l.map((function(t,a){return t.finished?null:n.createElement(c,{key:t.id,imageImport:t,onFormResponseError:e=>{i("error",e.error,a),i("form",e.form,a),i("edit_action",e.edit_action,a),i("delete_action",e.delete_action,a)},onFormResponseSuccess:e=>{i("finished",!0,a),i("error",e.error,a),i("form",e.form,a),i("edit_action",e.edit_action,a),i("delete_action",e.delete_action,a)},onDeleteResponseLoad:e=>{i("finished",!0,a),i("error",e.error,a),i("form",e.form,a),i("edit_action",e.edit_action,a),i("delete_action",e.delete_action,a)},csrfToken:e.csrfToken,tagitOpts:e.tagitOpts})}));return n.createElement("div",{class:"nice-padding"},n.createElement("h2",null,"Image import"),n.createElement("div",{id:"overall-progress","aria-valuenow":Math.round(d),class:"progress progress-secondary active"},n.createElement("div",{class:"bar",style:{width:d+"%"}},Math.round(d)+"%")),u.filter(e=>null!==e).length>0?n.createElement("ul",{id:"upload-list",class:"upload-list multiple"},u):null,100===d?n.createElement("a",{href:e.indexUrl,class:"button button-return"},"Return to image index"):null)}function c(e){return n.createElement("li",{class:"row upload-uploading"},n.createElement("div",{class:"left col3"},n.createElement("div",{class:"preview"},n.createElement("div",{class:"thumb icon icon-image hasthumb"},n.createElement("img",{src:e.imageImport.thumbnail})),e.imageImport.imported?null:n.createElement("div",{class:"progress active"},n.createElement("div",{class:"bar",style:{width:e.imageImport.progress+"%"}},e.imageImport.progress,"%")))),n.createElement("div",{class:"right col9"},n.createElement("p",null,e.imageImport.name),n.createElement("p",{class:e.imageImport.error?"status-msg failure":"status-msg success"},e.imageImport.error||!e.imageImport.imported?e.imageImport.error:"Image successfully imported. Please update this image with a more appropriate title, if necessary. You may also delete the image completely if the import wasn't required."),e.imageImport.form?n.createElement(s,{imageImport:e.imageImport,onFormResponseError:e.onFormResponseError,onFormResponseSuccess:e.onFormResponseSuccess,onDeleteResponseLoad:e.onDeleteResponseLoad,csrfToken:e.csrfToken,tagitOpts:e.tagitOpts}):null))}function s(e){const t=n.useRef(null);return n.useLayoutEffect(()=>{if(t.current){const n=$(".tag_field input",t.current);if(n)return n.tagit(e.tagitOpts),()=>{n.tagit("destroy")}}},[e.imageImport.form]),n.createElement("form",{method:"POST",enctype:"multipart/form-data",novalidate:!0,ref:t,onSubmit:function(t){t.preventDefault();var n=new XMLHttpRequest;n.addEventListener("load",async t=>{t.preventDefault(),res=await n.response,res=JSON.parse(res),res.error?e.onFormResponseError(res):e.onFormResponseSuccess(res)}),n.open("POST",e.imageImport.edit_action),n.setRequestHeader("X-CSRFToken",e.csrfToken),n.setRequestHeader("X-Requested-With","XMLHttpRequest"),n.send(new FormData(t.target))}},n.createElement("ul",{class:"fields",dangerouslySetInnerHTML:{__html:e.imageImport.form}}),n.createElement("ul",{class:"fields"},n.createElement("li",null,n.createElement("input",{type:"hidden",name:"drive_id",value:e.imageImport.driveId}),n.createElement("input",{type:"submit",value:"Update",class:"button"}),n.createElement("button",{type:"button",class:"delete button button-secondary no",onClick:function(t){t.preventDefault();var n=new XMLHttpRequest;n.addEventListener("load",async t=>{t.preventDefault(),res=await n.response,res=JSON.parse(res),e.onDeleteResponseLoad(res)}),n.open("POST",e.imageImport.delete_action),n.setRequestHeader("X-CSRFToken",e.csrfToken),n.setRequestHeader("X-Requested-With","XMLHttpRequest"),n.send()}},"Delete"))))}function d(e){const[t,a]=n.useState({}),[l,r]=n.useState({});if(n.useEffect(()=>{const t=JSON.stringify(e.imageData);fetch(e.duplicateReviewUrl,{method:"post",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:t}).then(t=>{t.ok?t.json().then(t=>{a(t),e.onGetDuplicateData(t);let n=Object.keys(t),l={};for(let e=0;e<n.length;e++)l[n[e]]="replace";r(l),0==n.length&&e.onConfirmDuplicateActions({})}):console.error(t)}).catch(e=>{console.error(e)})},[e.selectedImageData]),t&&Object.keys(t).length>0){let a=!0;getGlobalAction=()=>a?l[Object.keys(l)[0]]:null,setGlobalAction=e=>{let t={};const n=Object.keys(l);for(let a=0;a<n.length;a++)t[n[a]]=e;r(t)};let o=[],i=null,c=null;const s=e.imageData.entries();for(const[e,d]of s){const e=d.id;if(e in t){c=l[e],a&&null!==i&&c!=i&&(a=!1);const s=t[e],m=d;o.push(n.createElement("tr",null,n.createElement("td",null,n.createElement(p,{driveDuplicate:m,wagtailDuplicate:s})),n.createElement(u,{action:c,onClick:t=>{let n={...l};n[e]=t.target.value,r(n)}}))),i=c}}return n.createElement(n.Fragment,null,n.createElement("div",{class:"nice-padding"},n.createElement("h2",{class:"icon icon-warning"},"Duplicates detected"),n.createElement("p",null,"Wagtail has detected images similar to the ones you have just chosen to upload"),n.createElement("p",null,"Please choose how you would like to proceed"),n.createElement("p",null,n.createElement("b",null,Object.keys(t).length," duplicates detected")),n.createElement("table",{class:"listing"},n.createElement("thead",null,n.createElement("tr",{class:"table-headers"},n.createElement("th",null),n.createElement("th",null,"Replace original image"),n.createElement("th",null,"Keep both images"),n.createElement("th",null,"Cancel upload"))),n.createElement("tbody",null,n.createElement("tr",null,n.createElement("td",null),n.createElement(u,{action:getGlobalAction(),onClick:e=>{setGlobalAction(e.target.value)}})),o))),n.createElement("footer",null,n.createElement("ul",null,n.createElement("li",{class:"actions"},n.createElement("button",{type:"submit",class:"button",onClick:()=>e.onConfirmDuplicateActions(l)},"Confirm all")))))}return n.createElement("div",{class:"nice-padding"},n.createElement(g,{message:"Identifying duplicates"}))}function u(e){return n.createElement(n.Fragment,null,n.createElement("td",null,n.createElement("input",{type:"radio",value:"replace",checked:"replace"==e.action,onClick:e.onClick})),n.createElement("td",null,n.createElement("input",{type:"radio",value:"keep",checked:"keep"==e.action,onClick:e.onClick})),n.createElement("td",null,n.createElement("input",{type:"radio",value:"cancel",checked:"cancel"==e.action,onClick:e.onClick})))}function p(e){return n.createElement("table",{class:"image-comparison"},n.createElement("thead",null,n.createElement("tr",{class:"image-headings"},n.createElement("th",null,"Original"),n.createElement("th",null,"New"))),n.createElement("tbody",null,n.createElement("tr",null,n.createElement("td",null,n.createElement("img",{src:e.wagtailDuplicate.thumbnail,width:"165",height:"165"})),n.createElement("td",null,n.createElement("img",{src:e.driveDuplicate.thumbnailLink,width:"165",height:"165"}))),n.createElement("tr",null,n.createElement("td",null,n.createElement("p",null,n.createElement("b",null,e.wagtailDuplicate.title))),n.createElement("td",null,n.createElement("p",null,n.createElement("b",null,e.driveDuplicate.name)))),n.createElement("tr",null,n.createElement("td",null,n.createElement("p",null,"Created at ",e.wagtailDuplicate.created_at)),n.createElement("td",null))))}function m(e){const[t,a]=n.useState(!1);function l(e,t,n){return e.type==google.picker.Type.PHOTO}function r(e,t,n){return e.type==google.picker.Type.jG}async function o(t){if(t.action==google.picker.Action.PICKED){const n=t.docs.filter(l),a=t.docs.filter(r);let o=new Array;if(a&&a.length){const e=`(mimeType contains 'image/') and (${a.reduce((e,t)=>e+`('${t.id}' in parents) or `,"").slice(0,-4)})`;let t=await gapi.client.drive.files.list({q:e,pageSize:1e3,fields:"nextPageToken, files(id, name, thumbnailLink, fileExtension, md5Checksum, size, imageMediaMetadata)"});o.push(...t.result.files)}if(n&&n.length)for(let e=0;e<n.length;e++){let t=await gapi.client.drive.files.get({fileId:n[e].id,fields:"id, name, thumbnailLink, fileExtension, md5Checksum, size, imageMediaMetadata"});o.push(t.result)}e.onGetImageData(o)}}return n.useEffect(()=>{gapi.load("client:auth2:picker",()=>{gapi.client.init({apiKey:e.pickerApiKey,clientId:e.clientId,discoveryDocs:["https://docs.googleapis.com/$discovery/rest?version=v1","https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],scope:e.scope}).then(()=>{a(!0)}).catch(e=>{console.error(e)})})},[]),t?n.createElement("div",{class:"nice-padding import-selector"},n.createElement("button",{class:"button bicolor icon icon-plus",onClick:function(){(function(){const t=gapi.auth2.getAuthInstance();return t.isSignedIn.get()?Promise.resolve(t.currentUser.get().getAuthResponse()):t.signIn({scope:e.scope}).then(e=>e.getAuthResponse())})().then(t=>function(t,n){let a=new google.picker.DocsView(google.picker.ViewId.DOCS_IMAGES);a.setSelectFolderEnabled(!0),a.setIncludeFolders(!0),a.setParent(e.driveParent),(new google.picker.PickerBuilder).setAppId(e.appId).enableFeature(google.picker.Feature.MULTISELECT_ENABLED).setDeveloperKey(e.pickerApiKey).setOAuthToken(t).addView(a).setCallback(n).build().setVisible(!0)}(t.access_token,o))}},"Select an image or folder in Drive")):n.createElement("div",{class:"nice-padding import-selector"},n.createElement(g,{message:"Loading Google API"}))}const g=e=>n.createElement("span",null,n.createElement(l,{name:"spinner",className:"c-spinner"}),e.message),f=document.querySelector("#importer");a.render(n.createElement(r,{appId:f.dataset.appId,pickerApiKey:f.dataset.pickerApiKey,clientId:f.dataset.clientId,duplicateReviewUrl:f.dataset.duplicateReviewUrl,csrfToken:document.querySelector("[name=csrfmiddlewaretoken]").value,collections:JSON.parse(f.dataset.collections),tagitOpts:{autocomplete:{source:f.dataset.autocompleteUrl}},driveParent:f.dataset.driveParent,indexUrl:f.dataset.indexUrl}),f)}]);