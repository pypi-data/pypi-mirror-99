{"version":3,"sources":["script-editor.js","index.js"],"names":["Messages","window","settings","names","infos","controller","optionLists","showSuccessAndError","data","error","enqueue","text","_","isString","gettext","tags","success","apiRequest","command","options","request","extend","req","m","method","url","apiUrl","config","xhr","setRequestHeader","ShuupAdminConfig","csrf","then","response","Controller","ctrl","steps","prop","currentItem","newStepItemModalInfo","removeStepItem","step","itemType","item","listName","reject","i","activateStepItem","addStepItem","identifier","activateForEdit","push","setStepItemEditorState","state","document","getElementById","style","display","src","frm","createElement","target","action","itemEditorUrl","appendChild","name","type","value","JSON","stringify","eventIdentifier","body","submit","receiveItemEditData","startComputation","endComputation","alert","saveState","deleteStep","s","addNewStep","actions","conditions","enabled","next","condOp","moveStep","delta","oldIndex","indexOf","newIndex","splice","promptForNewStepItem","title","closeNewStepItemModal","createNewStepItemFromModal","info","workflowItemList","nameMap","items","list","map","tag","current","href","onclick","partial","confirm","stepTableRows","index","condOpSelect","cond_op","onchange","withAttr","condOps","stepNextSelect","stepNexts","className","key","id","length","renderNewStepItemModal","modalInfo","sortBy","values","description","view","modal","generateItemOptions","o","children","toLowerCase","itemInfosToNameMap","itemInfos","Object","assign","keys","init","iSettings","condition","conditionInfos","actionInfos","mount","addEventListener","event","new_data","save","ScriptEditor","hideEditModal"],"mappings":"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","file":"script-editor.js","sourceRoot":"../../../static_src","sourcesContent":["/**\n * This file is part of Shuup.\n *\n * Copyright (c) 2012-2021, Shoop Commerce Ltd. All rights reserved.\n *\n * This source code is licensed under the OSL-3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n// IMPORTANT: This script assumes that lodash and mithriljs@0.2.0\n// are available in global scope, installed from Shuup Admin static source\nconst Messages = window.Messages;\n\nvar settings = {};\nconst names = {};\nconst infos = {};\nvar controller = null;\nconst optionLists = {};\n\nfunction showSuccessAndError(data) {\n    if (data.error) {\n        Messages.enqueue({\n            text: _.isString(data.error) ? data.error : gettext(\"Error!\"),\n            tags: \"error\"\n        });\n    }\n    if (data.success) {\n        Messages.enqueue({\n            text: _.isString(data.success) ? data.success : gettext(\"Success!\"),\n            tags: \"success\"\n        });\n    }\n}\n\nfunction apiRequest(command, data, options) {\n    const request = _.extend({}, {\"command\": command}, data || {});\n    const req = m.request(_.extend({\n        method: \"POST\",\n        url: settings.apiUrl,\n        data: request,\n        config: function(xhr) {\n            xhr.setRequestHeader(\"X-CSRFToken\", window.ShuupAdminConfig.csrf);\n        }\n    }, options));\n    req.then(function(response) {\n        showSuccessAndError(response);\n    }, function() {\n        Messages.enqueue({text: gettext(\"Error! An unspecified error occurred.\"), tags: \"error\"});\n    });\n    return req;\n}\n\nfunction Controller() {\n    const ctrl = this;\n    ctrl.steps = m.prop([]);\n    ctrl.currentItem = m.prop(null);\n    ctrl.newStepItemModalInfo = m.prop(null);\n\n    apiRequest(\"getData\").then(function(data) {\n        ctrl.steps(data.steps);\n    });\n\n    ctrl.removeStepItem = function(step, itemType, item) {\n        const listName = itemType + \"s\";\n        step[listName] = _.reject(step[listName], function(i) {\n            return i === item;\n        });\n        if (ctrl.currentItem() === item) {\n            ctrl.activateStepItem(null, null, null);\n        }\n    };\n\n    ctrl.addStepItem = function(step, itemType, identifier, activateForEdit) {\n        const item = {\"identifier\": identifier};\n        const listName = itemType + \"s\";\n        step[listName].push(item);\n        if (activateForEdit) {\n            ctrl.activateStepItem(step, itemType, item);\n        }\n    };\n    ctrl.setStepItemEditorState = function(state) {\n        if (state) {\n            document.getElementById(\"step-item-wrapper\").style.display = \"flex\";\n        } else {\n            document.getElementById(\"step-item-wrapper\").style.display = \"none\";\n            document.getElementById(\"step-item-frame\").src = \"about:blank\";\n        }\n    };\n    ctrl.activateStepItem = function(step, itemType, item) {\n        if (step && item) {\n            ctrl.currentItem(item);\n            const frm = _.extend(document.createElement(\"form\"), {\n                target: \"step-item-frame\",\n                method: \"POST\",\n                action: settings.itemEditorUrl\n            });\n            frm.appendChild(_.extend(document.createElement(\"input\"), {\n                name: \"init_data\",\n                type: \"hidden\",\n                value: JSON.stringify({\n                    eventIdentifier: settings.eventIdentifier,\n                    itemType: itemType,\n                    data: item\n                })\n            }));\n            document.body.appendChild(frm);\n            frm.submit();\n            ctrl.setStepItemEditorState(true);\n        } else {\n            ctrl.currentItem(null);\n            ctrl.setStepItemEditorState(false);\n        }\n    };\n    ctrl.receiveItemEditData = function(data) {\n        const currentItem = ctrl.currentItem();\n        if (!currentItem) {\n            alert(gettext(\"Warning! Unexpected edit data was received.\"));\n            return;\n        }\n        m.startComputation();\n        ctrl.currentItem(_.extend(currentItem, data));\n        m.endComputation();\n    };\n    ctrl.saveState = function() {\n        apiRequest(\"saveData\", {\n            steps: ctrl.steps()\n        });\n\n        // TODO: Handle errors here?\n    };\n    ctrl.deleteStep = function(step) {\n        ctrl.steps(_.reject(ctrl.steps(), function(s) {\n            return s === step;\n        }));\n    };\n    ctrl.addNewStep = function() {\n        const step = {\n            actions: [],\n            conditions: [],\n            enabled: true,\n            next: \"continue\",\n            condOp: \"and\"\n        };\n        const steps = ctrl.steps();\n        steps.push(step);\n        ctrl.steps(steps);\n    };\n    ctrl.moveStep = function(step, delta) {\n        const steps = ctrl.steps();\n        const oldIndex = _.indexOf(steps, step);\n        if (oldIndex === -1) {\n            return false;\n        }\n        const newIndex = oldIndex + delta;\n        steps.splice(newIndex, 0, steps.splice(oldIndex, 1)[0]);\n        ctrl.steps(steps);\n    };\n    ctrl.promptForNewStepItem = function(step, itemType) {\n        ctrl.newStepItemModalInfo({\n            step: step,\n            itemType: itemType,\n            title: gettext(\"Add new\") + \" \" + itemType\n        });\n    };\n    ctrl.closeNewStepItemModal = function() {\n        ctrl.newStepItemModalInfo(null);\n    };\n    ctrl.createNewStepItemFromModal = function(identifier) {\n        const info = ctrl.newStepItemModalInfo();\n        ctrl.closeNewStepItemModal();\n        if (info === null) {\n            return;\n        }\n        ctrl.addStepItem(info.step, info.itemType, identifier, true);\n    };\n}\n\nfunction workflowItemList(ctrl, step, itemType) {\n    const listName = itemType + \"s\";\n    const nameMap = names[itemType];\n    const items = step[listName];\n    const list = m(\"ul.action-list\", items.map(function(item) {\n        const name = nameMap[item.identifier] || item.identifier;\n        var tag = \"li\";\n        const current = (ctrl.currentItem() === item);\n        if (current) {\n            tag += \".current\";\n        }\n        return m(tag,\n            [\n                m(\"a\", {\n                    href: \"#\",\n                    onclick: (!current ? _.partial(ctrl.activateStepItem, step, itemType, item) : null)\n                }, name),\n                \" \",\n                m(\"a.delete\", {\n                    href: \"#\", onclick: function() {\n                        if (!confirm(gettext(\"Delete this item?\\nThis is final and can't be undone.\"))) {\n                            return;\n                        }\n                        ctrl.removeStepItem(step, itemType, item);\n                    }\n                }, m(\"i.fa.fa-trash\"))\n            ]\n        );\n    }));\n    return m(\"div\", [\n        list,\n        m(\"div.action-new\", [m(\"a.btn.btn-xs.btn-primary\", {\n            href: \"#\",\n            onclick: _.partial(ctrl.promptForNewStepItem, step, itemType)\n        }, m(\"i.fa.fa-plus\"), \" \" + gettext(\"New\") + \" \" + itemType)])\n    ]);\n}\n\nfunction stepTableRows(ctrl) {\n    return _.map(ctrl.steps(), function(step, index) {\n        const condOpSelect = m(\"select\", {\n            value: step.cond_op,\n            onchange: m.withAttr(\"value\", function(value) {\n                step.cond_op = value;  // eslint-disable-line camelcase\n            })\n        }, optionLists.condOps);\n        const stepNextSelect = m(\"select\", {\n            value: step.next,\n            onchange: m.withAttr(\"value\", function(value) {\n                step.next = value;\n            })\n        }, optionLists.stepNexts);\n\n        return m(\"div\", {\n            className: \"step\" + (step.enabled ? \"\" : \" disabled\"),\n            key: step.id\n        }, [\n            m(\"div.step-buttons\", [\n                (index > 0 ? m(\"a\", {\n                    href: \"#\",\n                    title: gettext(\"Move Up\"),\n                    onclick: _.partial(ctrl.moveStep, step, -1)\n                }, m(\"i.fa.fa-caret-up\")) : null),\n                (index < ctrl.steps().length - 1 ? m(\"a\", {\n                    href: \"#\",\n                    title: gettext(\"Move Down\"),\n                    onclick: _.partial(ctrl.moveStep, step, +1)\n                }, m(\"i.fa.fa-caret-down\")) : null),\n                (step.enabled ?\n                    m(\"a\", {\n                        href: \"#\", title: gettext(\"Disable\"), onclick: function() {\n                            step.enabled = false;\n                        }\n                    }, m(\"i.fa.fa-ban\")) :\n                    m(\"a\", {\n                        href: \"#\", title: gettext(\"Enable\"), onclick: function() {\n                            step.enabled = true;\n                        }\n                    }, m(\"i.fa.fa-check-circle\"))\n                ),\n                m(\"a\", {\n                    href: \"#\", title: gettext(\"Delete\"), onclick: function() {\n                        if (confirm(gettext(\"Are you sure you want to delete this step?\"))) {\n                            ctrl.deleteStep(step);\n                        }\n                    }\n                }, m(\"i.fa.fa-trash\"))\n            ]),\n            m(\"div.step-conds\", [\n                m(\"span.hint\", gettext(\"If\"), condOpSelect, gettext(\"of these conditions hold...\")),\n                workflowItemList(ctrl, step, \"condition\")\n            ]),\n            m(\"div.step-actions\", [\n                m(\"span.hint\", gettext(\"then execute these actions...\")),\n                workflowItemList(ctrl, step, \"action\")\n            ]),\n            m(\"div.step-next\", [\n                m(\"span.hint\", gettext(\"and then...\")),\n                stepNextSelect\n            ])\n        ]);\n    });\n}\n\nfunction renderNewStepItemModal(ctrl, modalInfo) {\n    return m(\"div.new-step-item-modal-overlay\", {onclick: ctrl.closeNewStepItemModal}, [\n        m(\"div.new-step-item-modal\", [\n            m(\"div.title\", modalInfo.title),\n            m(\"div.item-options\", _.map(_.sortBy(_.values(infos[modalInfo.itemType]), \"name\"), function(item) {\n                return m(\"div.item-option\", {onclick: _.partial(ctrl.createNewStepItemFromModal, item.identifier)}, [\n                    m(\"div.item-name\", item.name),\n                    (item.description ? m(\"div.item-description\", item.description) : null)\n                ]);\n            }))\n        ])\n    ]);\n}\n\nfunction view(ctrl) {\n    var modal = null, modalInfo = null;\n    if ((modalInfo = ctrl.newStepItemModalInfo()) !== null) {\n        modal = renderNewStepItemModal(ctrl, modalInfo);\n    }\n    return m(\"div.step-list-wrapper\", [\n        m(\"div.steps\", [\n            stepTableRows(ctrl),\n            m(\"hr.script-separator\"),\n            m(\n                \"a.new-step-link.btn.btn-info.btn-sm\",\n                {href: \"#\", onclick: ctrl.addNewStep},\n                m(\"i.fa.fa-plus\"), \" \" + gettext(\"New step\")\n            )\n        ]),\n        modal\n    ]);\n}\n\nfunction generateItemOptions(nameMap) {\n    return _.sortBy(_.map(nameMap, function(name, value) {\n        return m(\"option\", {value: value}, name);\n    }), function(o) {\n        return o.children[0].toLowerCase();\n    });\n}\n\nfunction itemInfosToNameMap(itemInfos) {\n    return Object.assign({},\n        ...Object.keys(itemInfos).map((key) => ({\n            [itemInfos[key].identifier]: itemInfos[key].name\n        }))\n    );\n}\n\nfunction init(iSettings) {\n    settings = _.extend({}, iSettings);\n    infos.condition = settings.conditionInfos;\n    infos.action = settings.actionInfos;\n    names.condition = itemInfosToNameMap(infos.condition);\n    names.action = itemInfosToNameMap(infos.action);\n\n    optionLists.condOps = generateItemOptions(settings.condOps);\n    optionLists.stepNexts = generateItemOptions(settings.stepNexts);\n\n    controller = m.mount(document.getElementById(\"step-table-container\"), {\n        controller: Controller,\n        view: view\n    });\n    window.addEventListener(\"message\", function(event) {\n        if (event.data.new_data) {\n            controller.receiveItemEditData(event.data.new_data);\n        }\n    }, false);\n}\n\nfunction save() {\n    controller.saveState();\n}\n\nwindow.ScriptEditor = {\n    init,\n    save,\n    hideEditModal() {\n        if (controller) {\n            m.startComputation();\n            controller.setStepItemEditorState(false);\n            controller.activateStepItem(null);  // Deactivate the modal once data is received\n            m.endComputation();\n        }\n    }\n};\n","/**\n * This file is part of Shuup.\n *\n * Copyright (c) 2012-2021, Shoop Commerce Ltd. All rights reserved.\n *\n * This source code is licensed under the OSL-3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n // styles\nimport \"./script-editor.less\";\n\n// scripts\nimport \"./script-editor.js\";\n"]}