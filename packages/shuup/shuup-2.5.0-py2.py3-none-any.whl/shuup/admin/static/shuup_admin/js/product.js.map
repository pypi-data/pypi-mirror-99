{"version":3,"sources":["../base/js/dropzone.js","edit_media.js"],"names":["activateDropzone","$dropzone","attrs","length","selector","attr","$data","$","data","uploadPath","upload_path","addRemoveLinks","add_remove_links","uploadUrl","upload_url","window","ShuupAdminConfig","browserUrls","media","upload","browsable","extraAttrs","Object","keys","filter","startsWith","forEach","attrKey","replace","params","assign","url","csrfmiddlewaretoken","csrf","dictRemoveFile","gettext","autoProcessQueue","uploadMultiple","parallelUploads","maxFiles","dictDefaultMessage","clickable","accept","file","done","kind","type","indexOf","dropzone","Dropzone","on","onAddedFile","files","removeFile","onRemovedFile","find","val","onSuccess","xhr","JSON","parse","responseText","id","onError","errorMessage","response","error","Messages","enqueue","tags","text","onQueueComplete","noop","BrowseAPI","openBrowseWindow","disabledMenus","onSelect","obj","name","remove","emit","thumbnail","fileInput","document","createElement","body","appendChild","prop","css","evt","target","addFile","trigger","push","console","activateDropzones","each","idx","object","includes","module","exports","getFileIds","$fileInputs","fileIds","i","fileId","parseInt","isNaN","onDropzoneQueueComplete","location","pathname","productId","product_id","getFileCount","ajax","add_media","method","file_ids","traditional","success","added","addedMedia","filePanel","product_media","message","alert","onDropzoneSuccess","$section","addMediaPanel","section","maxPanelId","map","v","el","toArray","value","panelCount","Math","max","$source","html","$html","targetId","$contents","$name","append","prepend","insertBefore","e","preventDefault","confirm","parents","fadeOut","next","$panel","current","split","$imagePanels","removeClass","addClass","replaceWith","field","targetPath","queueComplete","zoneData","fieldId","count"],"mappings":";AAQA,SAASA,EAAiBC,GAAWC,IAAAA,EAAM,UAAA,OAAA,QAAA,IAAA,UAAA,GAAA,UAAA,GAAA,GACpC,GAACD,EAAUE,OAAX,CAKGC,IAAAA,EAAW,IAAMH,EAAUI,KAAK,MAChCC,EAAQC,EAAEH,GAAUI,OACpBC,EAAaH,EAAMI,aAAeR,EAAMO,WACxCE,EAAiBL,EAAMM,iBACvBC,EACFP,EAAMQ,YACNC,OAAOC,iBAAiBC,YAAYC,OACpCH,OAAOC,iBAAiBC,YAAYE,OAElCC,EAAaL,OAAOC,iBAAiBC,YAAxB,OAAgDX,EAAMc,WAAiC,UAApBd,EAAMc,UAItFC,EAAa,GACnBC,OAAOC,KAAKjB,GAAOkB,OAAO,SAAAnB,GAAQA,OAAAA,EAAKoB,WAAW,SAAQC,QAAQ,SAACrB,GACzDsB,IAAAA,EAAUtB,EAAKuB,QAAQ,MAAO,IACpCP,EAAWM,GAAWrB,EAAMD,KAG1BwB,IAAAA,EAASP,OAAOQ,OAAO,CACzBC,IAAKlB,EAAY,uBAAyBJ,EAC1CI,UAAAA,EACAgB,OAAQ,CACJG,oBAAqBjB,OAAOC,iBAAiBiB,MAEjDtB,eAAoC,SAAnBA,EACjBuB,eAAgBC,QAAQ,SACxBC,kBAAkB,EAClBC,gBAAgB,EAChBC,gBAAiB,EACjBC,SAAU,EACVC,mBAAoBL,QAAQ,uCAC5BM,WAAW,EACXC,OAAQ,SAASC,EAAMC,GACA,WAAftC,EAAMuC,MAAqBF,EAAKG,KAAKC,QAAQ,SAAW,EACxDH,EAAKT,QAAQ,iCAEbS,MAGTvB,EAAYnB,GACT8C,EAAW,IAAIC,SAAS7C,EAAUyB,GAExCmB,EAASE,GAAG,YAAahD,EAAMiD,aAAe,SAASR,GAC5B,IAApBd,EAAOU,UAAkBS,EAASI,MAAMjD,OAAS,GAChD6C,EAASK,WAAWL,EAASI,MAAM,MAI3CJ,EAASE,GAAG,cAAehD,EAAMoD,eAAiB,SAAS9C,GACvDD,EAAEH,GAAUmD,KAAK,SAASC,IAAI,MAGlCR,EAASE,GAAG,UAAWhD,EAAMuD,WAAa,SAASjD,GAE5CA,EAAKkD,MACJlD,EAAOmD,KAAKC,MAAMpD,EAAKkD,IAAIG,cAAclB,MAE7CpC,EAAEH,GAAUmD,KAAK,SAASC,IAAIhD,EAAKsD,MAGvCd,EAASE,GAAG,QAAShD,EAAM6D,SAAU,SAASvD,GACtCwD,IAAAA,EAAe7B,QAAQ,wCACxB3B,EAAKkD,MACJO,SAAWN,KAAKC,MAAMpD,EAAKkD,IAAIG,cAC3BI,SAASC,OAASD,SAASC,MAAMvB,OACjCqB,EAAeL,KAAKC,MAAMpD,EAAKkD,IAAIG,cAAcK,MAAMvB,OAI/D5B,OAAOoD,SAASC,QAAQ,CAAEC,KAAM,QAASC,KAAMN,IAC/ChB,EAASK,WAAW7C,KAGxBwC,EAASE,GAAG,gBAAiBhD,EAAMqE,iBAAmBhE,EAAEiE,MAExDjE,EAAEH,GAAU8C,GAAG,QAAS,WAChB9B,GAAAA,EACAL,OAAO0D,UAAUC,iBAAiB,CAC9B7B,KAAM,QACN8B,cAAe,CAAC,SAAU,UAC1BnD,OAAQjB,EAAEH,GAAUI,OAAOqC,KAC3B+B,SAAU,SAACC,GACPA,EAAIC,KAAOD,EAAIP,KACf/D,EAAEH,GAAUmD,KAAK,SAASC,IAAIqB,EAAIf,IAClCvD,EAAEH,GAAUmD,KAAK,eAAewB,SAChC/B,EAASgC,KAAK,YAAaH,GACxBA,EAAII,WACHjC,EAASgC,KAAK,YAAaH,EAAKA,EAAII,WAExCjC,EAASgC,KAAK,UAAWH,GACzB7B,EAASgC,KAAK,WAAYH,UAG/B,CACGK,IAAAA,EAAYC,SAASC,cAAc,SACzCD,SAASE,KAAKC,YAAYJ,GAC1B3E,EAAE2E,GAAWK,KAAK,OAAQ,QAAQC,IAAI,UAAW,QAAQtC,GAAG,SAAU,SAACuC,GAC7D9C,IAAAA,EAAO8C,EAAIC,OAAOtC,MAAM,GAC9BJ,EAAS2C,QAAQhD,GACjBuC,EAAUH,WACXa,QAAQ,YAIbpF,IAAAA,EAAOD,EAAEH,GAAUI,OACtBA,EAAKuB,MACJiB,EAASI,MAAMyC,KAAKrF,GACpBwC,EAASgC,KAAK,YAAaxE,GACxBA,EAAKyE,WACJjC,EAASgC,KAAK,YAAaxE,EAAMA,EAAKyE,WAE1CjC,EAASgC,KAAK,WAAYxE,SApH1BsF,QAAQ5B,MAAM,yDAA0DjE,GAwHhFc,OAAOgF,kBAAoB,WACvBxF,EAAE,6BAA6ByF,KAAK,SAASC,EAAKC,GACxClD,IAAAA,EAAWzC,EAAE2F,GACflD,EAAS3C,KAAK,MAAM8F,SAAS,eAAyD,IAAxCnD,EAASO,KAAK,eAAepD,QAC3EH,EAAiBgD,MAI7BjC,OAAOf,iBAAmBA,EAE1BO,EAAE,WACEQ,OAAOgF,sBAGXK,OAAOC,QAAU,CAAErG,iBAAAA;;ACrInB,aAFA,IAAA,EAAA,QAAA,uBAEA,SAAA,EAAA,GAAA,OAAA,EAAA,IAAA,EAAA,IAAA,EAAA,IAAA,IAAA,SAAA,IAAA,MAAA,IAAA,UAAA,wIAAA,SAAA,EAAA,GAAA,GAAA,oBAAA,QAAA,OAAA,YAAA,OAAA,GAAA,OAAA,MAAA,KAAA,GAAA,SAAA,EAAA,GAAA,GAAA,MAAA,QAAA,GAAA,OAAA,EAAA,GAAA,SAAA,EAAA,EAAA,GAAA,OAAA,EAAA,IAAA,EAAA,EAAA,IAAA,EAAA,EAAA,IAAA,IAAA,SAAA,IAAA,MAAA,IAAA,UAAA,6IAAA,SAAA,EAAA,EAAA,GAAA,GAAA,EAAA,CAAA,GAAA,iBAAA,EAAA,OAAA,EAAA,EAAA,GAAA,IAAA,EAAA,OAAA,UAAA,SAAA,KAAA,GAAA,MAAA,GAAA,GAAA,MAAA,WAAA,GAAA,EAAA,cAAA,EAAA,EAAA,YAAA,MAAA,QAAA,GAAA,QAAA,EAAA,MAAA,KAAA,GAAA,cAAA,GAAA,2CAAA,KAAA,GAAA,EAAA,EAAA,QAAA,GAAA,SAAA,EAAA,EAAA,IAAA,MAAA,GAAA,EAAA,EAAA,UAAA,EAAA,EAAA,QAAA,IAAA,IAAA,EAAA,EAAA,EAAA,IAAA,MAAA,GAAA,EAAA,EAAA,IAAA,EAAA,GAAA,EAAA,GAAA,OAAA,EAAA,SAAA,EAAA,EAAA,GAAA,GAAA,oBAAA,QAAA,OAAA,YAAA,OAAA,GAAA,CAAA,IAAA,EAAA,GAAA,GAAA,EAAA,GAAA,EAAA,OAAA,EAAA,IAAA,IAAA,IAAA,EAAA,EAAA,EAAA,OAAA,cAAA,GAAA,EAAA,EAAA,QAAA,QAAA,EAAA,KAAA,EAAA,QAAA,GAAA,EAAA,SAAA,GAAA,GAAA,IAAA,MAAA,GAAA,GAAA,EAAA,EAAA,EAAA,QAAA,IAAA,GAAA,MAAA,EAAA,QAAA,EAAA,SAAA,QAAA,GAAA,EAAA,MAAA,GAAA,OAAA,GAAA,SAAA,EAAA,GAAA,GAAA,MAAA,QAAA,GAAA,OAAA,EAAAO,EAAE,WAyEW+F,SAAAA,EAAWzD,GAGZ,IAFE0D,IAAAA,EAAchG,EAAE,YAAcsC,EAAO,YAAYU,KAAK,uBACxDiD,EAAU,GACNC,EAAI,EAAGA,EAAIF,EAAYpG,OAAQsG,IAAI,CACnCC,IAAAA,EAASC,SAASpG,EAAEgG,EAAYE,IAAIjD,OACpCoD,MAAMF,IACNF,EAAQX,KAAKc,SAASpG,EAAEgG,EAAYE,IAAIjD,QAGzCgD,OAAAA,EAWFK,SAAAA,EAAwB7D,EAAUH,GACpCiE,KAAAA,SAASC,SAAShE,QAAQ,OAAS,GAAnC+D,CAIGE,IAAAA,EAAYzG,EAAE,YAAcsC,EAAO,qBAAqBrC,OAAOyG,WACjE,GAACD,EAAD,CAIAR,IAAAA,EAAUF,EAAWzD,IAlBpBqE,SAAarE,GACXtC,OAAAA,EAAE,YAAcsC,EAAO,YAAYrC,KAAK,qBAAuB,GAkBlE0G,CAAarE,KAAU2D,EAAQrG,QAInCI,EAAE4G,KAAK,CACHpF,IAAKhB,OAAOC,iBAAiBC,YAAYmG,UAAUxF,QAAQ,UAAW,IAAMoF,EAAY,KACxFK,OAAQ,OACR7G,KAAM,CACFwB,oBAAqBhB,iBAAiBiB,KACtCgF,WAAYD,EACZM,SAAUd,EACV3D,KAAAA,GAEJ0E,aAAa,EACbC,QAAS,SAAShH,GACVA,EAAKiH,OACLjH,EAAKiH,MAAM/F,QAAQ,SAACgG,GACVC,IAAAA,EAAYpH,EAAE,qBAAuBmH,EAAW/E,KAAO,MACvDsD,EAAMU,SAASgB,EAAUnH,KAAK,OAAQ,IAAM,EAClDD,EAAE,OAASsC,EAAO,IAAMoD,EAAM,SAASV,KAAK,QAASmC,EAAW/E,MAChEpC,EAAE,OAASsC,EAAO,IAAMoD,EAAM,OAAOV,KAAK,QAASmC,EAAWE,iBAGtE7G,OAAOoD,SAASC,QAAQ,CACpBC,KAAM,UACNC,KAAM9D,EAAKqH,WAGnB3D,MAAO,SAAS1D,GACZsH,MAAM,eAKTC,SAAAA,EAAkBC,EAAUrF,GAE9BA,EAAKe,MACJf,EAAOgB,KAAKC,MAAMjB,EAAKe,IAAIG,cAAclB,MAxGxCsF,SAAcD,EAAUrF,GACvBuF,IAAAA,EAAUF,EAAS3H,KAAK,MACxB8H,EAAa5H,EAAE,IAAM2H,EAAU,WAChCE,IAAI,SAACC,EAAGC,GAAO/H,OAAAA,EAAE+H,GAAI9H,KAAK,SAAQ+H,UAClC/G,OAAO,SAAAgH,GAASA,MAAU,oBAAVA,IACfC,EAAaN,EAAWhI,OAASuI,KAAKC,IAALD,MAAAA,KAAYP,EAAAA,IAAc,EAC3DS,EAAUrI,EAAE,IAAM2H,EAAU,sBAE9BW,EAAOD,EAAQC,OAAOjH,QAAQ,cAAe6G,GAAY7G,QAAQ,mBAAoB6G,EAAa,GAClG9F,IACAkG,EAAOA,EAAKjH,QAAQ,eAAgBe,EAAKmB,KAEvCgF,IAAAA,EAAQvI,EAAEsI,GAEZE,EAAW,YAOXpG,GANAuF,EAAQnF,QAAQ,SAAW,IAC3BgG,EAAW,YAGfxI,EAAE,IAAMwI,EAAW,gBAAgBvF,IAAIjD,EAAE,IAAM2H,EAAU,WAAW/H,QACpEI,EAAE,IAAMwI,EAAW,kBAAkBvF,IAAIjD,EAAE,IAAM2H,EAAU,WAAW/H,QAClEwC,EAAM,CACFqG,IAAAA,EAAYzI,EAAE,oCAAsCoC,EAAKZ,IAAM,0BAC/DkH,EAAQ,OAAStG,EAAKmC,KAAO,QACjB,cAAbiE,GACCC,EAAUE,OAAO,aAAevG,EAAKZ,IAAM,MAC3C+G,EAAMvF,KAAK,cAAc2F,OAAOF,KAEhCA,EAAUE,OAAO,aAAevG,EAAKZ,IAAM,QAC3C+G,EAAMvF,KAAK,iBAAiB4F,QAAQF,IAExCH,EAAMvF,KAAK,iBAAiBA,KAAK,SAASC,IAAIb,EAAKmB,IAEvDgF,EAAMM,aAAaR,GAyEnBX,CAAcD,EAAUrF,GA9I5BpC,EAAE,yBAAyB2C,GAAG,QAAS,SAASmG,GAC5CA,EAAEC,iBACEC,QAAQpH,QAAQ,kDAEhB5B,EAAE,MAAMiJ,QAAQ,UAAUC,UAC1BlJ,EAAE,MAAMmJ,KAAK,WAAWnG,KAAK,SAASgC,KAAK,WAAW,MAI9DhF,EAAE4E,UAAUjC,GAAG,QAAS,kBAAmB,SAASmG,GAChDA,EAAEC,iBACIK,IAAAA,EAASpJ,EAAE,MAAMiJ,QAAQ,UAGtBI,EAL0C,EAGpCD,EAAOnJ,KAAK,UAEAqJ,MAAM,KALkB,GAAA,GAO7CC,EAAevJ,EAAE,kCAEvBuJ,EAAaC,YAAY,kBAAkBC,SAAS,iBAEpDzJ,EAAE,qBAAqB0J,YAAY,WACxB1J,OAAAA,EAAE,MAAO,CAAU,MAAA,wCAAiD,KAAA,MAAM+D,KAAKnC,QAAQ,2BAGlG2H,EAAa9D,KAAK,SAASS,GACvBlG,EAAE,cAAgBkG,EAAI,eAAelB,KAAK,WAAW,KAGzDhF,EAAE,MAAM0J,YAAY,WACT1J,OAAAA,EAAE,SAAU,CAAU,MAAA,qBAAqB+D,KAAKnC,QAAQ,oBAGnEwH,EAAOK,SAAS,kBAChBzJ,EAAE,cAAgBqJ,EAAU,eAAerE,KAAK,WAAW,KA+G7C,CACd,CACI2E,MAAO,yBACPC,WAAY,mBACZ5H,SAAU,GACV6H,cAAe,UAEnB,CACIF,MAAO,wBACPC,WAAY,kBACZ5H,SAAU,GACV6H,cAAe,UAGb1I,QAAQ,SAAS2I,GACnBC,IAvEczH,EAAM0H,EAuEpBD,EAAU,IAAMD,EAASH,MAAQ,YACjC3J,EAAE+J,GAASnK,SAxEG0C,EA2EDwH,EAASD,cA3EFG,EA2EiBjE,EAAW+D,EAASD,eAAejK,OA1E5EI,EAAE,YAAcsC,EAAO,YAAYrC,KAAK,mBAAoB+J,IA2EvChK,EAAAA,EAAAA,kBAAAA,EAAE+J,GAAU,CACzB7J,WAAY4J,EAASF,WACrB5H,SAAU8H,EAAS9H,SACnBkB,UAAW,SAASd,GAChBoF,EAAkBxH,EAAE,IAAM8J,EAASH,OAAQvH,IAE/C4B,gBAAiB,WACbsC,EAAwB,EAAMwD,EAASD","file":"product.js","sourceRoot":"../../../static_src/product","sourcesContent":["/**\n * This file is part of Shuup.\n *\n * Copyright (c) 2012-2021, Shoop Commerce Ltd. All rights reserved.\n *\n * This source code is licensed under the OSL-3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\nfunction activateDropzone($dropzone, attrs={}) {\n    if(!$dropzone.length) {\n        console.error(\"Error! [dropzone.js] Unable to find requested element \", $dropzone);\n        return;\n    }\n\n    const selector = \"#\" + $dropzone.attr(\"id\");\n    const $data = $(selector).data();\n    const uploadPath = $data.upload_path || attrs.uploadPath;\n    const addRemoveLinks = $data.add_remove_links;\n    const uploadUrl = (\n        $data.upload_url ||\n        window.ShuupAdminConfig.browserUrls.media ||\n        window.ShuupAdminConfig.browserUrls.upload\n    );\n    const browsable = (window.ShuupAdminConfig.browserUrls[\"media\"] && $data.browsable && $data.browsable !== \"False\");\n\n    // Load attributes encoded in attributes with `data-dz-` prefixes\n    // e.g.: data-dz-maxFilesize=\"10000\"\n    const extraAttrs = {};\n    Object.keys($data).filter(attr => attr.startsWith(\"dz_\")).forEach((attr) => {\n        const attrKey = attr.replace(\"dz_\", \"\");\n        extraAttrs[attrKey] = $data[attr];\n    });\n\n    const params = Object.assign({\n        url: uploadUrl + \"?action=upload&path=\" + uploadPath,\n        uploadUrl,\n        params: {\n            csrfmiddlewaretoken: window.ShuupAdminConfig.csrf\n        },\n        addRemoveLinks: (addRemoveLinks === \"True\"),\n        dictRemoveFile: gettext(\"Clear\"),\n        autoProcessQueue: true,\n        uploadMultiple: false,\n        parallelUploads: 1,\n        maxFiles: 1,\n        dictDefaultMessage: gettext(\"Drop files here or click to browse.\"),\n        clickable: false,\n        accept: function(file, done) {\n            if ($data.kind === \"images\" && file.type.indexOf(\"image\") < 0) {\n                done(gettext(\"only images can be uploaded!\"));\n            } else {\n                done();\n            }\n        }\n    }, extraAttrs, attrs);\n    const dropzone = new Dropzone(selector, params);\n\n    dropzone.on(\"addedfile\", attrs.onAddedFile || function(file) {\n        if(params.maxFiles === 1 && dropzone.files.length > 1) {\n            dropzone.removeFile(dropzone.files[0]);\n        }\n    });\n\n    dropzone.on(\"removedfile\", attrs.onRemovedFile || function(data){\n        $(selector).find(\"input\").val(\"\");\n    });\n\n    dropzone.on(\"success\", attrs.onSuccess || function(data){\n        // file selected through dnd\n        if(data.xhr) {\n            data = JSON.parse(data.xhr.responseText).file;\n        }\n        $(selector).find(\"input\").val(data.id);\n    });\n\n    dropzone.on(\"error\", attrs.onError|| function(data){\n        let errorMessage = gettext(\"Error happened while uploading file.\")\n        if(data.xhr) {\n            response = JSON.parse(data.xhr.responseText)\n            if (response.error && response.error.file) {\n                errorMessage = JSON.parse(data.xhr.responseText).error.file\n            }\n        }\n\n        window.Messages.enqueue({ tags: \"error\", text: errorMessage});\n        dropzone.removeFile(data);\n    });\n\n    dropzone.on(\"queuecomplete\", attrs.onQueueComplete || $.noop);\n\n    $(selector).on(\"click\", function() {\n        if (browsable) {\n            window.BrowseAPI.openBrowseWindow({\n                kind: \"media\",\n                disabledMenus: [\"delete\", \"rename\"],\n                filter: $(selector).data().kind,\n                onSelect: (obj) => {\n                    obj.name = obj.text;\n                    $(selector).find(\"input\").val(obj.id);\n                    $(selector).find(\".dz-preview\").remove();\n                    dropzone.emit(\"addedfile\", obj);\n                    if(obj.thumbnail) {\n                        dropzone.emit(\"thumbnail\", obj, obj.thumbnail);\n                    }\n                    dropzone.emit(\"success\", obj);\n                    dropzone.emit(\"complete\", obj);\n                }\n            });\n        } else {\n            const fileInput = document.createElement(\"input\");\n            document.body.appendChild(fileInput);\n            $(fileInput).prop(\"type\", \"file\").css(\"display\", \"none\").on(\"change\", (evt) => {\n                const file = evt.target.files[0];\n                dropzone.addFile(file);\n                fileInput.remove();\n            }).trigger(\"click\");\n        }\n    });\n\n    const data = $(selector).data();\n    if(data.url) {\n        dropzone.files.push(data);\n        dropzone.emit(\"addedfile\", data);\n        if(data.thumbnail){\n            dropzone.emit(\"thumbnail\", data, data.thumbnail);\n        }\n        dropzone.emit(\"complete\", data);\n    }\n}\n\nwindow.activateDropzones = function() {\n    $(\"div[data-dropzone='true']\").each(function(idx, object) {\n        const dropzone = $(object);\n        if(!dropzone.attr(\"id\").includes(\"__prefix__\") && dropzone.find(\".dz-message\").length === 0) {\n            activateDropzone(dropzone);\n        }\n    });\n};\nwindow.activateDropzone = activateDropzone;\n\n$(function(){\n    window.activateDropzones();\n});\n\nmodule.exports = { activateDropzone }\n","/**\n * This file is part of Shuup.\n *\n * Copyright (c) 2012-2021, Shoop Commerce Ltd. All rights reserved.\n *\n * This source code is licensed under the OSL-3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport { activateDropzone } from '../base/js/dropzone';\n\n$(function() {\n    $(\".product-media-delete\").on(\"click\", function(e) {\n        e.preventDefault();\n        if (confirm(gettext(\"Are you sure you want to delete this media?\")))\n        {\n            $(this).parents(\".panel\").fadeOut();\n            $(this).next(\".d-none\").find(\"input\").prop(\"checked\", true);\n        }\n    });\n\n    $(document).on(\"click\", \".set-as-primary\", function(e) {\n        e.preventDefault();\n        const $panel = $(this).parents(\".panel\");\n        const prefix = $panel.data(\"prefix\");\n\n        const [, current] = prefix.split(\"-\");\n\n        const $imagePanels = $(\"#product-images-section .panel\");\n\n        $imagePanels.removeClass(\"panel-selected\").addClass(\"panel-default\");\n\n        $(\".is-primary-image\").replaceWith(function() {\n            return $(\"<a>\", {\"class\": \"set-as-primary btn btn-sm btn-inverse\", \"href\": \"#\"}).text(gettext(\"Set as primary image\"));\n        });\n\n        $imagePanels.each(function(i) {\n            $(\"#id_images-\" + i + \"-is_primary\").prop(\"checked\", false);\n        });\n\n        $(this).replaceWith(function() {\n            return $(\"<span>\", {\"class\": \"is-primary-image\"}).text(gettext(\"Primary image\"));\n        });\n\n        $panel.addClass(\"panel-selected\");\n        $(\"#id_images-\" + current + \"-is_primary\").prop(\"checked\", true);\n    });\n\n    function addMediaPanel($section, file) {\n        const section = $section.attr(\"id\");\n        const maxPanelId = $(\"#\" + section + \" .panel\")\n            .map((v, el) => $(el).data(\"idx\")).toArray()\n            .filter(value => value !== \"__prefix_name__\");\n        const panelCount = maxPanelId.length ? Math.max(...maxPanelId) : 0;\n        const $source = $(\"#\" + section + \"-placeholder-panel\");\n\n        let html = $source.html().replace(/__prefix__/g, panelCount).replace(/__prefix_name__/g, panelCount + 1);\n        if (file) {\n            html = html.replace(/__file_id__/g, file.id);\n        }\n        const $html = $(html);\n\n        let targetId = \"id_images\";\n        if (section.indexOf(\"media\") > 0) {\n            targetId = \"id_media\";\n        }\n\n        $(\"#\" + targetId + \"-TOTAL_FORMS\").val($(\"#\" + section + \" .panel\").length);\n        $(\"#\" + targetId + \"-INITIAL_FORMS\").val($(\"#\" + section + \" .panel\").length);\n        if (file) {\n            let $contents = $(\"<a class='thumbnail-image' href='\" + file.url + \"' target='_blank'></a>\");\n            let $name = \"<h4>\" + file.name + \"</h4>\";\n            if(targetId === \"id_images\") {\n                $contents.append(\"<img src='\" + file.url + \"'>\");\n                $html.find(\".thumbnail\").append($contents);\n            } else {\n                $contents.append(\"<img src='\" + file.url + \"' />\");\n                $html.find(\".extra-fields\").prepend($name);\n            }\n            $html.find(\".file-control\").find(\"input\").val(file.id);\n        }\n        $html.insertBefore($source);\n    }\n\n    function getFileIds(kind) {\n        const $fileInputs = $(\"#product-\" + kind + \"-section\").find(\".file-control input\");\n        var fileIds = [];\n        for(var i = 0; i < $fileInputs.length; i++){\n            let fileId = parseInt($($fileInputs[i]).val());\n            if(!isNaN(fileId)) {\n                fileIds.push(parseInt($($fileInputs[i]).val()));\n            }\n        }\n        return fileIds\n    }\n\n    function getFileCount(kind) {\n        return $(\"#product-\" + kind + \"-section\").data(\"saved_file_count\") || 0;\n    }\n\n    function setFileCount(kind, count) {\n        $(\"#product-\" + kind + \"-section\").data(\"saved_file_count\", count);\n    }\n\n    function onDropzoneQueueComplete(dropzone, kind) {\n        if(location.pathname.indexOf(\"new\") > 0) {\n            // save product media the traditional way via the save button when creating a new product\n            return;\n        }\n        const productId = $(\"#product-\" + kind + \"-section-dropzone\").data().product_id;\n        if (!productId) {\n            return;\n        }\n\n        let fileIds = getFileIds(kind);\n        if (getFileCount(kind) === fileIds.length) {  // Skip add media if file count has not changed\n            return;\n        }\n\n        $.ajax({\n            url: window.ShuupAdminConfig.browserUrls.add_media.replace(\"/99999/\", \"/\" + productId + \"/\"),\n            method: \"POST\",\n            data: {\n                csrfmiddlewaretoken: ShuupAdminConfig.csrf,\n                product_id: productId,\n                file_ids: fileIds,\n                kind\n            },\n            traditional: true,\n            success: function(data) {\n                if (data.added) {\n                    data.added.forEach((addedMedia) => {\n                        const filePanel = $(\".panel[data-file='\" + addedMedia.file + \"']\");\n                        const idx = parseInt(filePanel.data(\"idx\"), 10) - 1;\n                        $(\"#id_\" + kind + \"-\" + idx + \"-file\").prop(\"value\", addedMedia.file);\n                        $(\"#id_\" + kind + \"-\" + idx + \"-id\").prop(\"value\", addedMedia.product_media);\n                    });\n                }\n                window.Messages.enqueue({\n                    tags: \"success\",\n                    text: data.message\n                });\n            },\n            error: function(data) {\n                alert(\"Error!\");\n            }\n        });\n    }\n\n    function onDropzoneSuccess($section, file) {\n        // file selected through dnd\n        if(file.xhr) {\n            file = JSON.parse(file.xhr.responseText).file;\n        }\n        addMediaPanel($section, file);\n    }\n    const dropzones = [\n        {\n            field: 'product-images-section',\n            targetPath: \"/products/images\",\n            maxFiles: 10,\n            queueComplete: \"images\"\n        },\n        {\n            field: 'product-media-section',\n            targetPath: \"/products/media\",\n            maxFiles: 10,\n            queueComplete: \"media\"\n        }\n    ];\n    dropzones.forEach(function(zoneData) {\n        var fieldId = \"#\" + zoneData.field + \"-dropzone\";\n        if ($(fieldId).length) {\n            // Save file count so we can prevent saving product media\n            // if file count has not changed\n            setFileCount(zoneData.queueComplete, getFileIds(zoneData.queueComplete).length);\n            activateDropzone($(fieldId), {\n                uploadPath: zoneData.targetPath,\n                maxFiles: zoneData.maxFiles,\n                onSuccess: function(file) {\n                    onDropzoneSuccess($(\"#\" + zoneData.field), file);\n                },\n                onQueueComplete: function() {\n                    onDropzoneQueueComplete(this, zoneData.queueComplete);\n                }\n            });\n        }\n    });\n});\n"]}