---
- name: apt-get install git jq node-json5
  apt:
    name: [git, jq, node-json5]
    state: present

- name: apt-get install apt-transport-https
  apt:
    name: apt-transport-https
    state: present

- name: apt-key https://deb.nodesource.com/gpgkey/nodesource.gpg.key
  apt_key:
    url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
    state: present

- name: add repo https://deb.nodesource.com/node_{{ pad_nodejs_version }}
  apt_repository:
    repo: "{{ item }}"
    state: present
  with_items:
    - "deb https://deb.nodesource.com/node_{{ pad_nodejs_version }} {{ ansible_distribution_release }} main"
    - "deb-src https://deb.nodesource.com/node_{{ pad_nodejs_version }} {{ ansible_distribution_release }} main"
  register: node_repo

- name: apt-get update
  apt:
    update_cache: yes
  when: node_repo.changed

- name: apt-get install nodejs
  apt:
    name: nodejs
    state: latest

- name: git clone https://github.com/ether/etherpad-lite.git
  git:
    repo: https://github.com/ether/etherpad-lite.git
    force: yes
    dest: /srv/etherpad
    version: "tags/{{ pad_etherpad_version}}"

- name: groupadd etherpad
  group:
    name: etherpad

- name: adduser etherpad
  user:
    name: etherpad
    groups: etherpad
    system: yes
    home: /srv/etherpad

- name: json5 -c /srv/etherpad/settings.json.template
  shell: json5 -c settings.json.template
  args:
    chdir: /srv/etherpad
    creates: /srv/etherpad/settings.json.template.json
  
- name: set admin password
  shell: |
    jq '.users |= { "admin": { "password": "{{ pad_admin_password }}", "is_admin": true } }' < settings.json.template.json > settings.json
  args:
    chdir: /srv/etherpad

- name: npm install ep_delete_empty_pads ep_author_hover ep_spellcheck
  shell: |
    npm install ep_delete_empty_pads ep_author_hover ep_spellcheck
  args:
    chdir: /srv/etherpad

- name: chown -R etherpad /srv/etherpad
  file:
    path: /srv/etherpad
    state: directory
    mode: 0755
    owner: etherpad
    recurse: yes

- name: add unit /etc/systemd/system/etherpad.service
  template:
    src: etherpad.service.j2
    dest: /etc/systemd/system/etherpad.service

- name: systemctl start etherpad
  service:
    name: etherpad
    state: restarted
    enabled: yes
    
