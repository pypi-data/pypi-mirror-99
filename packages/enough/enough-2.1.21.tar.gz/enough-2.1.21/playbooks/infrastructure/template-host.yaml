# https://docs.openstack.org/heat/stein/template_guide/openstack.html
heat_template_version: 2017-02-24

parameters:

  port:
    type: string
    default: "22"

  flavor:
    type: string

  image:
    type: string

  network:
    type: string

  network_interface_unconfigured:
    type: string
    default: noname

  network_interface_routed:
    type: string

  network_interface_not_routed:
    type: string

  public_key:
    type: string

  volume_size:
    type: number
    default: 0

  volume_name:
    type: string
    default: noname

conditions:

  need_volume: { not: { equals: [{get_param: volume_size}, 0]}}

resources:
  keypair:
    type: OS::Nova::KeyPair
    properties:
      name: { get_param: 'OS::stack_name' }
      public_key: { get_param: public_key }

  instance:
    type: OS::Nova::Server
    properties:
      name: { get_param: 'OS::stack_name' }
      key_name: { get_resource: keypair }
      image: { get_param: image }
      flavor: { get_param: flavor }
      security_groups:
        - { get_resource: security_group }
      networks:
        - network: { get_param: network }
      user_data:
        str_replace:
          template: { get_file: network.sh }
          params:
            $PORT: { get_param: port }
            $UNCONFIGURED: { get_param: network_interface_unconfigured }
            $ROUTED: { get_param: network_interface_routed }
            $NOT_ROUTED: { get_param: network_interface_not_routed }

  volume:
    type: OS::Cinder::Volume
    condition: need_volume
    properties:
      name: { get_param: volume_name }
      size: { get_param: volume_size }

  attachment:
    type: OS::Cinder::VolumeAttachment
    condition: need_volume
    properties:
      instance_uuid: { get_resource: instance }
      volume_id: { get_resource: volume }

  security_group:
    type: OS::Neutron::SecurityGroup
    properties:
      name: { get_param: 'OS::stack_name' }
      rules:
        - port_range_min: { get_param: port }
          port_range_max: { get_param: port }
          protocol: tcp
          remote_ip_prefix: 0.0.0.0/0
