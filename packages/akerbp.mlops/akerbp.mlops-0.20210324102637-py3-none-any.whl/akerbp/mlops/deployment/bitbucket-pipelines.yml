#  Deployment Pipeline - Version MLOPS_VERSION
#
#  User notes
#    - Branch name determine pipeline behavior. See description for master 
#        branch and those after. Do not use "mlops*" as prefix.


image: python:3.8

clone:
  lfs: true

pipelines:
  branches:
    # Use this branch prefix when developing the mlops package
    # Build package and upload to pypi before the model service steps
    'mlops/*': 
      - parallel:
        - step: &deploy-test-training-service
            name: Deploy training service to test
            deployment: test-training
            caches:
              - pip
            script: 
              - pip install "akerbp.mlops==MLOPS_VERSION"
              - source install_gc_sdk.sh
              - bash deploy_training_service.sh
        - step: &deploy-test-prediction-service
            name: Deploy prediction service to test
            deployment: test-prediction
            caches:
              - pip
            script: 
              - pip install "akerbp.mlops==MLOPS_VERSION"
              - source install_gc_sdk.sh
              - bash deploy_prediction_service.sh
      - parallel:
        - step: &deploy-production-training-service
            <<: *deploy-test-training-service
            name: Deploy training service to prod
            deployment: production-training
            trigger: manual
        - step: &deploy-production-prediction-service
            <<: *deploy-test-prediction-service
            name: Deploy prediction service to prod
            deployment: production-prediction
            trigger: manual
    # Use master branch to develop model projects with prediction services only.
    master: &master-branch
      - step: *deploy-test-prediction-service
      - step: *deploy-production-prediction-service
    # Branches with this prefix behave as master (useful if a model project 
    # needs to deploy after each commit)
    deploy/*: *master-branch
