(self.webpackChunklabbox_ephys_widgets_jp=self.webpackChunklabbox_ephys_widgets_jp||[]).push([[4169],{85155:(e,t,n)=>{"use strict";n.d(t,{F0:()=>r,ZL:()=>a});var i=n(45185),l=n(56271);const r=e=>{const{result:t}=(0,i.useHitherJob)(e?"createjob_get_recording_info":"",{recording_object:e},{useClientCache:!0});return t},a=e=>{const t=(0,l.useContext)(i.HitherContext),n=(0,l.useRef)({}),[,r]=(0,l.useState)(0),a={};return e.forEach((e=>{const i=e.recordingId;if(!n.current[i]){const l=t.createHitherJob("createjob_get_recording_info",{recording_object:e.recordingObject},{useClientCache:!0});n.current[i]=l,l.wait().then((()=>{r((e=>e+1))})).catch((()=>{r((e=>e+1))}))}n.current[i].result&&(a[i]=n.current[i].result)})),a}},37249:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(56271),l=n.n(i),r=n(65405),a=n(49287),s=n(96333);const o=({sorting:e,selection:t,selectionDispatch:n})=>{const i=(0,r.D)(e.sortingObject,e.recordingObject);if(!i)return l().createElement("div",null,"No sorting info");const o=((null==i?void 0:i.unit_ids)||[]).filter((n=>!t.applyMerges||(0,a.GI)(n,e.curation)));return l().createElement(s.Z,Object.assign({units:o},{selection:t,selectionDispatch:n,sorting:e}))}},34169:(e,t,n)=>{"use strict";n.r(t),n.d(t,{activate:()=>I});var i=n(37030),l=n(56271),r=n.n(l),a=n(45185),s=n(58226),o=n(85155),c=n(65405),u=n(22874),d=n(49287),m=n(48709);const h=["blue","green","red","orange","purple","cyan"],p=e=>{if(Array.isArray(e))return p(Math.min(...e));for(;e<0;)e+=h.length;return h[e%h.length]};class g{constructor(e,t){this.panels=e,this.labelString=t}setTimeRange(e){this.panels.forEach((t=>t.setTimeRange(e)))}paint(e,t){this.panels.forEach((n=>n.paint(e,t)))}paintYAxis(e,t,n){const i=this.panels[0];i&&i.paintYAxis&&i.paintYAxis(e,t,n)}label(){return this.labelString}register(e){this.panels.forEach((t=>t.register((()=>{e()}))))}}const b=(e,t)=>new g(e,t),f=class{constructor(e){this.args=e,this._updateHandler=null,this._timeRange=null,this._calculationScheduled=!1,this._calculationError=null,this._yrange=null,this._globalAmplitudeRange=null,this._includeZero=!0,this._amplitudes=void 0}setTimeRange(e){this._timeRange=e}paint(e,t){const n=this._timeRange;if(!n)return;const i={color:"black"},l={color:p(this.args.unitId)};if(!this.args.spikeAmplitudesData)return;const r=this.args.spikeAmplitudesData.getSpikeAmplitudes(this.args.unitId);if(r&&r.timepoints&&r.amplitudes){const{timepoints:t,amplitudes:a}=r;this._amplitudes=a;let s=this._yrange||this.autoYRange();if(!s)return;this._includeZero&&(s={min:Math.min(0,s.min),max:Math.max(0,s.max)}),e.drawLine(n.min,0,n.max,0,{color:"gray"});const o=t.length;for(let r=0;r<o;r++){const o=t[r],c=(a[r]-s.min)/(s.max-s.min);n.min<=o&&o<=n.max&&e.drawMarker([o,c],{radius:3,pen:i,brush:l})}}else e.drawText({rect:{xmin:n.min,xmax:n.max,ymin:0,ymax:1},alignment:{Horizontal:"AlignCenter",Vertical:"AlignCenter"},font:{pixelSize:12,family:"Arial"},pen:i,brush:l,text:"calculating"})}paintYAxis(e,t,n){((e,t,{label:n})=>{const{xmin:i,xmax:l,ymin:r,ymax:a}=t;e.drawLine(l,r,l,a,{color:"black"}),e.drawText({rect:{xmin:i,xmax:l-10-2,ymin:r,ymax:a},alignment:{Horizontal:"AlignRight",Vertical:"AlignCenter"},font:{family:"Arial",pixelSize:12},pen:{color:"black"},brush:{color:"black"},text:n,orientation:"Vertical"})})(e,{xmin:0,xmax:t,ymin:0,ymax:n},{label:"Spike amplitude"})}label(){return this.args.unitId+""}amplitudeRange(){return this._amplitudes?{min:(0,u.Gt)(this._amplitudes),max:(0,u.lR)(this._amplitudes)}:null}setGlobalAmplitudeRange(e){this._globalAmplitudeRange=e}autoYRange(){return this._globalAmplitudeRange?this._globalAmplitudeRange:this.amplitudeRange()}setYRange(e){this._yrange=e}register(e){this._updateHandler=e}},_=({spikeAmplitudesData:e,recording:t,sorting:n,unitIds:i,width:h,height:p,selection:g,selectionDispatch:_})=>{const x=(0,l.useContext)(a.HitherContext),y=(0,c.D)(n.sortingObject,n.recordingObject),E=(0,o.F0)(t.recordingObject),[v,w]=(0,s.Z)(d.SF,g,(0,l.useMemo)((()=>e=>{_({type:"Set",state:e})}),[_]),400),[k,C]=(0,l.useState)(null);(0,l.useEffect)((()=>{const l=[],r=[],a=[];i.forEach((i=>{const s=(0,d.kN)(i,n.curation,v.applyMerges),o=new f({spikeAmplitudesData:e,recording:t,sorting:n,unitId:s,hither:x}),c=e.getSpikeAmplitudes(s);c&&(r.push(c.minAmp),a.push(c.maxAmp)),l.push(o)})),0===l.length&&l.push(new f({spikeAmplitudesData:null,recording:t,sorting:n,unitId:-1,hither:x})),r.length>0&&l.forEach((e=>{e.setGlobalAmplitudeRange({min:(0,u.Gt)(r),max:(0,u.lR)(a)})})),C(l)}),[i,n,x,t,e,v]);const S=(0,l.useMemo)((()=>k?[b(k,"")]:[]),[k]);return y?E?r().createElement(m.Z,{panels:S,width:h,height:p,samplerate:y.samplerate,maxTimeSpan:60*y.samplerate*5,startTimeSpan:60*y.samplerate*1,numTimepoints:E.num_frames,selection:v,selectionDispatch:w}):r().createElement("div",null,"No recording info"):r().createElement("div",null,"No sorting info")};var x=n(50977),y=n(76827),E=function(e,t,n,i){return new(n||(n=Promise))((function(l,r){function a(e){try{o(i.next(e))}catch(e){r(e)}}function s(e){try{o(i.throw(e))}catch(e){r(e)}}function o(e){var t;e.done?l(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}o((i=i.apply(e,t||[])).next())}))};const v=(0,x.zy)({maxSimultaneous:6}),w=(e,t)=>{const n=(0,l.useContext)(x.Zo),i=(0,l.useMemo)((()=>i=>E(void 0,void 0,void 0,(function*(){switch(i.type){case"spikeAmplitudes":return yield(({hither:e,recordingObject:t,sortingObject:n,unitId:i})=>E(void 0,void 0,void 0,(function*(){const l=yield e.createHitherJob("createjob_fetch_spike_amplitudes",{recording_object:t,sorting_object:n,unit_id:i},{useClientCache:!0,calculationPool:v}).wait();return Object.assign(Object.assign({},l),{minAmp:(0,u.Gt)(l.amplitudes),maxAmp:(0,u.lR)(l.amplitudes)})})))({hither:n,recordingObject:e,sortingObject:t,unitId:i.unitId});default:throw Error("Unexpected query type")}}))),[n,e,t]),r=(0,y.Z)(i),a=(0,l.useMemo)((()=>e=>r.get({type:"spikeAmplitudes",unitId:e})),[r]);return(0,l.useMemo)((()=>({getSpikeAmplitudes:a})),[a])},k=e=>{const t=w(e.recording.recordingObject,e.sorting.sortingObject);return t?r().createElement(_,Object.assign({spikeAmplitudesData:t,recording:e.recording,sorting:e.sorting,unitIds:[e.unitId]},{width:e.width||500,height:e.height||500},{selection:e.selection,selectionDispatch:e.selectionDispatch})):r().createElement("div",null,"Creating spike amplitudes data...")};var C=n(88493),S=n(37249);const A=({recording:e,sorting:t,selection:n,selectionDispatch:i,width:l,height:a})=>{const s=w(e.recordingObject,t.sortingObject);return s?r().createElement(C.Z,{width:l||600,height:a||900,initialPosition:200},r().createElement(S.Z,{sorting:t,selection:n,selectionDispatch:i}),r().createElement(_,Object.assign({spikeAmplitudesData:s,recording:e,sorting:t,unitIds:n.selectedUnitIds||[]},{width:0,height:0},{selection:n,selectionDispatch:i}))):r().createElement("div",null,"Creating spike amplitudes data...")};function I(e){e.registerPlugin({type:"SortingView",name:"SpikeAmplitudes",label:"Spike amplitudes",priority:50,defaultExpanded:!1,component:A,singleton:!1,icon:r().createElement(i.Z,null)}),e.registerPlugin({type:"SortingUnitView",name:"SpikeAmplitudes",label:"Spike amplitudes",priority:50,fullWidth:!0,component:k,icon:r().createElement(i.Z,null)})}},96333:(e,t,n)=>{"use strict";n.d(t,{Z:()=>b});var i=n(56271),l=n.n(i),r=n(49287),a=n(36464),s=n(93379),o=n.n(s),c=n(97948);o()(c.Z,{insert:"head",singleton:!1}),c.Z.locals;var u=n(48003),d=n(9756),m=n(47033);const h=e=>{const{columns:t,onColumnClick:n,primarySortColumnDirection:i,primarySortColumnName:r,onDeselectAll:a}=e;return l().createElement(m.TableHead,null,l().createElement(m.TableRow,null,a?l().createElement(m.TableCell,{key:"_checkbox"},l().createElement(p,{rowId:"",selected:!1,onClick:()=>{a()},isDeselectAll:!0})):l().createElement(m.TableCell,{key:"_checkbox"}),t.map((e=>{const t=(e.tooltip||e.label||"")+" (click to sort)";return l().createElement(m.TableCell,{key:e.columnName,onClick:()=>n(e),title:t,style:{cursor:"pointer"}},l().createElement(m.Grid,{container:!0,justify:"flex-start",style:{flexFlow:"row"}},l().createElement(m.Grid,{item:!0,key:"icon"},l().createElement("span",{style:{fontSize:16,color:"gray",paddingLeft:3,paddingRight:5,paddingTop:2}},r===e.columnName&&("ascending"===i?l().createElement(d.FontAwesomeIcon,{icon:u.faCaretUp}):l().createElement(d.FontAwesomeIcon,{icon:u.faCaretDown})))),l().createElement(m.Grid,{item:!0,key:"text"},l().createElement("span",null,l().createElement("span",{key:"label"},e.label),l().createElement("span",{key:"progress"},e.calculating&&l().createElement(m.LinearProgress,null))))))}))))},p=l().memo((e=>{const{rowId:t,selected:n,onClick:i,isDeselectAll:r}=e;return l().createElement(m.Checkbox,{checked:n,indeterminate:!!r,onClick:()=>i(t),style:{padding:1},title:r?"Deselect all":`Select ${t}`})})),g=e=>{const{selectedRowIds:t,onSelectedRowIdsChanged:n,rows:r,columns:a,defaultSortColumnName:s,height:o}=e,[c,u]=(0,i.useState)([]);(0,i.useEffect)((()=>{0===c.length&&s&&u([s])}),[u,c,s]);const d=(0,i.useCallback)((e=>{const i=t.includes(e)?t.filter((t=>t!==e)):[...t,e];n(i)}),[t,n]),g=[...r],b=e=>a.filter((t=>t.columnName===e))[0],f=(e=>{const t=[];for(let n=0;n<e.length;n++){const i=e[n-1]!==e[n];t.push({columnName:e[n],keyOrder:n,sortAscending:i})}return t})(c);for(const e of f){const t=e.columnName,n=b(t);g.sort(((i,l)=>{const r=i.data[t]||{},a=l.data[t]||{},s=r.sortValue,o=a.sortValue;return e.sortAscending?n.sort(s,o):n.sort(o,s)}))}const _=(t||[]).reduce(((e,t)=>(e[t]=!0,e)),{}),x=f.length>0?f[f.length-1]:void 0,y=x?x.columnName:void 0,E=x?x.sortAscending?"ascending":"descending":void 0;return l().createElement(m.TableContainer,{style:void 0!==o?{maxHeight:o}:{}},l().createElement(m.Table,{stickyHeader:!0,className:"TableWidget"},l().createElement(h,{columns:a,primarySortColumnName:y,primarySortColumnDirection:E,onColumnClick:e=>{const t=e.columnName;let n=[...c];n=c[c.length-1]===t?c[c.length-2]===t?n.slice(0,n.length-1):[...n,t]:[...n.filter((e=>e!==t)),t],u(n)},onDeselectAll:t.length>0?()=>{n([])}:void 0}),l().createElement(m.TableBody,null,g.map((e=>{const t=_[e.rowId]||!1;return l().createElement(m.TableRow,{key:e.rowId},l().createElement(m.TableCell,{key:"_checkbox",className:t?"selectedRow":""},l().createElement(p,{rowId:e.rowId,selected:t,onClick:()=>d(e.rowId)})),a.map((n=>l().createElement(m.TableCell,{key:n.columnName,className:t?"selectedRow":""},l().createElement("div",{title:n.tooltip},n.dataElement(e.data[n.columnName].value))))))})))))},b=e=>{const{sortingUnitMetrics:t,units:n,metrics:s,selection:o,selectionDispatch:c,sorting:u,height:d}=e,m=(o||{}).selectedUnitIds||[],h=(0,a.Z)(Object.values(t||{})).filter((e=>!e.disabled)),p=(0,i.useCallback)((e=>{c({type:"SetSelectedUnitIds",selectedUnitIds:e.map((e=>Number(e)))})}),[c]),b=n.map((e=>({rowId:e+"",data:{}}))),f=(e,t)=>Number(e)-Number(t),_=e=>l().createElement("span",null,e+""),x={color:"black",fontWeight:"bold",cursor:"pointer"},y={color:"gray",textDecoration:"underline",cursor:"pointer"},E=[];E.push({columnName:"_unit_id",label:"Unit ID",tooltip:"Unit ID",sort:f,dataElement:e=>{const{unitId:t,mergeGroup:n}=e;return l().createElement("span",null,l().createElement("span",{key:"unitId",style:x},t+""),n&&n.length>0&&l().createElement("span",{key:"mergeGroup"},` (${n.map((e=>e+"")).join(", ")})`))}}),b.forEach((e=>{const t=Number(e.rowId);e.data._unit_id={value:{unitId:t,mergeGroup:(0,r.CC)(t,u.curation)},sortValue:t}})),E.push({columnName:"_labels",label:"Labels",tooltip:"Curation labels",sort:(e,t)=>e<t?-1:e>t?1:0,dataElement:e=>{const t=e;return l().createElement("span",null,t.map((e=>l().createElement("span",{key:e},l().createElement("span",{style:y},e),"Â "))))}}),b.forEach((e=>{const t=((e,t)=>((t.curation||{}).labelsByUnit||{})[e]||[])(Number(e.rowId),u);e.data._labels={value:t,sortValue:t.join(", ")}})),(u.externalUnitMetrics||[]).forEach((e=>{const t="external-metric-"+e.name;E.push({columnName:t,label:e.label,tooltip:e.tooltip||"",sort:f,dataElement:_}),b.forEach((n=>{const i=Number(n.rowId),l=e.data[i+""];n.data[t]={value:void 0!==l?l:NaN,sortValue:void 0!==l?l:NaN}}))})),h.forEach((e=>{const t="plugin-metric-"+e.name,n=(s||{})[e.name]||null,i=n?n.data:null;E.push({columnName:t,label:e.columnLabel,tooltip:e.tooltip||"",sort:f,dataElement:e.component,calculating:n&&!i}),b.forEach((n=>{const l=Number(n.rowId),r=i&&l+""in i?i[l+""]:void 0,a=void 0!==r?e.getValue(r):void 0;n.data[t]={value:r,sortValue:void 0!==a?a:e.isNumeric?NaN:""}}))}));const v=m.map((e=>e+""));return l().createElement(g,{rows:b,columns:E,selectedRowIds:v,onSelectedRowIdsChanged:p,defaultSortColumnName:"_unit_id",height:d})}},37030:(e,t,n)=>{"use strict";var i=n(95318),l=n(20862);t.Z=void 0;var r=l(n(56271)),a=(0,i(n(2108)).default)(r.createElement(r.Fragment,null,r.createElement("circle",{cx:"7",cy:"14",r:"3"}),r.createElement("circle",{cx:"11",cy:"6",r:"3"}),r.createElement("circle",{cx:"16.6",cy:"17.6",r:"3"})),"ScatterPlot");t.Z=a},97948:(e,t,n)=>{"use strict";n.d(t,{Z:()=>r});var i=n(23645),l=n.n(i)()((function(e){return e[1]}));l.push([e.id,".TableWidget .MuiTableCell-root {\n    padding-top: 1px;\n    padding-bottom: 1px;\n    padding-left: 0px;\n    padding-right: 0px;\n    font-size: 12px;\n    border: solid 1px #f0f0f0;\n}\n\n.TableWidget .MuiTableCell-root.selectedRow {\n    background-color: #b5d1ff;\n}",""]);const r=l},50977:(e,t,n)=>{"use strict";n.d(t,{Zo:()=>c,zy:()=>r,lG:()=>d});const i=[];class l{constructor({maxSimultaneous:e,method:t}){this._activeSlots={},this._numActiveSlots=0,this._lastSlotId=-1,this._pendingRequestCallbacks=[],this._paused=!1,this._resumeCallbacks=[],this._maxSimultaneous=e,this._method=t||"queue",i.push(this)}requestSlot(){return e=this,t=void 0,i=function*(){return this._paused?new Promise(((e,t)=>{this._resumeCallbacks.push((()=>{this.requestSlot().then(e).catch(t)}))})):this._numActiveSlots<this._maxSimultaneous?this._createNewSlot():new Promise(((e,t)=>{this._pendingRequestCallbacks.push((t=>{e(t)}))}))},new((n=void 0)||(n=Promise))((function(l,r){function a(e){try{o(i.next(e))}catch(e){r(e)}}function s(e){try{o(i.throw(e))}catch(e){r(e)}}function o(e){var t;e.done?l(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}o((i=i.apply(e,t||[])).next())}));var e,t,n,i}isPaused(){return this._paused}pause(){this._paused||(this._paused=!0,this._resumeCallbacks=[])}resume(){this._paused&&(this._paused=!1,this._resumeCallbacks.forEach((e=>{e()})))}_createNewSlot(){const e=this._lastSlotId+1;return this._lastSlotId=e,this._numActiveSlots++,this._activeSlots[e]={slotId:e,complete:()=>{this._numActiveSlots--,delete this._activeSlots[e],this._update()}},this._activeSlots[e]}_update(){for(;this._pendingRequestCallbacks.length>0&&this._numActiveSlots<this._maxSimultaneous;){let e;if("queue"===this._method)e=this._pendingRequestCallbacks.shift();else{if("stack"!==this._method)throw Error(`Unexpected method in calculation pool: ${this._method}`);e=this._pendingRequestCallbacks.pop()}if(!e)throw Error("unexpected");e(this._createNewSlot())}}}const r=({maxSimultaneous:e,method:t})=>new l({maxSimultaneous:e,method:t});var a=n(56271);const s={jobId:null,functionName:"",kwargs:{},opts:{},clientJobId:"",result:null,runtime_info:{},error_message:null,status:"pending",timestampStarted:0,timestampFinished:null,clientCancelled:!1,wait:()=>{return e=void 0,t=void 0,i=function*(){},new((n=void 0)||(n=Promise))((function(l,r){function a(e){try{o(i.next(e))}catch(e){r(e)}}function s(e){try{o(i.throw(e))}catch(e){r(e)}}function o(e){var t;e.done?l(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}o((i=i.apply(e,t||[])).next())}));var e,t,n,i},cancel:()=>{}},o={createHitherJob:(e,t,n)=>s,getHitherJobs:()=>[]},c=n.n(a)().createContext(o);function u(e,t){if(e===t)return!0;if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!u(e[n],t[n]))return!1;return!0}if("object"==typeof e){if("object"!=typeof t)return!1;for(let n in e){if(!(n in t))return!1;if(!u(e[n],t[n]))return!1}for(let n in t)if(!(n in e))return!1;return!0}return!1}const d=(e,t,n)=>{var i;const l=(0,a.useContext)(c),[r,o]=(0,a.useState)({status:"pending",functionName:"",hitherJobOpts:{},functionArgs:{},job:null});if(!e)return{result:void 0,job:s};if(e!==r.functionName||!u(t,r.functionArgs)||!u(n,r.hitherJobOpts)){const i=l.createHitherJob(e,t,n);return o({status:"running",functionName:e,functionArgs:t,hitherJobOpts:n,job:i}),i.wait().then((()=>{i.clientCancelled||o({status:"finished",functionName:e,functionArgs:t,hitherJobOpts:n,job:i})})).catch((l=>{i.clientCancelled||o({status:"error",functionName:e,functionArgs:t,hitherJobOpts:n,job:i})})),{result:void 0,job:i}}if(!r.job)throw Error("Unexpected: job is not defined");let d={result:void 0,job:r.job};switch(r.status){case"finished":d.result=null===(i=r.job)||void 0===i?void 0:i.result}return d}}}]);