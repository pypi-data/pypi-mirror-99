(self.webpackChunklabbox_ephys_widgets_jp=self.webpackChunklabbox_ephys_widgets_jp||[]).push([[645],{54537:(e,t,n)=>{"use strict";n.d(t,{Z:()=>l});var i=n(60352),r=n.n(i)()((function(e){return e[1]}));r.push([e.id,".MVSortingView .ViewContainerTabBar {\n    background-color: rgb(134, 134, 150);\n}\n\n.MVSortingView .ViewContainerTabBar.active {\n    background-color: darkblue;\n}\n\n.MVSortingView .ViewContainerTabBar .Tab {\n    color: white\n}\n\n.MVSortingView .ViewContainerTabBar.active .Tab.selected {\n    font-weight: bold;\n    color: rgb(219, 219, 177)\n}\n\n.MVSortingView .ViewContainerTabBar .Tab .CloseButton {\n    color: white\n}\n\n.MVSortingView .ViewContainerTabBar.active .Tab.selected .CloseButton {\n    color: rgb(219, 219, 177)\n}\n\n.ViewContainer {\n    background-color: #f7f5f3;\n    border: solid 1px gray;\n}",""]);const l=r},6750:(e,t,n)=>{"use strict";n.d(t,{Z:()=>s});var i=n(66395),r=n(31397),l=n(15891),a=n(69297),o=n.n(a);const s=e=>o().createElement(i.Z,{TransitionProps:{unmountOnExit:void 0===e.unmountOnExit||e.unmountOnExit},defaultExpanded:e.defaultExpanded},o().createElement(r.Z,null,e.icon&&o().createElement("span",{style:{paddingRight:10}},e.icon),o().createElement("span",{style:{paddingTop:3}},e.label)),o().createElement(l.Z,null,o().createElement("div",{style:{width:"100%"}},e.children)))},3527:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(69297),r=n.n(i),l=n(31315),a=n.n(l);const o=e=>{var t,n,l;const{width:o,height:s,initialPosition:c,onChange:d,adjustable:g=!0,positionFromRight:u=!1}=e,[p,b]=(0,i.useState)(c);if(!e.children)throw Error("Unexpected: no props.children");let m,h;if(Array.isArray(e.children)){const t=e.children.filter((e=>void 0!==e));m=t[0],h=t[1]||null}else m=e.children,h=null;if(!h)return r().createElement(m.type,Object.assign({},m.props,{width:o,height:s}));const f=u?o-p:p,y=g?null!==(t=e.gripThickness)&&void 0!==t?t:10:0,w=g?null!==(n=e.gripInnerThickness)&&void 0!==n?n:4:0,E=g?null!==(l=e.gripMargin)&&void 0!==l?l:2:0,v=f-y/2-E,j=o-v-y-2*E;let S={top:0,left:0,width:o,height:s},O={left:0,top:0,width:v,height:s,zIndex:0,overflowY:"auto",overflowX:"hidden"},C={left:v+y+2*E,top:0,width:j,height:s,zIndex:0,overflowY:"auto",overflowX:"hidden"},k={left:0,top:0,width:y+2*E,height:s,backgroundColor:"transparent",cursor:"col-resize",zIndex:9998},I={left:E,top:0,width:y,height:s,background:"rgb(230, 230, 230)",cursor:"col-resize"},V={top:0,left:(y-w)/2,width:w,height:s,background:"gray",cursor:"col-resize"};return r().createElement("div",{className:"splitter",style:Object.assign(Object.assign({},S),{position:"relative"})},r().createElement("div",{key:"child1",style:Object.assign(Object.assign({},O),{position:"absolute"}),className:"SplitterChild"},r().createElement(m.type,Object.assign({},m.props,{width:v,height:s}))),g&&r().createElement(a(),{key:"drag",position:{x:f-y/2-E,y:0},axis:"x",onDrag:(e,t)=>{},onStop:(e,t)=>((e,t)=>{const n=t.x;if(n===f)return;const i=u?o-n:n;b(i),d&&d(i)})(0,t)},r().createElement("div",{style:Object.assign(Object.assign({},k),{position:"absolute"})},r().createElement("div",{style:Object.assign(Object.assign({},I),{position:"absolute"})},r().createElement("div",{style:Object.assign(Object.assign({},V),{position:"absolute"})})))),r().createElement("div",{key:"child2",style:Object.assign(Object.assign({},C),{position:"absolute"}),className:"SplitterChild"},r().createElement(h.type,Object.assign({},h.props,{width:j,height:s}))))}},10051:(e,t,n)=>{"use strict";n.d(t,{D:()=>l,h:()=>a});var i=n(5443),r=n(69297);const l=(e,t)=>{const{result:n}=(0,i.lG)(e?"createjob_get_sorting_info":"",{sorting_object:e,recording_object:t},{useClientCache:!0});return n},a=e=>{const t=(0,r.useContext)(i.Zo),n=(0,r.useRef)({}),[,l]=(0,r.useState)(0),a={};return e.forEach((e=>{const i=e.sortingId;if(!n.current[i]){const r=t.createHitherJob("createjob_get_sorting_info",{recording_object:e.recordingObject,sorting_object:e.sortingObject},{useClientCache:!0});n.current[i]=r,r.wait().then((()=>{l((e=>e+1))})).catch((()=>{l((e=>e+1))}))}n.current[i].result&&(a[i]=n.current[i].result)})),a}},62645:(e,t,n)=>{"use strict";n.r(t),n.d(t,{activate:()=>be});var i=n(81459),r=n(5443),l=n(69297),a=n.n(l),o=n(6750),s=n(95849);const c=e=>{const t=(0,r._m)().filter((e=>"MVSortingUnitView"!==e.name)),n=(0,s.fB)(t);return a().createElement(l.Fragment,null,a().createElement(i.Z,{container:!0,style:{flexFlow:"wrap"},spacing:0},n.filter((e=>!e.fullWidth)).map((n=>a().createElement(i.Z,{item:!0,key:n.name},a().createElement(n.component,Object.assign({},Object.assign(Object.assign({},e),{plugins:t}),{width:400,height:400})))))),a().createElement(i.Z,{container:!0,style:{flexFlow:"column"},spacing:0},n.filter((e=>e.fullWidth)).map((n=>a().createElement(i.Z,{item:!0,key:n.name},a().createElement(o.Z,{defaultExpanded:n.defaultExpanded,label:n.label},a().createElement(n.component,Object.assign({},Object.assign(Object.assign({},e),{plugins:t}),{width:e.width,height:400}))))))))};var d=n(43640),g=n(4606),u=n(66968),p=n(2057),b=n(55205),m=n(6269),h=n(97183),f=n(3527),y=n(93379),w=n.n(y),E=n(54537);w()(E.Z,{insert:"head",singleton:!1}),E.Z.locals;var v=n(1845),j=n(12930),S=n(3280),O=n.n(S);const C={paddingTop:3,paddingBottom:3,border:1,borderStyle:"solid",borderColor:"gray"},k=({label:e,partial:t,onClick:n})=>{const i=t?"gray":"black";return a().createElement("button",{style:Object.assign(Object.assign({},C),{color:i}),onClick:n},e)},I=O()()((({sortingId:e,selection:t,selectionDispatch:n,curation:r,curationDispatch:o,size:s})=>{const c=s.width||300,d=(0,l.useMemo)((()=>t.selectedUnitIds||[]),[t.selectedUnitIds]),g=(0,l.useCallback)((t=>{for(let n of d)o({type:"ADD_UNIT_LABEL",sortingId:e,unitId:n,label:t})}),[o,d,e]),u=(0,l.useCallback)((t=>{for(let n of d)o({type:"REMOVE_UNIT_LABEL",sortingId:e,unitId:n,label:t})}),[o,d,e]),p=(0,l.useCallback)((()=>{o({type:"MERGE_UNITS",sortingId:e,unitIds:d})}),[o,d,e]),b=(0,l.useCallback)((()=>{o({type:"UNMERGE_UNITS",sortingId:e,unitIds:d})}),[o,d,e]),m=(0,l.useCallback)((()=>{n({type:"ToggleApplyMerges",curation:r})}),[n,r]),h={};for(const e of d){const t=(r.labelsByUnit||{})[e+""]||[];for(const e of t){let t=h[e]||0;t++,h[e]=t}}const f=Object.keys(h).sort().map((e=>({label:e,partial:h[e]<d.length}))),y={marginTop:25,marginBottom:25,backgroundColor:"#f9f9ff"},w=d.length>0,E=["accept","reject","noise","artifact","mua"],S=[...E,...(r.labelChoices||[]).filter((e=>!E.includes(e)))];return a().createElement("div",{style:{width:c,position:"relative"}},a().createElement(v.Z,{style:y,key:"selected"},"Selected units: ",d.join(", ")),a().createElement(v.Z,{style:y,key:"labels"},"Labels:",a().createElement(i.Z,{container:!0,style:{flexFlow:"wrap"},spacing:0},f.map((e=>a().createElement(i.Z,{item:!0,key:e.label},a().createElement(k,{label:e.label,partial:e.partial,onClick:()=>{e.partial?g(e.label):u(e.label)}})))))),a().createElement(v.Z,{style:y,key:"apply"},"Apply labels:",a().createElement(i.Z,{container:!0,style:{flexFlow:"wrap"},spacing:0},S.map((e=>a().createElement(i.Z,{item:!0,key:e},(h[e]||0)<d.length||!w?a().createElement("button",{style:C,disabled:!w,onClick:()=>{g(e)}},e):a().createElement("span",null)))))),a().createElement(v.Z,{style:y,key:"merge"},"Merge:",d.length>=2&&a().createElement("button",{key:"merge",onClick:p},"Merge selected units: ",d.join(", ")),d.length>0&&(e=>{const t=(r.mergeGroups||[]).reduce(((e,t)=>[...e,...t]),[]);for(let n of e)if(!t.includes(n))return!1;return!0})(d)&&a().createElement("button",{key:"unmerge",onClick:b},"Unmerge units: ",d.join(", ")),a().createElement("span",{style:{whiteSpace:"nowrap"}},a().createElement(j.Z,{checked:t.applyMerges||!1,onClick:m})," Apply merges")))})),V=({selection:e,selectionDispatch:t})=>{const n=e.waveformsMode||"geom",i="geom"===n,r=(0,l.useCallback)((()=>{t({type:"SetWaveformsMode",waveformsMode:"geom"===n?"vertical":"geom"})}),[n,t]);return a().createElement("div",null,a().createElement("span",null,"Waveforms:"),a().createElement("span",{style:{whiteSpace:"nowrap"}},a().createElement(j.Z,{checked:i,onClick:r})," Use electrode geom"))},x=({selection:e,selectionDispatch:t})=>a().createElement("div",null,a().createElement(V,{selection:e,selectionDispatch:t}));const _=(0,r.zy)({maxSimultaneous:6}),Z=({width:e,height:t,block:n,message:i})=>n?a().createElement("div",{className:"BlockInteraction",style:{position:"absolute",width:e,height:t,backgroundColor:"gray",opacity:.5,zIndex:99999}},a().createElement("div",{style:{backgroundColor:"blue",color:"white",fontSize:20}},i)):a().createElement("div",{className:"BlockInteraction"}),U=({recording:e,sorting:t,children:n,width:i,height:o})=>{const s=(0,l.useContext)(r.Zo),c=t.sortingObject,d=e.recordingObject,[g,u]=(0,l.useState)(null),[p,b]=(0,l.useState)("waiting"),[m,h]=(0,l.useState)(""),f=(0,l.useRef)({sortingObject:t.sortingObject,recordingObject:e.recordingObject}),y=(0,l.useMemo)((()=>e=>f.current.sortingObject===e.sortingObject&&f.current.recordingObject===e.recordingObject),[]);(0,l.useEffect)((()=>{var e,t,n,i;"waiting"===p?(f.current={recordingObject:d,sortingObject:c},b("running"),e=void 0,t=void 0,i=function*(){try{h("Checking sorting data...");const e=yield s.createHitherJob("preload_check_sorting_downloaded",{sorting_object:c},{useClientCache:!1,calculationPool:_}).wait();if(!y({recordingObject:d,sortingObject:c}))return;if(!e.isLocal){h("Downloading sorting...");const e=yield s.createHitherJob("preload_download_sorting",{sorting_object:c},{useClientCache:!1,calculationPool:_}).wait();if(!y({recordingObject:d,sortingObject:c}))return;if(!e.success)return void u(new Error("Unable to download sorting."))}h("Checking recording data...");const t=yield s.createHitherJob("preload_check_recording_downloaded",{recording_object:d},{useClientCache:!1,calculationPool:_}).wait();if(!y({recordingObject:d,sortingObject:c}))return;if(!t.isLocal){h("Downloading recording...");const e=yield s.createHitherJob("preload_download_recording",{recording_object:d},{useClientCache:!1,calculationPool:_}).wait();if(!y({recordingObject:d,sortingObject:c}))return;if(!e.success)return void u(new Error("Unable to download recording."))}h("Extracting snippets...");const n=yield s.createHitherJob("preload_extract_snippets",{recording_object:d,sorting_object:c},{useClientCache:!1,calculationPool:_}).wait();if(!y({recordingObject:d,sortingObject:c}))return;if(!n)return void u(new Error("Problem extracting snippets"));b("finished")}catch(e){u(e)}},new((n=void 0)||(n=Promise))((function(r,l){function a(e){try{s(i.next(e))}catch(e){l(e)}}function o(e){try{s(i.throw(e))}catch(e){l(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}s((i=i.apply(e,t||[])).next())}))):y({recordingObject:d,sortingObject:c})||b("waiting")}),[c,d,p,y,s]);const w=(0,l.useMemo)((()=>a().cloneElement(n,{preloadStatus:p})),[n,p]),[E,v]=(0,l.useState)(null);return(0,l.useEffect)((()=>{"finished"===p&&y({recordingObject:d,sortingObject:c})&&v(w)}),[w,p,d,c,y]),a().createElement(l.Fragment,null,a().createElement(Z,Object.assign({block:"finished"!==p},{width:i,height:o},{message:g?`Error: ${g.message}`:m})),E||w)};var T=n(55170),M=n(89490);const D=(e,t)=>"SetPreprocessingSelection"===t.type?t.preprocessingSelection:e,B=[{preprocessingSelection:{filterType:"none"},label:"No filter"},{preprocessingSelection:{filterType:"bandpass_filter"},label:"Bandpass filter"}],R=O()()((({preprocessingSelection:e,preprocessingSelectionDispatch:t})=>{const n=(0,l.useCallback)((e=>{var n;t({type:"SetPreprocessingSelection",preprocessingSelection:(n=e.target.value,B.filter((e=>e.preprocessingSelection.filterType===n))[0].preprocessingSelection)})}),[t]);return a().createElement(T.Z,{value:e.filterType,onChange:n},B.map((e=>a().createElement(M.Z,{key:e.preprocessingSelection.filterType,value:e.preprocessingSelection.filterType},e.label))))}));var A=n(31315),P=n.n(A),F=n(27142),N=n(39110),L=n(51956),z=n(33569),G=n(19876);const H=({view:e,onClose:t,opts:n,onClick:i})=>{const r=(0,l.useMemo)((()=>e.plugin.icon||a().createElement(z.Z,null)),[e.plugin.icon]),o=(0,l.useCallback)((()=>{i(e)}),[i,e]),s=a().createElement("div",{style:{whiteSpace:"nowrap"},draggable:!0,onDragStart:t=>{t.dataTransfer.setData("viewId",e.viewId)},onClick:o},a().createElement(r.type,Object.assign({},r.props,{style:{paddingRight:5,paddingLeft:3,paddingTop:0,width:20,height:20,display:"inline",verticalAlign:"middle"}})),a().createElement("span",{style:{display:"inline",verticalAlign:"middle"}},e.label),a().createElement("span",null," "),a().createElement(N.Z,{component:"div",onClick:()=>t(e),className:"CloseButton",style:{padding:0}},a().createElement(G.Z,{style:{display:"inline",verticalAlign:"middle",fontSize:20}}))),c=(0,l.useMemo)((()=>n.selected?{color:"white",fontWeight:"bold"}:{color:"lightgray"}),[n.selected]);return a().createElement(L.Z,{key:e.viewId,label:s,className:"Tab",style:c})},W=({views:e,currentView:t,onCurrentViewChanged:n,onViewClosed:i,active:r})=>{(0,l.useEffect)((()=>{(t?e.indexOf(t):-1)<0&&e.length>0&&n(e[0])}),[t,n,e]);const o=(0,l.useCallback)((e=>{n(e)}),[n]);let s=t?e.indexOf(t):null;-1===s&&(s=null);const c=["ViewContainerTabBar"];r&&c.push("active");const d=(0,l.useMemo)((()=>e.map(((e,t)=>({selected:t===(s||0)})))),[e,s]);return a().createElement(F.Z,{value:s||0,scrollButtons:"auto",variant:"scrollable",className:c.join(" ")},e.map(((e,t)=>a().createElement(H,{key:t,view:e,onClick:o,onClose:i,opts:d[t]}))))},J=35,q=({onDelta:e,width:t,height:n})=>{const i=(0,l.useCallback)(((e,t)=>{}),[]),r=(0,l.useCallback)(((t,n)=>{const i=n.y;e(i)}),[e]);return a().createElement(P(),{key:"drag",position:{x:0,y:0},axis:"y",onDrag:i,onStop:r},a().createElement("div",{style:{position:"absolute",width:t,height:n,backgroundColor:"white",cursor:"row-resize"}},a().createElement("div",{style:{position:"absolute",width:t,top:(n-4)/2,height:4,backgroundColor:"gray"}})))},X=e=>{const t=e.currentTarget;return[e.clientX-t.getBoundingClientRect().x,e.clientY-t.getBoundingClientRect().y]},Y=({children:e,views:t,onViewClosed:n,onSetViewArea:i,width:r,height:o})=>{const[s,c]=(0,l.useState)(null),[d,g]=(0,l.useState)(null),[u,p]=(0,l.useState)("north"),[b,m]=(0,l.useState)(.5);(0,l.useEffect)((()=>{t.forEach((e=>{e.area||(e.area=u),e.activate&&(e.activate=!1,"north"===e.area?(c(e),p("north")):"south"===e.area&&(g(e),p("south")))}))}),[t,u]);const h=(r||300)-6,f=o-6,y=f-70-16,w=y*b,E=y*(1-b),v=(0,l.useCallback)((e=>{m((w+e)/(w+E))}),[m,w,E]),j={north:{tabBarStyle:{left:0,top:0,width:h,height:J},divStyle:{left:0,top:J,width:h,height:w}},south:{tabBarStyle:{left:0,top:J+w+16,width:h,height:J},divStyle:{left:0,top:70+w+16,width:h,height:E}}},S={left:0,top:J+w,width:h,height:16},O=(0,l.useCallback)((e=>{const t=X(e)[1]<J+w?"north":"south";t!==u&&p(t)}),[w,u,p]),C=(0,l.useCallback)((e=>{e.stopPropagation(),e.preventDefault()}),[]),k=(0,l.useCallback)((e=>{const n=X(e)[1]<J+w?"north":"south",r=e.dataTransfer.getData("viewId");if(r){const e=t.filter((e=>e.viewId===r))[0];e&&e.area!==n&&i(e,n)}}),[t,w,i]);if(!Array.isArray(e))throw Error("Unexpected children in ViewContainer");const I=e;return a().createElement("div",{style:{position:"absolute",left:3,top:3,width:h,height:f},onClick:O,onDragOver:C,onDrop:k,className:"ViewContainer"},a().createElement("div",{key:"north-tab-bar",style:Object.assign({position:"absolute"},j.north.tabBarStyle)},a().createElement(W,{views:t.filter((e=>"north"===e.area)),currentView:s,onCurrentViewChanged:c,onViewClosed:n,active:"north"===u})),a().createElement("div",{key:"south-tab-bar",style:Object.assign({position:"absolute"},j.south.tabBarStyle)},a().createElement(W,{views:t.filter((e=>"south"===e.area)),currentView:d,onCurrentViewChanged:g,onViewClosed:n,active:"south"===u})),a().createElement("div",{key:"splitter",style:Object.assign(Object.assign({position:"absolute"},S),{zIndex:9998})},a().createElement(q,{onDelta:v,width:h,height:16})),I.map((e=>{const t=e.props.view,n="north"===t.area&&t===s||"south"===t.area&&t===d,i=j[t.area||"north"];return a().createElement("div",{key:t.viewId,style:Object.assign({visibility:n?"visible":"hidden",overflowY:"auto",overflowX:"hidden",position:"absolute"},i.divStyle)},a().createElement(e.type,Object.assign({},e.props,{width:h,height:i.divStyle.height})))})))};var $=n(54514);const K={fontSize:12,padding:4,margin:1},Q=({plugin:e,onLaunch:t})=>{const n=(0,l.useCallback)((()=>{t(e)}),[t,e]);return a().createElement("button",{onClick:n,style:K},e.icon&&a().createElement(e.icon.type,Object.assign({},e.icon.props,{style:{height:14,width:14,paddingRight:2,paddingTop:0}})),e.label)},ee=({plugin:e,unitId:t,label:n,onLaunch:i})=>{const r=(0,l.useCallback)((()=>{i(e,t,n)}),[i,e,t,n]);return a().createElement("button",{onClick:r,style:K},e.icon&&a().createElement("span",{style:{paddingRight:5}},e.icon),n)},te=({onLaunchSortingView:e,onLaunchSortingUnitView:t,selection:n})=>{const i=(0,r._m)(),o=(0,s.fB)(i).filter((e=>"MVSortingUnitView"===e.name))[0];return a().createElement(l.Fragment,null,a().createElement("div",{key:"sortingViews",style:{flexFlow:"wrap"}},(0,$.Z)((0,s.Sd)(i)).filter((e=>"MVSortingView"!==e.name)).map((t=>a().createElement(Q,{key:t.name,plugin:t,onLaunch:e})))),a().createElement("div",{key:"view-single-unit"},o&&(n.selectedUnitIds||[]).map((e=>a().createElement(ee,{key:"unit-"+e,plugin:o,unitId:e,label:`Unit ${e}`,onLaunch:t})))))},ne=({view:e,sortingViewProps:t,width:n,height:i})=>{const r=e.plugin.component;let l={};return n&&(l.width=n),i&&(l.height=i),a().createElement(r,Object.assign({},t,l,e.extraProps))};var ie=n(7801),re=n(95898);const le=({recordingInfo:e,selection:t,selectionDispatch:n})=>{const[i,r]=(0,l.useState)("all"),[o,s]=(0,l.useState)([]),{selectedElectrodeIds:c}=t,d=(0,l.useCallback)((()=>{r("all")}),[r]),g=(0,l.useCallback)((()=>{r("custom")}),[r]);(0,l.useEffect)((()=>{const t=((null==e?void 0:e.channel_ids)||[]).filter((e=>(e=>{switch(i){case"all":return!0;case"custom":return o.includes(e);default:throw Error("Unexpected mode")}})(e)));n({type:"SetVisibleElectrodeIds",visibleElectrodeIds:t})}),[e,n,i,o]);const u=(0,l.useCallback)((()=>{r("custom"),s(c||[])}),[c,r,s]),p=(0,l.useMemo)((()=>(c||[]).length>0),[c]);return a().createElement("div",null,a().createElement("span",{style:{whiteSpace:"nowrap"}},a().createElement(ie.Z,{checked:"all"===i,onClick:d})," Show all"),a().createElement("span",{style:{whiteSpace:"nowrap"}},a().createElement(ie.Z,{checked:"custom"===i,onClick:g})," Show custom"),a().createElement(re.Z,{disabled:!p,onClick:u},"Restrict to selected"))};var ae=n(10051);const oe=(e,t)=>((t.curation||{}).labelsByUnit||{})[e]||[],se=({sorting:e,recording:t,selection:n,selectionDispatch:i})=>{const o=(0,ae.D)(e.sortingObject,e.recordingObject),[s,c]=(0,l.useState)(!1),[d,g]=(0,l.useState)(!1),[u,p]=(0,l.useState)(!0),b=n.visibleElectrodeIds,{result:m}=(0,r.lG)("createjob_get_peak_channels",{sorting_object:e.sortingObject,recording_object:t.recordingObject},{useClientCache:!0}),h=(0,l.useCallback)((()=>{g(!d)}),[d]),f=(0,l.useCallback)((()=>{c(!s)}),[s]),y=(0,l.useCallback)((()=>{p(!u)}),[u]);return(0,l.useEffect)((()=>{const t=((null==o?void 0:o.unit_ids)||[]).filter((t=>(t=>{if(u&&b&&m){const e=m[t+""];if(!b.includes(e))return!1}return d?oe(t,e).includes("accept"):!s||!oe(t,e).includes("reject")})(t)));i({type:"SetVisibleUnitIds",visibleUnitIds:t})}),[e,i,o,d,s,u,b,m]),a().createElement("div",null,a().createElement("span",{style:{whiteSpace:"nowrap"}},a().createElement(j.Z,{checked:d,onClick:h})," Show accepted only"),a().createElement("span",{style:{whiteSpace:"nowrap"}},a().createElement(j.Z,{checked:s,onClick:f,disabled:d})," Hide rejected"),a().createElement("span",{style:{whiteSpace:"nowrap"}},a().createElement(j.Z,{checked:u,onClick:y,disabled:!b})," Restrict to visible electrodes"))};class ce{constructor(e,t,n,i){this.plugin=e,this.extraProps=t,this.label=n,this.viewId=i,this.activate=!1,this.area=""}}let de=0;const ge=(e,t)=>{if("AddView"===t.type){const n=t.plugin;if(n.singleton)for(let t of e)if(t.plugin.name===n.name)return t.activate=!0,[...e];de++;const i=new ce(n,t.extraProps||{},t.label,de+"");return i.activate=!0,i.area=t.area,[...e,i].sort(((e,t)=>e.plugin.label>t.plugin.label?1:e.plugin.label<t.plugin.label?-1:0))}return"CloseView"===t.type?e.filter((e=>e!==t.view)):"SetViewArea"===t.type?e.map((e=>e.viewId===t.viewId?Object.assign(Object.assign({},e),{area:t.area,activate:!0}):e)):e},ue=e=>{const{recording:t,sorting:n,recordingInfo:i,selection:c,selectionDispatch:y,preloadStatus:w,preprocessingSelection:E,preprocessingSelectionDispatch:v,curationDispatch:j}=e,[S,O]=(0,l.useReducer)(ge,[]),[C,k]=(0,l.useState)(!1),V=(0,r._m)(),_=(0,s.Sd)(V).filter((e=>"UnitsTable"===e.name))[0],Z=(0,s.Sd)(V).filter((e=>"AverageWaveforms"===e.name))[0],U=(0,l.useMemo)((()=>[{plugin:_,area:"north"},{plugin:Z,area:"south"}].filter((e=>void 0!==e.plugin))),[_,Z]);(0,l.useEffect)((()=>{"finished"!==w||0!==S.length||C||(k(!0),U.forEach((e=>{})))}),[w,C,U,S.length]);const T=(0,l.useCallback)((e=>{O({type:"AddView",plugin:e,label:e.label,area:""})}),[O]),M=(0,l.useCallback)(((e,t,n)=>{O({type:"AddView",plugin:e,label:n,area:"",extraProps:{unitId:t}})}),[O]),D=(0,l.useCallback)((e=>{O({type:"CloseView",view:e})}),[O]),B=(0,l.useCallback)(((e,t)=>{O({type:"SetViewArea",viewId:e.viewId,area:t})}),[O]),A=e.width||600,P=e.height||900,F=a().createElement("span",{style:{color:"gray"}},a().createElement(u.Z,null)),N=a().createElement("span",{style:{color:"gray"}},a().createElement(p.Z,null)),L=a().createElement("span",{style:{color:"gray"}},a().createElement(m.Z,null)),z=a().createElement("span",{style:{color:"gray"}},a().createElement(h.Z,null)),G=a().createElement("span",{style:{color:"gray"}},a().createElement(g.G,{icon:d.UJf})),H=a().createElement("span",{style:{color:"gray"}},a().createElement(b.Z,null)),W=Object.assign({},e);return a().createElement("div",{className:"MVSortingView"},a().createElement(f.Z,{width:A,height:P,initialPosition:320},a().createElement("div",null,a().createElement(o.Z,{icon:z,label:"Open views",defaultExpanded:!0,unmountOnExit:!1},a().createElement(te,{onLaunchSortingView:T,onLaunchSortingUnitView:M,selection:e.selection})),a().createElement(o.Z,{icon:N,label:"Visible units",defaultExpanded:!1,unmountOnExit:!1},a().createElement(se,{sorting:n,recording:t,selection:c,selectionDispatch:y})),a().createElement(o.Z,{icon:L,label:"Visible electrodes",defaultExpanded:!1,unmountOnExit:!1},a().createElement(le,{recordingInfo:i,selection:c,selectionDispatch:y})),a().createElement(o.Z,{icon:F,label:"Preprocessing",defaultExpanded:!1,unmountOnExit:!1},a().createElement(R,{preprocessingSelection:E,preprocessingSelectionDispatch:v})),j&&a().createElement(o.Z,{icon:G,label:"Curation",defaultExpanded:!1,unmountOnExit:!1},a().createElement(I,{sortingId:n.sortingId,curation:e.sorting.curation||{},curationDispatch:j,selection:e.selection,selectionDispatch:e.selectionDispatch})),a().createElement(o.Z,{icon:H,label:"Options",defaultExpanded:!1,unmountOnExit:!1},a().createElement(x,{selection:c,selectionDispatch:y}))),a().createElement(Y,{onViewClosed:D,onSetViewArea:B,views:S,width:0,height:0},S.map((e=>a().createElement(ne,{key:e.viewId,view:e,sortingViewProps:W}))))))},pe=e=>{const{recording:t,sorting:n}=e,[i,r]=(0,l.useReducer)(D,{filterType:"none"}),o=(0,l.useMemo)((()=>{if(!t)return t;if("none"===i.filterType)return t;if("bandpass_filter"===i.filterType)return Object.assign(Object.assign({},t),{recordingObject:{recording_format:"filtered",data:{filters:[{type:"bandpass_filter",freq_min:300,freq_max:3e3,freq_wid:1e3}],recording:t.recordingObject}}});throw Error(`Unexpected filter type: ${i.filterType}`)}),[t,i]);return a().createElement(U,{recording:o,sorting:n,width:e.width||0,height:e.height||0},a().createElement(ue,Object.assign({},e,{preprocessingSelection:i,preprocessingSelectionDispatch:r},{recording:o})))};function be(e){e.registerPlugin({type:"SortingView",name:"MVSortingView",label:"MVSortingView",priority:5e3,defaultExpanded:!0,notebookCellHeight:800,component:pe}),e.registerPlugin({type:"SortingUnitView",name:"MVSortingUnitView",label:"MV sorting unit view",component:c})}},95849:(e,t,n)=>{"use strict";n.d(t,{kN:()=>c,qG:()=>p,GI:()=>d,CC:()=>s,Zl:()=>a,_S:()=>m,SF:()=>g,fG:()=>f,fB:()=>h,Sd:()=>b,FO:()=>y});var i=n(5443),r=n(69297);const l=(e,t)=>{if(e.min<=t&&t<e.max)return e;const n=e.max-e.min,i=Math.max(0,Math.floor(t-n/2));return{min:i,max:i+n}},a=(e,t)=>{var n,i,r,a;if("SetRecordingSelection"===t.type)return Object.assign({},t.recordingSelection);if("SetSelectedElectrodeIds"===t.type)return Object.assign(Object.assign({},e),{selectedElectrodeIds:t.selectedElectrodeIds.filter((t=>!e.visibleElectrodeIds||e.visibleElectrodeIds.includes(t)))});if("SetVisibleElectrodeIds"===t.type)return Object.assign(Object.assign({},e),{visibleElectrodeIds:t.visibleElectrodeIds,selectedElectrodeIds:e.selectedElectrodeIds?e.selectedElectrodeIds.filter((e=>t.visibleElectrodeIds.includes(e))):void 0});if("SetCurrentTimepoint"===t.type)return Object.assign(Object.assign({},e),{currentTimepoint:t.currentTimepoint||void 0,timeRange:t.ensureInRange&&e.timeRange&&null!==t.currentTimepoint?l(e.timeRange,t.currentTimepoint):e.timeRange});if("SetTimeRange"===t.type)return Object.assign(Object.assign({},e),{timeRange:t.timeRange});if("ZoomTimeRange"===t.type){const r=9e6,l=e.currentTimepoint,a=e.timeRange;if(!a)return e;const s=null!==(n=t.direction)&&void 0!==n?n:"in",c=null!==(i=t.factor)&&void 0!==i?i:1.4,d="out"===s?1/c:c;if((a.max-a.min)/d>r)return e;let g;g=void 0===l||l<a.min?a.min:l>a.max?a.max:l;const u=o(a,d,g);return Object.assign(Object.assign({},e),{timeRange:u})}if("SetAmpScaleFactor"===t.type)return Object.assign(Object.assign({},e),{ampScaleFactor:t.ampScaleFactor});if("ScaleAmpScaleFactor"===t.type){const n=null!==(r=t.direction)&&void 0!==r?r:"up",i=null!==(a=t.multiplier)&&void 0!==a?a:1.4,l="down"===n?1/i:i;return Object.assign(Object.assign({},e),{ampScaleFactor:(e.ampScaleFactor||1)*l})}return"SetCurrentTimepointVelocity"===t.type?Object.assign(Object.assign({},e),{animation:Object.assign(Object.assign({},e.animation||{}),{currentTimepointVelocity:t.velocity})}):"SetWaveformsMode"===t.type?Object.assign(Object.assign({},e),{waveformsMode:t.waveformsMode}):"Set"===t.type?t.state:e},o=(e,t,n)=>{const i=n+(e.min-n)/t,r=n+(e.max-n)/t;return{min:Math.floor(i),max:Math.floor(r)}},s=(e,t)=>((t||{}).mergeGroups||[]).filter((t=>t.includes(e)))[0]||null,c=(e,t,n)=>n&&s(e,t)||e,d=(e,t)=>{const n=s(e,t);return!n||Math.min(...n)===e},g=(e,t)=>"SetSelection"===t.type?t.selection:"SetSelectedUnitIds"===t.type?Object.assign(Object.assign({},e),{selectedUnitIds:t.selectedUnitIds.filter((t=>{var n;return!e.visibleUnitIds||(null===(n=e.visibleUnitIds)||void 0===n?void 0:n.includes(t))}))}):"SetVisibleUnitIds"===t.type?Object.assign(Object.assign({},e),{selectedUnitIds:e.selectedUnitIds?e.selectedUnitIds.filter((e=>{var n;return null===(n=t.visibleUnitIds)||void 0===n?void 0:n.includes(e)})):void 0,visibleUnitIds:t.visibleUnitIds}):"UnitClicked"===t.type?((e,t)=>{const n=t.unitId;return t.ctrlKey?(e.selectedUnitIds||[]).includes(n)?Object.assign(Object.assign({},e),{selectedUnitIds:(e.selectedUnitIds||[]).filter((e=>e!==n))}):Object.assign(Object.assign({},e),{selectedUnitIds:[...e.selectedUnitIds||[],n]}):Object.assign(Object.assign({},e),{selectedUnitIds:[n]})})(e,t):"Set"===t.type?t.state:"ToggleApplyMerges"===t.type?u(Object.assign(Object.assign({},e),{applyMerges:!e.applyMerges}),t.curation):a(e,t),u=(e,t)=>e.applyMerges&&t?Object.assign(Object.assign({},e),{selectedUnitIds:e.selectedUnitIds?e.selectedUnitIds.filter((e=>d(e,t))):void 0}):e,p=e=>e.filter((e=>!e.disabled&&!e.development)),b=e=>p(e).filter((e=>"SortingView"===e.type)).map((e=>e)),m=e=>p(e).filter((e=>"RecordingView"===e.type)).map((e=>e)),h=e=>p(e).filter((e=>"SortingUnitView"===e.type)).map((e=>e)),f=e=>p(e).filter((e=>"SortingUnitMetric"===e.type)).map((e=>e)),y=()=>{const e=(0,i._m)();return(0,r.useMemo)((()=>e.filter((e=>"WorkspaceView"===e.type)).map((e=>e))),[e])}},54514:(e,t,n)=>{"use strict";n.d(t,{Z:()=>r});const i=e=>(e=>Array.isArray(e))(e)?e.sort(((e,t)=>e.priority===t.priority?(e.label||"")<(t.label||"")?-1:(e.label||"")>(t.label||"")?1:0:(t.priority||0)-(e.priority||0))):i(Object.values(e)),r=i}}]);