(self.webpackChunklabbox_ephys_widgets_jp=self.webpackChunklabbox_ephys_widgets_jp||[]).push([[327],{76827:(e,t,n)=>{"use strict";n.d(t,{Z:()=>c});var i=n(81410),o=n.n(i),a=n(56271);const l={data:{},activeFetches:{}},r=(e,t)=>{switch(t.type){case"clear":return l;case"startFetch":return Object.assign(Object.assign({},e),{activeFetches:Object.assign(Object.assign({},e.activeFetches),{[t.queryHash]:!0})});case"setData":return Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{[t.queryHash]:t.data}),activeFetches:Object.assign(Object.assign({},e.activeFetches),{[t.queryHash]:!1})});default:throw Error("Unexpected action in fetchCacheReducer")}},s=e=>o()(e),c=e=>{const[t,n]=(0,a.useState)(0);t<0&&console.info(t);const i=(0,a.useRef)(e),[o,c]=(0,a.useReducer)(r,l),d=(0,a.useRef)({});(0,a.useEffect)((()=>{e!==i.current&&(i.current=e,c({type:"clear"}))}),[e]);const u=(0,a.useMemo)((()=>e=>{const t=s(e),i=o.data[t];return void 0===i&&(d.current[t]=e,n((e=>e+1))),i}),[o.data]),m=(0,a.useMemo)((()=>t=>{const n=s(t);void 0===o.data[n]&&(o.activeFetches[n]||(c({type:"startFetch",queryHash:n}),e(t).then((e=>{c({type:"setData",queryHash:n,data:e})})).catch((e=>{console.warn(e),console.warn("Problem fetching data",t)}))))}),[o.data,o.activeFetches,e]);return(0,a.useEffect)((()=>{const e=Object.keys(d.current);if(0!==e.length){for(let t of e)m(d.current[t]);d.current={}}})),(0,a.useMemo)((()=>({get:u})),[u])}},40327:(e,t,n)=>{"use strict";n.r(t),n.d(t,{activate:()=>k});var i=n(56271),o=n.n(i),a=n(88493),l=n(37249),r=n(47033),s=n(4900),c=n.n(s),d=n(85155),u=n(45185),m=n(62341),g=n(76827),h=n(49287),p=n(87001);const b=({snippet:e,noiseLevel:t,samplingFrequency:n,electrodeIds:a,electrodeLocations:l,selection:r,selectionDispatch:s,width:d,height:u})=>{const[m,g]=(0,i.useState)(!1),h=(0,i.useCallback)((e=>{e&&!m&&g(!0)}),[m,g]),b=(null==e?void 0:e.timepoint)||0,f=r.currentTimepoint||0,y=(0,i.useMemo)((()=>Math.abs(b-f)<20),[b,f]),v=(0,i.useCallback)((()=>{e&&s({type:"SetCurrentTimepoint",currentTimepoint:e.timepoint})}),[e,s]);return o().createElement(c(),{onChange:h,partialVisibility:!0},m&&e?o().createElement("div",{className:y?"plotSelectedStyle":"",onClick:v},o().createElement(p.Z,Object.assign({waveform:e.waveform,layoutMode:r.waveformsMode||"geom"},{selection:r,selectionDispatch:s,noiseLevel:t,samplingFrequency:n,electrodeIds:a,electrodeLocations:l,width:d,height:u},{electrodeOpts:{disableSelection:!0}}))):o().createElement("div",{style:{position:"absolute",width:d,height:u}}))};var f=function(e,t,n,i){return new(n||(n=Promise))((function(o,a){function l(e){try{s(i.next(e))}catch(e){a(e)}}function r(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,r)}s((i=i.apply(e,t||[])).next())}))};const y=(0,u.createCalculationPool)({maxSimultaneous:6}),v=3e5,E=(e,t,n)=>{var i;return t&&n?Object.assign(Object.assign({},e),{waveform:null===(i=e.waveform)||void 0===i?void 0:i.filter(((e,i)=>n.includes(t[i])))}):e},w=({recording:e,sorting:t,selection:n,selectionDispatch:a,unitId:l,height:s,noiseLevel:c})=>{const{snippets:d,info:p}=(e=>{const t=(0,i.useContext)(u.HitherContext),{recording:n,sorting:o,selection:a,visibleElectrodeIds:l,unitId:r,timeRange:s}=e,c=(0,i.useMemo)((()=>e=>f(void 0,void 0,void 0,(function*(){switch(e.type){case"info":const n=(0,h.kN)(e.unitId,o.curation,a.applyMerges);return yield(e=>f(void 0,void 0,void 0,(function*(){const{recording:t,sorting:n,unitId:i,hither:o}=e,a=yield o.createHitherJob("createjob_get_sorting_unit_info",{recording_object:t.recordingObject,sorting_object:n.sortingObject,unit_id:i},{useClientCache:!0,calculationPool:y}).wait();return{channel_ids:a.channel_ids,channel_locations:a.channel_locations,sampling_frequency:a.sampling_frequency}})))({recording:e.recording,sorting:e.sorting,unitId:n,hither:t});case"snippets":const i=(0,h.kN)(e.unitId,o.curation,a.applyMerges);return yield(e=>f(void 0,void 0,void 0,(function*(){const{recording:t,sorting:n,unitId:i,timeRange:o,hither:a}=e;return(yield a.createHitherJob("createjob_get_sorting_unit_snippets",{recording_object:t.recordingObject,sorting_object:n.sortingObject,unit_id:i,time_range:o,max_num_snippets:1e3},{useClientCache:!0,calculationPool:y}).wait()).snippets})))({recording:e.recording,sorting:e.sorting,unitId:i,timeRange:e.timeRange,hither:t})}}))),[t,o.curation,a.applyMerges]),d=(0,g.Z)(c);return(0,i.useMemo)((()=>{const e={type:"info",recording:n,sorting:o,unitId:r},t=d.get(e),i=((e,t)=>{const n=[];if(!e)return n;const i=Math.floor(e.min/v),o=Math.ceil(e.max/v);for(let e=i;e<=Math.min(o,i+t.maxNumSegments-1);e++)n.push({min:e*v,max:(e+1)*v});return n})(s,{maxNumSegments:6}).map((e=>{const t={type:"snippets",recording:n,sorting:o,unitId:r,timeRange:e};return d.get(t)})).reduce(((e,t)=>t?e.concat(t):e),[]).map((e=>E(e,null==t?void 0:t.channel_ids,l))),a=i?i.filter((e=>s&&s.min<=e.timepoint&&e.timepoint<s.max)):void 0;return{info:t?Object.assign(Object.assign({},t),{channel_ids:t.channel_ids.filter(((e,n)=>!l||l.includes(t.channel_ids[n]))),channel_locations:t.channel_locations.filter(((e,n)=>!l||l.includes(t.channel_ids[n])))}):void 0,snippets:a}}),[d,n,o,s,r,l])})({recording:e,sorting:t,selection:n,visibleElectrodeIds:n.visibleElectrodeIds,unitId:l,timeRange:n.timeRange||null}),w=null==p?void 0:p.channel_locations,_=(0,i.useMemo)((()=>{if("geom"===n.waveformsMode){const e=(w?(0,m.g)(w):1)||1;return e>1?s/e:s*e}return 100}),[w,s,n.waveformsMode]),C=(0,i.useMemo)((()=>({width:_+5,height:s+15})),[_,s]);return o().createElement(r.GridList,{style:{flexWrap:"nowrap",height:s+15}},p&&w&&d?d.length>0?d.map((e=>o().createElement(r.GridListTile,{key:e.timepoint,style:C},o().createElement(b,{snippet:e,noiseLevel:c,samplingFrequency:p.sampling_frequency,electrodeIds:p.channel_ids,electrodeLocations:w,selection:n,selectionDispatch:a,width:_,height:s})))):o().createElement(r.GridListTile,{style:Object.assign(Object.assign({},C),{width:500,color:"gray"})},o().createElement("div",null,"No snippets found in selected time range")):o().createElement(r.GridListTile,{style:Object.assign(Object.assign({},C),{width:180})},o().createElement("div",{style:{whiteSpace:"nowrap"}},"Retrieving snippets...")))},_=({width:e,height:t,children:n})=>{const[a,l]=(0,i.useState)(!1),r=(0,i.useCallback)((e=>{e&&!a&&l(!0)}),[a,l]);return a?o().createElement(i.Fragment,null,n):o().createElement(c(),{onChange:r,partialVisibility:!0},o().createElement("div",{className:"WhenVisible",style:{position:"absolute",width:e,height:t}},"Waiting for visible"))},C=({recording:e,sorting:t,selection:n,selectionDispatch:i,unitIds:a,width:l,height:s})=>{const c=((0,d.F0)(e.recordingObject)||{}).noise_level||1;return o().createElement("div",{style:{position:"absolute",width:l,height:s,overflow:"auto"}},o().createElement(r.Grid,{container:!0,direction:"column"},(a||[]).map((a=>o().createElement(r.Grid,{item:!0,key:a,style:{border:"solid 3px lightgray",marginBottom:2}},o().createElement("h3",{style:{paddingTop:0,paddingBottom:0,marginTop:10,marginBottom:10}},"Snippets for unit ",a),o().createElement(_,{width:l,height:250},o().createElement(w,Object.assign({},{recording:e,sorting:t,selection:n,selectionDispatch:i,unitId:a,height:250,noiseLevel:c}))))))))},I=({recording:e,sorting:t,selection:n,selectionDispatch:i,width:r,height:s})=>o().createElement(a.Z,{width:r||600,height:s||900,initialPosition:200},o().createElement(l.Z,{sorting:t,selection:n,selectionDispatch:i}),o().createElement(C,Object.assign({recording:e,sorting:t,selection:n,selectionDispatch:i,unitIds:n.selectedUnitIds||[]},{width:0,height:0})));function k(e){e.registerPlugin({type:"SortingView",name:"SnippetsView",label:"Snippets",priority:50,component:I})}},37249:(e,t,n)=>{"use strict";n.d(t,{Z:()=>s});var i=n(56271),o=n.n(i),a=n(65405),l=n(49287),r=n(96333);const s=({sorting:e,selection:t,selectionDispatch:n})=>{const i=(0,a.D)(e.sortingObject,e.recordingObject);if(!i)return o().createElement("div",null,"No sorting info");const s=((null==i?void 0:i.unit_ids)||[]).filter((n=>!t.applyMerges||(0,l.GI)(n,e.curation)));return o().createElement(r.Z,Object.assign({units:s},{selection:t,selectionDispatch:n,sorting:e}))}},96333:(e,t,n)=>{"use strict";n.d(t,{Z:()=>b});var i=n(56271),o=n.n(i),a=n(49287),l=n(36464),r=n(93379),s=n.n(r),c=n(97948);s()(c.Z,{insert:"head",singleton:!1}),c.Z.locals;var d=n(48003),u=n(9756),m=n(47033);const g=e=>{const{columns:t,onColumnClick:n,primarySortColumnDirection:i,primarySortColumnName:a,onDeselectAll:l}=e;return o().createElement(m.TableHead,null,o().createElement(m.TableRow,null,l?o().createElement(m.TableCell,{key:"_checkbox"},o().createElement(h,{rowId:"",selected:!1,onClick:()=>{l()},isDeselectAll:!0})):o().createElement(m.TableCell,{key:"_checkbox"}),t.map((e=>{const t=(e.tooltip||e.label||"")+" (click to sort)";return o().createElement(m.TableCell,{key:e.columnName,onClick:()=>n(e),title:t,style:{cursor:"pointer"}},o().createElement(m.Grid,{container:!0,justify:"flex-start",style:{flexFlow:"row"}},o().createElement(m.Grid,{item:!0,key:"icon"},o().createElement("span",{style:{fontSize:16,color:"gray",paddingLeft:3,paddingRight:5,paddingTop:2}},a===e.columnName&&("ascending"===i?o().createElement(u.FontAwesomeIcon,{icon:d.faCaretUp}):o().createElement(u.FontAwesomeIcon,{icon:d.faCaretDown})))),o().createElement(m.Grid,{item:!0,key:"text"},o().createElement("span",null,o().createElement("span",{key:"label"},e.label),o().createElement("span",{key:"progress"},e.calculating&&o().createElement(m.LinearProgress,null))))))}))))},h=o().memo((e=>{const{rowId:t,selected:n,onClick:i,isDeselectAll:a}=e;return o().createElement(m.Checkbox,{checked:n,indeterminate:!!a,onClick:()=>i(t),style:{padding:1},title:a?"Deselect all":`Select ${t}`})})),p=e=>{const{selectedRowIds:t,onSelectedRowIdsChanged:n,rows:a,columns:l,defaultSortColumnName:r,height:s}=e,[c,d]=(0,i.useState)([]);(0,i.useEffect)((()=>{0===c.length&&r&&d([r])}),[d,c,r]);const u=(0,i.useCallback)((e=>{const i=t.includes(e)?t.filter((t=>t!==e)):[...t,e];n(i)}),[t,n]),p=[...a],b=e=>l.filter((t=>t.columnName===e))[0],f=(e=>{const t=[];for(let n=0;n<e.length;n++){const i=e[n-1]!==e[n];t.push({columnName:e[n],keyOrder:n,sortAscending:i})}return t})(c);for(const e of f){const t=e.columnName,n=b(t);p.sort(((i,o)=>{const a=i.data[t]||{},l=o.data[t]||{},r=a.sortValue,s=l.sortValue;return e.sortAscending?n.sort(r,s):n.sort(s,r)}))}const y=(t||[]).reduce(((e,t)=>(e[t]=!0,e)),{}),v=f.length>0?f[f.length-1]:void 0,E=v?v.columnName:void 0,w=v?v.sortAscending?"ascending":"descending":void 0;return o().createElement(m.TableContainer,{style:void 0!==s?{maxHeight:s}:{}},o().createElement(m.Table,{stickyHeader:!0,className:"TableWidget"},o().createElement(g,{columns:l,primarySortColumnName:E,primarySortColumnDirection:w,onColumnClick:e=>{const t=e.columnName;let n=[...c];n=c[c.length-1]===t?c[c.length-2]===t?n.slice(0,n.length-1):[...n,t]:[...n.filter((e=>e!==t)),t],d(n)},onDeselectAll:t.length>0?()=>{n([])}:void 0}),o().createElement(m.TableBody,null,p.map((e=>{const t=y[e.rowId]||!1;return o().createElement(m.TableRow,{key:e.rowId},o().createElement(m.TableCell,{key:"_checkbox",className:t?"selectedRow":""},o().createElement(h,{rowId:e.rowId,selected:t,onClick:()=>u(e.rowId)})),l.map((n=>o().createElement(m.TableCell,{key:n.columnName,className:t?"selectedRow":""},o().createElement("div",{title:n.tooltip},n.dataElement(e.data[n.columnName].value))))))})))))},b=e=>{const{sortingUnitMetrics:t,units:n,metrics:r,selection:s,selectionDispatch:c,sorting:d,height:u}=e,m=(s||{}).selectedUnitIds||[],g=(0,l.Z)(Object.values(t||{})).filter((e=>!e.disabled)),h=(0,i.useCallback)((e=>{c({type:"SetSelectedUnitIds",selectedUnitIds:e.map((e=>Number(e)))})}),[c]),b=n.map((e=>({rowId:e+"",data:{}}))),f=(e,t)=>Number(e)-Number(t),y=e=>o().createElement("span",null,e+""),v={color:"black",fontWeight:"bold",cursor:"pointer"},E={color:"gray",textDecoration:"underline",cursor:"pointer"},w=[];w.push({columnName:"_unit_id",label:"Unit ID",tooltip:"Unit ID",sort:f,dataElement:e=>{const{unitId:t,mergeGroup:n}=e;return o().createElement("span",null,o().createElement("span",{key:"unitId",style:v},t+""),n&&n.length>0&&o().createElement("span",{key:"mergeGroup"},` (${n.map((e=>e+"")).join(", ")})`))}}),b.forEach((e=>{const t=Number(e.rowId);e.data._unit_id={value:{unitId:t,mergeGroup:(0,a.CC)(t,d.curation)},sortValue:t}})),w.push({columnName:"_labels",label:"Labels",tooltip:"Curation labels",sort:(e,t)=>e<t?-1:e>t?1:0,dataElement:e=>{const t=e;return o().createElement("span",null,t.map((e=>o().createElement("span",{key:e},o().createElement("span",{style:E},e)," "))))}}),b.forEach((e=>{const t=((e,t)=>((t.curation||{}).labelsByUnit||{})[e]||[])(Number(e.rowId),d);e.data._labels={value:t,sortValue:t.join(", ")}})),(d.externalUnitMetrics||[]).forEach((e=>{const t="external-metric-"+e.name;w.push({columnName:t,label:e.label,tooltip:e.tooltip||"",sort:f,dataElement:y}),b.forEach((n=>{const i=Number(n.rowId),o=e.data[i+""];n.data[t]={value:void 0!==o?o:NaN,sortValue:void 0!==o?o:NaN}}))})),g.forEach((e=>{const t="plugin-metric-"+e.name,n=(r||{})[e.name]||null,i=n?n.data:null;w.push({columnName:t,label:e.columnLabel,tooltip:e.tooltip||"",sort:f,dataElement:e.component,calculating:n&&!i}),b.forEach((n=>{const o=Number(n.rowId),a=i&&o+""in i?i[o+""]:void 0,l=void 0!==a?e.getValue(a):void 0;n.data[t]={value:a,sortValue:void 0!==l?l:e.isNumeric?NaN:""}}))}));const _=m.map((e=>e+""));return o().createElement(p,{rows:b,columns:w,selectedRowIds:_,onSelectedRowIdsChanged:h,defaultSortColumnName:"_unit_id",height:u})}},97948:(e,t,n)=>{"use strict";n.d(t,{Z:()=>a});var i=n(23645),o=n.n(i)()((function(e){return e[1]}));o.push([e.id,".TableWidget .MuiTableCell-root {\n    padding-top: 1px;\n    padding-bottom: 1px;\n    padding-left: 0px;\n    padding-right: 0px;\n    font-size: 12px;\n    border: solid 1px #f0f0f0;\n}\n\n.TableWidget .MuiTableCell-root.selectedRow {\n    background-color: #b5d1ff;\n}",""]);const a=o}}]);