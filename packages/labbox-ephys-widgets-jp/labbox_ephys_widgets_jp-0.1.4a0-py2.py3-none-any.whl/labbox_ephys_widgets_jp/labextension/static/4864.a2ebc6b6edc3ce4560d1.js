(self.webpackChunklabbox_ephys_widgets_jp=self.webpackChunklabbox_ephys_widgets_jp||[]).push([[4864],{63813:(t,e,n)=>{"use strict";n.d(e,{cz:()=>s,CP:()=>o});var i=n(7916),r=n(17872);class s{constructor(t,e,n,i){this._exportingFigure=!1,this._offscreenCanvas=null,this._context2D=t,this._primaryContext2D=t,this._pixelWidth=e,this._pixelHeight=n,this._transformMatrix=i}transform(t){try{const e=(0,r.bZ)((0,i.multiply)((0,i.matrix)(this._transformMatrix),(0,i.matrix)(t)));return new s(this._context2D,this._pixelWidth,this._pixelHeight,e)}catch(t){return console.warn("Problem transforming painter:",t),this}}useOffscreenCanvas(t,e){try{const n=new OffscreenCanvas(Math.max(t,10),Math.max(e,10));this._offscreenCanvas=n;const i=n.getContext("2d");if(!i)throw Error("Unexpected");this._context2D=i}catch(t){console.warn("Problem in useOffscreenCanvas",t)}}transferOffscreenToPrimary(){const t=this._offscreenCanvas;if(!t)return void console.warn("No offscreen canvas");const e=t.transferToImageBitmap();this._context2D=this._primaryContext2D,this._context2D.clearRect(0,0,e.width,e.height),this._context2D.drawImage(e,0,0)}getDefaultPen(){return{color:"black"}}getDefaultFont(){return{"pixel-size":12,family:"Arial"}}getDefaultBrush(){return{color:"black"}}createPainterPath(){return new o}setExportingFigure(t){this._exportingFigure=t}exportingFigure(){return this._exportingFigure}fillWholeCanvas(t){console.log(`Pixel dimensions: 0 to ${this._pixelWidth} and 0 to ${this._pixelHeight}`),this._context2D.save(),h(this._context2D,{color:t}),this._context2D.fillRect(0,0,this._pixelWidth,this._pixelHeight),this._context2D.restore()}clear(){this.clearRect({xmin:0,xmax:this._pixelWidth,ymin:0,ymax:this._pixelHeight})}clearRect(t){this.fillRect(t,{color:"transparent"})}ctxSave(){this._context2D.save()}ctxRestore(){this._context2D.restore()}wipe(){this._context2D.clearRect(0,0,this._pixelWidth,this._pixelHeight)}ctxTranslate(t,e){throw Error("Deprecated method, needs rewrite.")}ctxRotate(t){this._context2D.rotate(t)}fillRect(t,e){const n=(0,r.E4)(this._transformMatrix,t);this._context2D.save(),h(this._context2D,e),this._context2D.fillRect(Math.min(n.xmin,n.xmax),Math.min(n.ymin,n.ymax),(0,r.dz)(n),(0,r.Cr)(n)),this._context2D.restore()}drawRect(t,e){const n=(0,r.E4)(this._transformMatrix,t);this._context2D.save(),l(this._context2D,e),this._context2D.strokeRect(Math.min(n.xmin,n.xmax),Math.min(n.ymin,n.ymax),(0,r.dz)(n),(0,r.Cr)(n)),this._context2D.restore()}getEllipseFromBoundingRect(t){const e=(0,r.E4)(this._transformMatrix,t);return{center:(0,r.qg)(e),W:Math.abs((0,r.dz)(e)),H:Math.abs((0,r.Cr)(e))}}fillEllipse(t,e){const{center:n,W:i,H:r}=Object.assign({},this.getEllipseFromBoundingRect(t));this._context2D.fillStyle=a(e.color),this._context2D.beginPath(),this._context2D.ellipse(n[0],n[1],i/2,r/2,0,0,2*Math.PI),this._context2D.fill()}drawEllipse(t,e){const{center:n,W:i,H:r}=Object.assign({},this.getEllipseFromBoundingRect(t));this._context2D.save(),l(this._context2D,e),this._context2D.beginPath(),this._context2D.ellipse(n[0],n[1],i/2,r/2,0,0,2*Math.PI),this._context2D.stroke(),this._context2D.restore()}drawPath(t,e){this._context2D.save(),l(this._context2D,e),t._draw(this._context2D,this._transformMatrix),this._context2D.restore()}drawLine(t,e,n,i,r){const s=new o;s.moveTo(t,e),s.lineTo(n,i),this.drawPath(s,r)}drawText({text:t,rect:e,alignment:n,font:i,pen:s,brush:o,orientation:a="Horizontal"}){let x=(0,r.E4)(this._transformMatrix,e);var f,d;this._context2D.save(),"Vertical"===a&&(this._context2D.rotate(-Math.PI/2),x={xmin:-(d=x).ymax,xmax:-d.ymin,ymin:d.xmin,ymax:d.xmax},n={Horizontal:"AlignBottom"===(f=n).Vertical?"AlignLeft":"AlignTop"===f.Vertical?"AlignRight":"AlignCenter",Vertical:"AlignRight"===f.Horizontal?"AlignBottom":"AlignLeft"===f.Horizontal?"AlignTop":"AlignCenter"}),c(this._context2D,i);const g=((t,e)=>{let n,i,s="left",o="bottom";switch(e.Horizontal){case"AlignLeft":n=t.xmin,s="left";break;case"AlignCenter":n=(0,r.qg)(t)[0],s="center";break;case"AlignRight":n=t.xmax,s="right";break;default:throw new Error("Missing horizontal alignment in drawText: AlignLeft, AlignCenter, or AlignRight")}switch(e.Vertical){case"AlignBottom":i=t.ymax,o="bottom";break;case"AlignCenter":i=(0,r.qg)(t)[1],o="middle";break;case"AlignTop":i=t.ymin,o="top";break;default:throw new Error("Missing vertical alignment in drawText: AlignTop, AlignBottom, or AlignVCenter")}return{x:n,y:i,textAlign:s,textBaseline:o}})(x,n);u(this._context2D,g),l(this._context2D,s),h(this._context2D,o),this._context2D.translate(g.x,g.y),this._context2D.fillText(t,0,0),this._context2D.restore()}drawMarker(t,e){const n=(0,r.DC)(this._transformMatrix,t);this._context2D.save(),e.pen&&(l(this._context2D,e.pen),this._context2D.beginPath(),this._context2D.ellipse(n[0],n[1],e.radius,e.radius,0,0,2*Math.PI),this._context2D.stroke()),e.brush&&(h(this._context2D,e.brush),this._context2D.beginPath(),this._context2D.ellipse(n[0],n[1],e.radius,e.radius,0,0,2*Math.PI),this._context2D.fill()),this._context2D.restore()}}class o{constructor(){this._actions=[]}moveTo(t,e){if((0,r.lM)(t))return this.moveTo(t[0],t[1]);if(!(0,r.hj)(e))throw Error("unexpected");this._actions.push({name:"moveTo",x:t,y:e})}lineTo(t,e){if((0,r.lM)(t))return this.lineTo(t[0],t[1]);if(!(0,r.hj)(e))throw Error("unexpected");this._actions.push({name:"lineTo",x:t,y:e})}_draw(t,e){t.beginPath(),this._transformPathPoints(e).forEach((e=>{this._applyAction(t,e)})),t.stroke()}_applyAction(t,e){"moveTo"===e.name?void 0!==e.x&&void 0!==e.y&&t.moveTo(e.x,e.y):"lineTo"===e.name&&void 0!==e.x&&void 0!==e.y&&t.lineTo(e.x,e.y)}_transformPathPoints(t){const e=(0,i.matrix)(t);return this._actions.map((t=>{if(void 0!==t.x&&void 0!==t.y){const n=(0,i.matrix)([t.x,t.y,1]),r=(0,i.multiply)(e,n).toArray();return Object.assign(Object.assign({},t),{x:r[0],y:r[1]})}return t}))}}const a=t=>{if((0,r.HD)(t))return t;if((0,r.Dk)(t))return`rgba(${Math.floor(t[0])}, ${Math.floor(t[1])}, ${Math.floor(t[2])}, ${t[3]})`;if((0,r.ef)(t))return`rgb(${Math.floor(t[0])}, ${Math.floor(t[1])}, ${Math.floor(t[2])})`;throw Error("unexpected")},l=(t,e)=>{const n=e.color||"black",i=(0,r.hj)(e.width)?e.width:1;t.strokeStyle=a(n),t.lineWidth=i||1},h=(t,e)=>{const n="color"in e?e.color:"black";t.fillStyle=a(n)},c=(t,e)=>{const n=e.pixelSize||"12",i=e.family||"Arial";t.font=`${n}px ${i}`},u=(t,e)=>{t.textAlign=e.textAlign,t.textBaseline=e.textBaseline}},12105:(t,e,n)=>{"use strict";n.d(e,{Z:()=>h});var i=n(56271),r=n.n(i),s=n(16213);const o="COMPUTE_DRAG",a="END_DRAG",l=(t,e)=>{let{dragging:n,dragAnchor:i}=t;const{type:r,mouseButton:s,point:l,shift:h}=e;switch(r){case a:return{dragging:!1};case o:if(!s)return{dragging:!1};if(!l)throw Error("Unexpected: no point");if(n&&!i)throw Error("Invalid state in computing drag: cannot have drag set with no dragAnchor.");if(!n&&!i)return{dragging:!1,dragAnchor:l,shift:h||!1};if(!n&&i){const t=4;if(n=Math.abs(l[0]-i[0])>t||Math.abs(l[1]-i[1])>t,!n)return{dragging:!1,dragAnchor:i,shift:h||!1}}if(n&&i)return{dragging:!0,dragAnchor:i,dragPosition:l,dragRect:[Math.min(i[0],l[0]),Math.min(i[1],l[1]),Math.abs(i[0]-l[0]),Math.abs(i[1]-l[1])],shift:h||!1};break;default:throw Error("Invalid mode for drag reducer.")}throw Error("Unexpected: unreachable, but keeps ESLint happy")},h=t=>{const{layers:e,preventDefaultWheel:n,width:h,height:c}=t,[u,x]=(0,i.useState)(null),[f,d]=(0,i.useState)(!1),g=r().useCallback((t=>{x(t)}),[]);(0,i.useEffect)((()=>{u&&(u._hasFocus=f)}),[f,u]),(0,i.useEffect)((()=>{if(!u)return;if(!e)return;const t=t=>{u._hasFocus&&t.preventDefault()};e.forEach(((e,i)=>{const r=u.children[i];r&&e?(n&&r.addEventListener("wheel",t),e.resetCanvasElement(r),e.scheduleRepaint()):console.warn("Unable to get canvas element for layer",i)}))}),[u,e,n]);const[m,_]=(0,i.useReducer)(l,{dragging:!1}),p=(0,i.useRef)(null);(0,i.useEffect)((()=>{e.forEach((t=>{t&&t.scheduleRepaint()}))}),[h,c,e]);const[v,y]=(0,i.useState)(null);(0,i.useEffect)((()=>{let t=null;if(t=m.dragging?m:v&&v.dragging?v:null,t){const n=t.dragRect;if(n){const i={xmin:n[0],xmax:n[0]+n[2],ymin:n[1]+n[3],ymax:n[1]};for(let n of e)n&&n.handleDrag(i,!m.dragging,t.shift,t.dragAnchor,t.dragPosition)}}y(m)}),[m,v,y,e]);const E=(0,i.useCallback)(((t,n)=>{if(!m.dragging)for(let i of e)i&&i.handleDiscreteEvent(t,n)}),[e,m]),D=(0,i.useCallback)(((t,n)=>{if(e)for(const i of e)i&&i.handleMousePresenceEvent(t,n)}),[e]),w=(0,i.useCallback)((t=>{const{point:e,mouseButton:n,modifiers:i}=(0,s.G3)(t,s.II.Move);var r;r={type:o,mouseButton:1===n,point:e,shift:i.shift||!1},p.current?p.current=r:(p.current=r,setTimeout((()=>{const t=p.current;p.current=null,t&&_(t)}),30)),E(t,s.II.Move)}),[E]),b=(0,i.useCallback)((t=>{const{point:e,modifiers:n}=(0,s.G3)(t,s.II.Press);E(t,s.II.Press),_({type:o,mouseButton:!0,point:e,shift:n.shift||!1})}),[E]),M=(0,i.useCallback)((t=>{d(!0);const{point:e,mouseButton:n,modifiers:i}=(0,s.G3)(t,s.II.Move);E(t,s.II.Release),_({type:o,mouseButton:1===n,point:e,shift:i.shift||!1}),_({type:a})}),[E,_]),P=(0,i.useCallback)((t=>{D(t,s.vT.Enter)}),[D]),C=(0,i.useCallback)((t=>{d(!1),D(t,s.vT.Leave)}),[D]),R=(0,i.useCallback)((t=>{for(let n of e)n&&n.handleWheelEvent(t)}),[e]),A=(0,i.useCallback)((t=>{for(let n of e)n&&!1===n.handleKeyboardEvent(s.zv.Press,t)&&t.preventDefault()}),[e]);for(const t of e)if(t){const{width:e,height:n}=t.getProps();if(e!==h||n!==c)throw console.warn(e,n,h,c),Error("Inconsistent width or height between canvas widget and layer")}return r().createElement("div",{ref:g,style:{position:"relative",width:h,height:c,left:0,top:0},onKeyDown:A,tabIndex:0},(e||[]).map(((t,e)=>r().createElement("canvas",{key:"canvas-"+e,style:{position:"absolute",left:0,top:0},width:h,height:c,onMouseMove:w,onMouseDown:b,onMouseUp:M,onMouseEnter:P,onMouseLeave:C,onWheel:R}))))}},16213:(t,e,n)=>{"use strict";n.d(e,{II:()=>i,zv:()=>r,vT:()=>s,G3:()=>h,Fw:()=>c,sJ:()=>u,jU:()=>x});var i,r,s,o=n(56271),a=n(63813),l=n(17872);!function(t){t.Move="MOVE",t.Press="PRESS",t.Release="RELEASE"}(i||(i={})),function(t){t.Press="PRESS",t.Release="RELEASE"}(r||(r={})),function(t){t.Enter="ENTER",t.Leave="LEAVE",t.Out="OUT"}(s||(s={}));const h=(t,e,n)=>{const i=t.currentTarget;let r=[t.clientX-i.getBoundingClientRect().x,t.clientY-i.getBoundingClientRect().y];if(n){const t=(0,l.tK)(n,r[0],r[1]);r=[t[0],t[1]]}const s={alt:t.altKey,ctrl:t.ctrlKey||t.metaKey,shift:t.shiftKey};return{point:[r[0],r[1]],mouseButton:t.buttons,modifiers:s,type:e}};class c{constructor(t,e,n,i){this._runningOnPropsChange=!1,this._props=null,this._pixelWidth=null,this._pixelHeight=null,this._canvasElement=null,this._repaintScheduled=!1,this._lastRepaintTimestamp=Number(new Date),this._discreteMouseEventHandlers=[],this._dragHandlers=[],this._keyboardEventHandlers=[],this._mousePresenceEventHandlers=[],this._wheelEventHandlers=[],this._refreshRate=120,this._state=n,this._onPaint=t,this._onPropsChange=e,this._discreteMouseEventHandlers=(null==i?void 0:i.discreteMouseEventHandlers)||[],this._dragHandlers=(null==i?void 0:i.dragHandlers)||[],this._keyboardEventHandlers=(null==i?void 0:i.keyboardEventHandlers)||[],this._mousePresenceEventHandlers=(null==i?void 0:i.mousePresenceEventHandlers)||[],this._wheelEventHandlers=(null==i?void 0:i.wheelEventHandlers)||[],this._transformMatrix=[[1,0,0],[0,1,0],[0,0,1]],this._inverseMatrix=[[1,0,0],[0,1,0],[0,0,1]]}getProps(){if(!this._props)throw Error("getProps must not be called before initial props are set");return this._props}setProps(t){if(this._runningOnPropsChange)throw Error("Calling setProps inside onPropsChange is not allowed.");if(null===this._props||!f(this._props,t)){this._props=t,this._pixelWidth=t.width,this._pixelHeight=t.height,this._runningOnPropsChange=!0;try{this._onPropsChange(this,t)}finally{this._runningOnPropsChange=!1}}}getState(){return this._state}setState(t){this._state=t}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(t){this._transformMatrix=t;try{this._inverseMatrix=(0,l.bt)(t)}catch(e){console.warn(e),console.warn("WARNING: problem getting inverse transformation matrix"),this._inverseMatrix=t}}pixelWidth(){if(null===this._pixelWidth)throw Error("Cannot get pixelWidth before it is set");return this._pixelWidth}pixelHeight(){if(null===this._pixelHeight)throw Error("Cannot get pixelHeight before it is set");return this._pixelHeight}resetCanvasElement(t){this._canvasElement=t}canvasElement(){return this._canvasElement}refreshRate(){return this._refreshRate}setRefreshRate(t){this._refreshRate=t}scheduleRepaint(){if(this._repaintScheduled)return;const t=Number(new Date)-this._lastRepaintTimestamp,e=1e3/this._refreshRate;t>2*e?this._doRepaint():(this._repaintScheduled=!0,setTimeout((()=>{this._repaintScheduled=!1,this._doRepaint()}),e))}repaintImmediate(){this._doRepaint()}_doRepaint(){var t,e,n,i,r,s;return n=this,i=void 0,s=function*(){const n=null!==(e=null===(t=this._canvasElement)||void 0===t?void 0:t.getContext("2d"))&&void 0!==e?e:null;if(!n)return;if(null===this._pixelWidth||null===this._pixelHeight)return;let i=new a.cz(n,this._pixelWidth,this._pixelHeight,this._transformMatrix);const r=this._onPaint(i,this._props,this._state);r&&(this._lastRepaintTimestamp=Number(new Date),yield r),this._lastRepaintTimestamp=Number(new Date)},new((r=void 0)||(r=Promise))((function(t,e){function o(t){try{l(s.next(t))}catch(t){e(t)}}function a(t){try{l(s.throw(t))}catch(t){e(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(t){t(n)}))).then(o,a)}l((s=s.apply(n,i||[])).next())}))}handleDiscreteEvent(t,e){if(0===this._discreteMouseEventHandlers.length)return;const n=h(t,e,this._inverseMatrix);for(let t of this._discreteMouseEventHandlers)t(n,this)}handleDrag(t,e,n,i,r){if(0===this._dragHandlers.length)return;const s=(0,l.E4)(this._inverseMatrix,t),o=i?(0,l.DC)(this._inverseMatrix,[...i,1]):void 0,a=r?(0,l.DC)(this._inverseMatrix,[...r,1]):void 0;for(let t of this._dragHandlers)t(this,{dragRect:s,released:e,shift:n||!1,anchor:o,position:a})}handleKeyboardEvent(t,e){if(0===this._keyboardEventHandlers.length)return!0;const n=((t,e)=>({type:t,keyCode:e.keyCode}))(t,e);let i=!0;for(let t of this._keyboardEventHandlers)!1===t(n,this)&&(i=!1);return i}handleMousePresenceEvent(t,e){if(0===this._mousePresenceEventHandlers.length)return;const n={type:e};for(let t of this._mousePresenceEventHandlers)t(n,this)}handleWheelEvent(t){if(0===this._wheelEventHandlers.length)return;const e=(t=>({deltaY:t.deltaY}))(t);for(let t of this._wheelEventHandlers)t(e,this)}}const u=(t,e)=>{const[n,i]=(0,o.useState)(null);return(0,o.useEffect)((()=>{null===n&&i(t())}),[n,i,t]),n&&e&&n.setProps(e),n},x=t=>{const[e,n]=(0,o.useState)([]);return((t,e)=>{if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0})(e,t)?e:(n(t),t)},f=(t,e)=>{for(let n in t)if(t[n]!==e[n])return!1;for(let n in e)if(t[n]!==e[n])return!1;return!0}},17872:(t,e,n)=>{"use strict";n.d(e,{lM:()=>r,ef:()=>s,Dk:()=>o,Xz:()=>a,dz:()=>l,Cr:()=>h,qg:()=>c,Qv:()=>u,jU:()=>x,bZ:()=>f,bt:()=>d,tK:()=>g,DC:()=>m,E4:()=>_,ur:()=>p,hj:()=>v,HD:()=>y});var i=n(7916);const r=t=>{if(t&&Array.isArray(t)&&2===t.length){for(let e of t)if(!v(e))return!1;return!0}return!1},s=t=>{if(t&&Array.isArray(t)&&3===t.length){for(let e of t)if(!v(e))return!1;return!0}return!1},o=t=>{if(t&&Array.isArray(t)&&4===t.length){for(let e of t)if(!v(e))return!1;return!0}return!1},a=(t,e,n,i)=>(i=i||n,Math.pow((t[0]-e[0])/n,2)+Math.pow((t[1]-e[1])/i,2)<=1),l=t=>(0,i.abs)(t.xmax-t.xmin),h=t=>(0,i.abs)(t.ymax-t.ymin),c=t=>[t.xmin+l(t)/2,Math.min(t.ymin,t.ymax)+h(t)/2],u=(t,e)=>!(t.xmax<e.xmin||t.xmin>e.xmax||t.ymax<e.ymin||t.ymin>e.ymax),x=(t,e,n)=>({xmin:t[0]-e,xmax:t[0]+e,ymin:t[1]-n,ymax:t[1]+n}),f=t=>{if(JSON.stringify(t.size())===JSON.stringify([3,3])){const e=t.toArray();if(JSON.stringify(e[2])===JSON.stringify([0,0,1]))return e}throw Error(`Matrix ${JSON.stringify(t)} is invalid as a transform matrix.`)},d=t=>{const e=(0,i.matrix)(t);return(0,i.inv)(e).toArray()},g=(t,e,n)=>{return m(t,[(i=[e,n])[0],i[1],1]);var i},m=(t,e)=>{2===e.length&&(e=[e[0],e[1],1]);const n=(0,i.matrix)(t),r=(0,i.matrix)(e);return(0,i.multiply)(n,r).toArray()},_=(t,e)=>{const n=(0,i.matrix)(t),r=(0,i.matrix)([[e.xmin,e.xmax],[e.ymin,e.ymax],[1,1]]),s=(0,i.multiply)(n,r).toArray(),o=s[0][0],a=s[0][1],l=s[1][0],h=s[1][1];return{xmin:Math.min(o,a),xmax:Math.max(o,a),ymin:Math.min(l,h),ymax:Math.max(l,h)}},p=(t,e)=>{const n=(0,i.matrix)(t),r=(0,i.matrix)([e[0],e[1],0]),s=(0,i.multiply)(n,r),o=(0,i.abs)(s).toArray();return[o[0],o[1]]},v=t=>null!=t&&"number"==typeof t,y=t=>null!=t&&"string"==typeof t},45157:(t,e,n)=>{"use strict";n.d(e,{CP:()=>r.CP,As:()=>s,ZP:()=>o});var i=n(12105),r=n(63813);const s=t=>{const e=t([0,0]),n=t([1,0]),i=t([0,1]);return[[n[0]-e[0],i[0]-e[0],e[0]],[n[1]-e[1],i[1]-e[1],e[1]],[0,0,1]]},o=i.Z},22874:(t,e,n)=>{"use strict";n.d(e,{Gt:()=>i,lR:()=>r});const i=t=>t.reduce(((t,e)=>t<=e?t:e),1/0),r=t=>t.reduce(((t,e)=>t>=e?t:e),-1/0)}}]);