(self.webpackChunklabbox_ephys_widgets_jp=self.webpackChunklabbox_ephys_widgets_jp||[]).push([[973],{45792:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var r=n(60352),i=n.n(r)()((function(e){return e[1]}));i.push([e.id,".NiceTable .MuiTableCell-root {\n    padding-top: 5px;\n    padding-bottom: 5px;\n    padding-left: 0px;\n    padding-right: 0px;\n}\n\n.NiceTable .MuiIconButton-root {\n    padding: 1px;\n}",""]);const o=i},7756:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var r=n(60352),i=n.n(r)()((function(e){return e[1]}));i.push([e.id,".link-button {\n  background-color: transparent;\n  border: none;\n  cursor: pointer;\n  text-decoration: underline;\n  display: inline;\n  margin: 0;\n  padding: 0;\n}\n\n.link-button:hover,\n.link-button:focus {\ntext-decoration: none;\n}",""]);const o=i},65350:(e,t,n)=>{"use strict";n.d(t,{N:()=>u});var r=n(50460),i=n(83711),o=n(63514);const s={electrodeBoxes:[],radius:0,pixelRadius:0,dragRegion:null,draggedElectrodeIds:[],hoveredElectrodeId:null},l={border:"rgb(30, 30, 30)",base:"rgb(0, 0, 255)",selected:"rgb(196, 196, 128)",hover:"rgb(128, 128, 255)",selectedHover:"rgb(200, 200, 196)",dragged:"rgb(0, 0, 196)",draggedSelected:"rgb(180, 180, 150)",dragRect:"rgba(196, 196, 196, 0.5)",textLight:"rgb(228, 228, 228)",textDark:"rgb(32, 32, 32)"},a=(e,t)=>{if(e.type!==r.II.Release)return;const{selectionDispatch:n,electrodeOpts:o}=t.getProps();if(o.disableSelection)return;const s=t.getState();if(null===s)return;const l=s.electrodeBoxes.filter((t=>(0,i.Xz)(e.point,[t.x,t.y],s.radius))).map((e=>e.id));if(0===l.length)return void(e.modifiers.ctrl||e.modifiers.shift||s.dragRegion||n({type:"SetSelectedElectrodeIds",selectedElectrodeIds:[]}));const a=l[0],c=t.getProps().selection.selectedElectrodeIds||[];n({type:"SetSelectedElectrodeIds",selectedElectrodeIds:e.modifiers.ctrl?c.includes(a)?c.filter((e=>e!==a)):[...c,a]:e.modifiers.shift?[...c,a]:[a]}),t.scheduleRepaint()},c=(e,t)=>{if(e.type!==r.II.Move)return;const n=t.getState();if(null===n)return;const o=n.electrodeBoxes.filter((t=>(0,i.Xz)(e.point,[t.x,t.y],n.radius))).map((e=>e.id));t.setState(Object.assign(Object.assign({},n),{hoveredElectrodeId:0===o.length?null:o[0]})),t.scheduleRepaint()},d=(e,t)=>{var n,r,o;const s=e.getState(),{selectionDispatch:l,electrodeOpts:a}=e.getProps();if(a.disableSelection)return;if(null===s)return;const c=null!==(n=s.electrodeBoxes.filter((e=>(0,i.Qv)(e.rect,t.dragRect))))&&void 0!==n?n:[];t.released?(l({type:"SetSelectedElectrodeIds",selectedElectrodeIds:[...t.shift&&null!==(o=null===(r=e.getProps())||void 0===r?void 0:r.selection.selectedElectrodeIds)&&void 0!==o?o:[],...c.map((e=>e.id))]}),e.setState(Object.assign(Object.assign({},s),{dragRegion:null,draggedElectrodeIds:[]}))):e.setState(Object.assign(Object.assign({},s),{dragRegion:t.dragRect,draggedElectrodeIds:c.map((e=>e.id))})),e.scheduleRepaint()},u=()=>new r.Fw(((e,t,n)=>{var r,i;const o=t.electrodeOpts,s=o.colors||l,a=o.showLabels;e.wipe();const c=n.pixelRadius>5;for(let l of n.electrodeBoxes){const d=!o.disableSelection&&((null===(r=t.selection.selectedElectrodeIds)||void 0===r?void 0:r.includes(l.id))||!1),u=!o.disableSelection&&n.hoveredElectrodeId===l.id,g=!o.disableSelection&&((null===(i=n.draggedElectrodeIds)||void 0===i?void 0:i.includes(l.id))||!1),m=d?g?s.draggedSelected:s.selectedHover:g?s.dragged:u?s.hover:s.base,p=t.layoutMode;if("geom"===p?(e.fillEllipse(l.rect,{color:m}),e.drawEllipse(l.rect,{color:s.border})):"vertical"===p&&e.drawLine(l.rect.xmin,(l.rect.ymin+l.rect.ymax)/2,l.rect.xmax,(l.rect.ymin+l.rect.ymax)/2,{color:s.border}),c){const t=[s.selected,s.draggedSelected,s.hover,s.selectedHover].includes(m)?s.textDark:s.textLight;a&&e.drawText({rect:l.rect,alignment:{Horizontal:"AlignCenter",Vertical:"AlignCenter"},font:{pixelSize:n.pixelRadius,family:"Arial"},pen:{color:t},brush:{color:t},text:l.label})}}n.dragRegion&&e.fillRect(n.dragRegion,{color:s.dragRect})}),((e,t)=>{const n=e.getState(),{width:r,height:i,electrodeLocations:s,electrodeIds:l,layoutMode:a}=t,{electrodeBoxes:c,transform:d,radius:u,pixelRadius:g}=(0,o.Z)({width:r,height:i,electrodeLocations:s,electrodeIds:l,layoutMode:a,maxElectrodePixelRadius:t.electrodeOpts.maxElectrodePixelRadius});e.setTransformMatrix(d),e.setState(Object.assign(Object.assign({},n),{electrodeBoxes:c,radius:u,pixelRadius:g})),e.scheduleRepaint()}),s,{discreteMouseEventHandlers:[a,c],dragHandlers:[d]})},63514:(e,t,n)=>{"use strict";n.d(t,{g:()=>d,Z:()=>u});var r=n(59739),i=n(24059),o=n(83711),s=n(89382);const l=new Map,a=e=>{const t=JSON.stringify(e),n=l.get(t);if(void 0!==n)return n;let i=Number.MAX_VALUE;e.forEach((t=>{e.forEach((e=>{const n=(0,r.KOy)([t[0]-e[0],t[1]-e[1]]);0!==n&&(i=Math.min(i,n))}))}));const o=.45*i;return l.set(t,o),o},c=(e,t)=>({xmin:(0,s.Gt)(e.map((e=>e[0])))-t,xmax:(0,s.lR)(e.map((e=>e[0])))+t,ymin:(0,s.Gt)(e.map((e=>e[1])))-t,ymax:(0,s.lR)(e.map((e=>e[1])))+t}),d=e=>{const t=a(e),n=c(e,t);return(0,o.dz)(n)/(0,o.Cr)(n)},u=e=>{const{width:t,height:n,electrodeLocations:r,electrodeIds:l,layoutMode:d}=e;if("vertical"===d)return(({width:e,height:t,electrodeIds:n})=>{const r=n.length,o=(0,i.As)((n=>[10+n[0]*(e-20),10+n[1]*(t-20)]));return{electrodeBoxes:n.map(((e,t)=>{const n=(.5+t)/(r+1),o={xmin:0,xmax:1,ymin:n-.5/(r+1),ymax:n+.5/(r+1)},s=(0,i.As)((e=>[o.xmin+e[0]*(o.xmax-o.xmin),o.ymin+e[1]*(o.ymax-o.ymin)]));return{label:e+"",id:e,x:.5,y:n,rect:o,transform:s}})),transform:o,radius:1/(r+1),pixelRadius:(t-20)/(r+1)}})({width:t,height:n,electrodeIds:l});const u=(e=>{const t=(0,s.Gt)(e.map((e=>e[0]))),n=(0,s.lR)(e.map((e=>e[0]))),r=(0,s.Gt)(e.map((e=>e[1]))),i=(0,s.lR)(e.map((e=>e[1])));return t===n&&r===i?e.map(((e,t)=>[t,0])):e})(r),g=t-20,m=n-20,p=g/m,h=a(u);let b,_=c(u,h),E=(0,o.dz)(_)/(0,o.Cr)(_),y=u;E>1!=p>1&&(y=u.map((e=>[e[1],-e[0]])),_={xmin:_.ymin,xmax:_.ymax,ymin:-_.xmax,ymax:-_.xmin},E=(0,o.dz)(_)/(0,o.Cr)(_)),b=E>p?g/(0,o.dz)(_):m/(0,o.Cr)(_),e.maxElectrodePixelRadius&&h*b>e.maxElectrodePixelRadius&&(b/=h*b/e.maxElectrodePixelRadius);const f=(t-(0,o.dz)(_)*b)/2,k=(n-(0,o.Cr)(_)*b)/2,w=(0,i.As)((e=>[f+(e[0]-_.xmin)*b,k+(e[1]-_.ymin)*b])),x=y.map(((e,t)=>{const n=e[0],r=e[1],s=(0,o.jU)([n,r],h,h),a=(0,i.As)((e=>[s.xmin+e[0]*(s.xmax-s.xmin),s.ymin+e[1]*(s.ymax-s.ymin)]));return{label:l[t]+"",id:l[t],x:n,y:r,rect:s,transform:a}})),v=(0,o.ur)(w,[h,0])[0];return{electrodeBoxes:x,transform:w,radius:h,pixelRadius:v}}},6750:(e,t,n)=>{"use strict";n.d(t,{Z:()=>a});var r=n(66395),i=n(31397),o=n(15891),s=n(69297),l=n.n(s);const a=e=>l().createElement(r.Z,{TransitionProps:{unmountOnExit:void 0===e.unmountOnExit||e.unmountOnExit},defaultExpanded:e.defaultExpanded},l().createElement(i.Z,null,e.icon&&l().createElement("span",{style:{paddingRight:10}},e.icon),l().createElement("span",{style:{paddingTop:3}},e.label)),l().createElement(o.Z,null,l().createElement("div",{style:{width:"100%"}},e.children)))},20864:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var r=n(69297),i=n.n(r);const o=e=>i().createElement("span",{style:{color:"gray",cursor:"pointer",textDecoration:"underline"},onClick:e.onClick},e.children)},93055:(e,t,n)=>{"use strict";n.d(t,{Z:()=>d}),n(239);var r=n(69297),i=n.n(r),o=n(74788),s=n.n(o),l=n(85232),a=n(12919);const c=({value:e,language:t})=>i().createElement(l.Z,{language:t,style:a.Z},e),d=({source:e,substitute:t})=>{const n=t?((e,t)=>{let n=e;for(let e in t)n=n.split(`{${e}}`).join(t[e]||"");return n})(e,t):e;return i().createElement("div",{className:"markdown-body"},i().createElement(s(),{source:n,renderers:{code:c}}))}},3527:(e,t,n)=>{"use strict";n.d(t,{Z:()=>l});var r=n(69297),i=n.n(r),o=n(31315),s=n.n(o);const l=e=>{var t,n,o;const{width:l,height:a,initialPosition:c,onChange:d,adjustable:u=!0,positionFromRight:g=!1}=e,[m,p]=(0,r.useState)(c);if(!e.children)throw Error("Unexpected: no props.children");let h,b;if(Array.isArray(e.children)){const t=e.children.filter((e=>void 0!==e));h=t[0],b=t[1]||null}else h=e.children,b=null;if(!b)return i().createElement(h.type,Object.assign({},h.props,{width:l,height:a}));const _=g?l-m:m,E=u?null!==(t=e.gripThickness)&&void 0!==t?t:10:0,y=u?null!==(n=e.gripInnerThickness)&&void 0!==n?n:4:0,f=u?null!==(o=e.gripMargin)&&void 0!==o?o:2:0,k=_-E/2-f,w=l-k-E-2*f;let x={top:0,left:0,width:l,height:a},v={left:0,top:0,width:k,height:a,zIndex:0,overflowY:"auto",overflowX:"hidden"},R={left:k+E+2*f,top:0,width:w,height:a,zIndex:0,overflowY:"auto",overflowX:"hidden"},I={left:0,top:0,width:E+2*f,height:a,backgroundColor:"transparent",cursor:"col-resize",zIndex:9998},S={left:f,top:0,width:E,height:a,background:"rgb(230, 230, 230)",cursor:"col-resize"},j={top:0,left:(E-y)/2,width:y,height:a,background:"gray",cursor:"col-resize"};return i().createElement("div",{className:"splitter",style:Object.assign(Object.assign({},x),{position:"relative"})},i().createElement("div",{key:"child1",style:Object.assign(Object.assign({},v),{position:"absolute"}),className:"SplitterChild"},i().createElement(h.type,Object.assign({},h.props,{width:k,height:a}))),u&&i().createElement(s(),{key:"drag",position:{x:_-E/2-f,y:0},axis:"x",onDrag:(e,t)=>{},onStop:(e,t)=>((e,t)=>{const n=t.x;if(n===_)return;const r=g?l-n:n;p(r),d&&d(r)})(0,t)},i().createElement("div",{style:Object.assign(Object.assign({},I),{position:"absolute"})},i().createElement("div",{style:Object.assign(Object.assign({},S),{position:"absolute"})},i().createElement("div",{style:Object.assign(Object.assign({},j),{position:"absolute"})})))),i().createElement("div",{key:"child2",style:Object.assign(Object.assign({},R),{position:"absolute"}),className:"SplitterChild"},i().createElement(b.type,Object.assign({},b.props,{width:w,height:a}))))}},15743:(e,t,n)=>{"use strict";n.d(t,{F0:()=>o,ZL:()=>s});var r=n(5443),i=n(69297);const o=e=>{const{result:t}=(0,r.lG)(e?"createjob_get_recording_info":"",{recording_object:e},{useClientCache:!0});return t},s=e=>{const t=(0,i.useContext)(r.Zo),n=(0,i.useRef)({}),[,o]=(0,i.useState)(0),s={};return e.forEach((e=>{const r=e.recordingId;if(!n.current[r]){const i=t.createHitherJob("createjob_get_recording_info",{recording_object:e.recordingObject},{useClientCache:!0});n.current[r]=i,i.wait().then((()=>{o((e=>e+1))})).catch((()=>{o((e=>e+1))}))}n.current[r].result&&(s[r]=n.current[r].result)})),s}},10051:(e,t,n)=>{"use strict";n.d(t,{D:()=>o,h:()=>s});var r=n(5443),i=n(69297);const o=(e,t)=>{const{result:n}=(0,r.lG)(e?"createjob_get_sorting_info":"",{sorting_object:e,recording_object:t},{useClientCache:!0});return n},s=e=>{const t=(0,i.useContext)(r.Zo),n=(0,i.useRef)({}),[,o]=(0,i.useState)(0),s={};return e.forEach((e=>{const r=e.sortingId;if(!n.current[r]){const i=t.createHitherJob("createjob_get_sorting_info",{recording_object:e.recordingObject,sorting_object:e.sortingObject},{useClientCache:!0});n.current[r]=i,i.wait().then((()=>{o((e=>e+1))})).catch((()=>{o((e=>e+1))}))}n.current[r].result&&(s[r]=n.current[r].result)})),s}},13344:(e,t,n)=>{"use strict";n.d(t,{Z:()=>a});var r=n(69297),i=n.n(r),o=n(65350),s=n(24059),l=n(50460);const a=e=>{const t=(0,r.useMemo)((()=>({layoutMode:"geom",electrodeIds:e.electrodes.map((e=>e.id)),electrodeLocations:e.electrodes.map((e=>[e.x,e.y])),width:e.width,height:e.height,selection:e.selection,selectionDispatch:e.selectionDispatch,electrodeOpts:{showLabels:!0,maxElectrodePixelRadius:25},noiseLevel:0,samplingFrequency:0})),[e]),n=(0,l.sJ)(o.N,t),a=(0,l.jU)([n]);return i().createElement(s.ZP,Object.assign({key:"electrodeGeometryCanvas",layers:a},{width:e.width,height:e.height}))}},95849:(e,t,n)=>{"use strict";n.d(t,{kN:()=>c,qG:()=>m,GI:()=>d,CC:()=>a,Zl:()=>s,_S:()=>h,SF:()=>u,fG:()=>_,fB:()=>b,Sd:()=>p,FO:()=>E});var r=n(5443),i=n(69297);const o=(e,t)=>{if(e.min<=t&&t<e.max)return e;const n=e.max-e.min,r=Math.max(0,Math.floor(t-n/2));return{min:r,max:r+n}},s=(e,t)=>{var n,r,i,s;if("SetRecordingSelection"===t.type)return Object.assign({},t.recordingSelection);if("SetSelectedElectrodeIds"===t.type)return Object.assign(Object.assign({},e),{selectedElectrodeIds:t.selectedElectrodeIds.filter((t=>!e.visibleElectrodeIds||e.visibleElectrodeIds.includes(t)))});if("SetVisibleElectrodeIds"===t.type)return Object.assign(Object.assign({},e),{visibleElectrodeIds:t.visibleElectrodeIds,selectedElectrodeIds:e.selectedElectrodeIds?e.selectedElectrodeIds.filter((e=>t.visibleElectrodeIds.includes(e))):void 0});if("SetCurrentTimepoint"===t.type)return Object.assign(Object.assign({},e),{currentTimepoint:t.currentTimepoint||void 0,timeRange:t.ensureInRange&&e.timeRange&&null!==t.currentTimepoint?o(e.timeRange,t.currentTimepoint):e.timeRange});if("SetTimeRange"===t.type)return Object.assign(Object.assign({},e),{timeRange:t.timeRange});if("ZoomTimeRange"===t.type){const i=9e6,o=e.currentTimepoint,s=e.timeRange;if(!s)return e;const a=null!==(n=t.direction)&&void 0!==n?n:"in",c=null!==(r=t.factor)&&void 0!==r?r:1.4,d="out"===a?1/c:c;if((s.max-s.min)/d>i)return e;let u;u=void 0===o||o<s.min?s.min:o>s.max?s.max:o;const g=l(s,d,u);return Object.assign(Object.assign({},e),{timeRange:g})}if("SetAmpScaleFactor"===t.type)return Object.assign(Object.assign({},e),{ampScaleFactor:t.ampScaleFactor});if("ScaleAmpScaleFactor"===t.type){const n=null!==(i=t.direction)&&void 0!==i?i:"up",r=null!==(s=t.multiplier)&&void 0!==s?s:1.4,o="down"===n?1/r:r;return Object.assign(Object.assign({},e),{ampScaleFactor:(e.ampScaleFactor||1)*o})}return"SetCurrentTimepointVelocity"===t.type?Object.assign(Object.assign({},e),{animation:Object.assign(Object.assign({},e.animation||{}),{currentTimepointVelocity:t.velocity})}):"SetWaveformsMode"===t.type?Object.assign(Object.assign({},e),{waveformsMode:t.waveformsMode}):"Set"===t.type?t.state:e},l=(e,t,n)=>{const r=n+(e.min-n)/t,i=n+(e.max-n)/t;return{min:Math.floor(r),max:Math.floor(i)}},a=(e,t)=>((t||{}).mergeGroups||[]).filter((t=>t.includes(e)))[0]||null,c=(e,t,n)=>n&&a(e,t)||e,d=(e,t)=>{const n=a(e,t);return!n||Math.min(...n)===e},u=(e,t)=>"SetSelection"===t.type?t.selection:"SetSelectedUnitIds"===t.type?Object.assign(Object.assign({},e),{selectedUnitIds:t.selectedUnitIds.filter((t=>{var n;return!e.visibleUnitIds||(null===(n=e.visibleUnitIds)||void 0===n?void 0:n.includes(t))}))}):"SetVisibleUnitIds"===t.type?Object.assign(Object.assign({},e),{selectedUnitIds:e.selectedUnitIds?e.selectedUnitIds.filter((e=>{var n;return null===(n=t.visibleUnitIds)||void 0===n?void 0:n.includes(e)})):void 0,visibleUnitIds:t.visibleUnitIds}):"UnitClicked"===t.type?((e,t)=>{const n=t.unitId;return t.ctrlKey?(e.selectedUnitIds||[]).includes(n)?Object.assign(Object.assign({},e),{selectedUnitIds:(e.selectedUnitIds||[]).filter((e=>e!==n))}):Object.assign(Object.assign({},e),{selectedUnitIds:[...e.selectedUnitIds||[],n]}):Object.assign(Object.assign({},e),{selectedUnitIds:[n]})})(e,t):"Set"===t.type?t.state:"ToggleApplyMerges"===t.type?g(Object.assign(Object.assign({},e),{applyMerges:!e.applyMerges}),t.curation):s(e,t),g=(e,t)=>e.applyMerges&&t?Object.assign(Object.assign({},e),{selectedUnitIds:e.selectedUnitIds?e.selectedUnitIds.filter((e=>d(e,t))):void 0}):e,m=e=>e.filter((e=>!e.disabled&&!e.development)),p=e=>m(e).filter((e=>"SortingView"===e.type)).map((e=>e)),h=e=>m(e).filter((e=>"RecordingView"===e.type)).map((e=>e)),b=e=>m(e).filter((e=>"SortingUnitView"===e.type)).map((e=>e)),_=e=>m(e).filter((e=>"SortingUnitMetric"===e.type)).map((e=>e)),E=()=>{const e=(0,r._m)();return(0,i.useMemo)((()=>e.filter((e=>"WorkspaceView"===e.type)).map((e=>e))),[e])}},54514:(e,t,n)=>{"use strict";n.d(t,{Z:()=>i});const r=e=>(e=>Array.isArray(e))(e)?e.sort(((e,t)=>e.priority===t.priority?(e.label||"")<(t.label||"")?-1:(e.label||"")>(t.label||"")?1:0:(t.priority||0)-(e.priority||0))):r(Object.values(e)),i=r},19973:(e,t,n)=>{"use strict";n.d(t,{Z:()=>le});var r=n(69297),i=n.n(r),o=n(5443),s=n(20864),l=n(15743),a=n(10051),c=n(95849);const d=(0,o.zy)({maxSimultaneous:6}),u=e=>{const t=(0,r.useContext)(o.Zo),{readOnly:n,sorting:u,recording:g,curationDispatch:m,onSetExternalUnitMetrics:p,workspaceRouteDispatch:h}=e,[b,_]=(0,r.useState)("waiting"),[E,y]=(0,r.useReducer)(c.SF,{}),f=(0,a.D)(u.sortingObject,u.recordingObject),k=(0,l.F0)(g.recordingObject),w=u.sortingId;(0,r.useEffect)((()=>{!E.timeRange&&k&&y({type:"SetTimeRange",timeRange:{min:0,max:Math.min(k.num_frames,k.sampling_frequency/10)}})}),[E,k]),(0,r.useEffect)((()=>{u&&u.externalUnitMetricsUri&&!u.externalUnitMetrics&&"waiting"===b&&(_("computing"),t.createHitherJob("fetch_external_sorting_unit_metrics",{uri:u.externalUnitMetricsUri},{useClientCache:!0}).wait().then((e=>{p({sortingId:w,externalUnitMetrics:e}),_("finished")})))}),[p,_,b,u,w,t]);const x=e.width||800,v=e.height||800,R=(0,r.useMemo)((()=>({position:"absolute",left:0,top:v-20,width:x,height:20,overflow:"hidden"})),[x,v,20]),I=x,S=v-20,j=(0,r.useMemo)((()=>({position:"absolute",left:0,top:0,width:I,height:S})),[I,S]),C=(0,o._m)(),O=(0,c.Sd)(C).filter((e=>"MVSortingView"===e.name))[0];if(!O)throw Error("Missing sorting view: MVSortingView");const Z=(0,r.useMemo)((()=>O.props||{}),[O.props]),D=(0,r.useCallback)((()=>{h({type:"gotoRecordingPage",recordingId:g.recordingId})}),[h,g.recordingId]);return u?g?k?f?i().createElement("div",null,i().createElement("div",{style:j},i().createElement(O.component,Object.assign({},Z,{sorting:u,recording:g,sortingInfo:f,recordingInfo:k,selection:E,selectionDispatch:y,curationDispatch:m,readOnly:n,calculationPool:d,width:I,height:S}))),i().createElement("div",{style:R},"Sorting: ",u.sortingLabel," | Recording: ",i().createElement(s.Z,{onClick:D},g.recordingLabel))):i().createElement("h3",null,"Loading sorting info..."):i().createElement("h3",null,"Loading recording info..."):i().createElement("h3",null,`Recording not found: ${u.recordingId}`):i().createElement("h3",null,`Sorting not found: ${w}`)};var g=n(95898),m=n(3527),p=n(6750),h=n(93055);const b="import spikeextractors as se\nimport numpy as np\nimport labbox_ephys as le\nimport kachery_p2p as kp\n\n# adjust these values\nworkspace_uri = '{workspaceUri}'\nrecording_label = 'simulated_recording'\nduration_sec = 50 # duration of simulated recording\nnum_channels = 8 # num. channels in simulated recording\nnum_units = 5 # num units\nseed = 1 # random number generator seed\n\ndef prepare_recording_sorting():\n    # Simulate a recording (toy example)\n    recording, sorting = se.example_datasets.toy_example(duration=duration_sec, num_channels=num_channels, K=num_units, seed=seed)\n    R = le.LabboxEphysRecordingExtractor.from_memory(recording, serialize=True, serialize_dtype=np.int16)\n    S = le.LabboxEphysSortingExtractor.from_memory(sorting, serialize=True)\n    return R, S\n\nrecording, sorting_true = prepare_recording_sorting()\nsorting_label = 'true'\nworkspace = le.load_workspace(workspace_uri)\nprint(f'Workspace URI: {workspace.get_uri()}')\nR_id = workspace.add_recording(recording=recording, label=recording_label)\nS_id = workspace.add_sorting(sorting=sorting_true, recording_id=R_id, label=sorting_label)",_="import spikeextractors as se\nimport numpy as np\nimport labbox_ephys as le\nimport kachery_p2p as kp\n\n\n# Adjust these values\nrecording_label = 'despy_tet3'\nsorting_label = 'sorting'\nrecording_nwb_path = '<path or URI of nwb recording>'\nsorting_nwb_path = '<path or URI of nwb sorting>'\nworkspace_uri = '{workspaceUri}'\n\nrecording_uri = kp.store_object({\n    'recording_format': 'nwb',\n    'data': {\n        'path': recording_nwb_path\n    }\n})\nsorting_uri = kp.store_object({\n    'sorting_format': 'nwb',\n    'data': {\n        'path': sorting_nwb_path\n    }\n})\n\nsorting = le.LabboxEphysSortingExtractor(sorting_uri, samplerate=30000)\nrecording = le.LabboxEphysRecordingExtractor(recording_uri, download=True)\n\nworkspace = le.load_workspace(workspace_uri)\nprint(f'Workspace URI: {workspace.get_uri()}')\nR_id = workspace.add_recording(recording=recording, label=recording_label)\nS_id = workspace.add_sorting(sorting=sorting, recording_id=R_id, label=sorting_label)",E='import spikeextractors as se\nimport numpy as np\nimport labbox_ephys as le\nimport kachery_p2p as kp\n\n# Here are some examples to select from\nX1 = {\n    "label": "SF/synth_magland_noise10_K10_C4/001_synth",\n    "recording_uri": "sha1://f060669aadaa0f8ebe296bf72895df3899f8cf45/SF/synth_magland_noise10_K10_C4/001_synth.json",\n    "sorting_true_uri": "sha1://5b07e41bf62c045a549242c0caa866d272a33ab8/firings_true.mda"\n}\nX2 = {\n    "label": "SF/PAIRED_BOYDEN/paired_boyden32c/419_1_7",\n    "recording_uri": "sha1://759c81e6e20d3c352eaff6ce5d4dc7f948c45f25/SF/PAIRED_BOYDEN/paired_boyden32c/419_1_7.json",\n    "sorting_true_uri": "sha1://a5b7de64d7a2a96c0e1af70cdb2d4ae927e4949d/firings_true.mda"\n}\nX3 = {\n    "label": "SF/PAIRED_KAMPFF/paired_kampff/2014_11_25_Pair_3_0",\n    "recording_uri": "sha1://a205f87cef8b7f86df7a09cddbc79a1fbe5df60f/SF/PAIRED_KAMPFF/paired_kampff/2014_11_25_Pair_3_0.json",\n    "sorting_true_uri": "sha1://1cd517687aeca7ecdfaa9695680038d142a75031/firings_true.mda"\n}\n# To find more examples, see: https://github.com/flatironinstitute/spikeforest_recordings\n# However: note that some processing needs to be done to the files in this repo (to add the manifests to the raw data). This is WIP\n\n# Adjust these values ###########################\nX = X1 # Select example from above\nworkspace_uri = \'{workspaceUri}\'\n#################################################\n\nrecording_label = X[\'label\']\nrecording_uri = X[\'recording_uri\']\nsorting_true_uri = X[\'sorting_true_uri\']\nrecording = le.LabboxEphysRecordingExtractor(recording_uri, download=True)\nsorting_true = le.LabboxEphysSortingExtractor(sorting_true_uri, samplerate=30000)\n\nsorting_label = \'true\'\nworkspace = le.load_workspace(workspace_uri)\nprint(f\'Workspace URI: {workspace.get_uri()}\')\nR_id = workspace.add_recording(recording=recording, label=recording_label)\nS_id = workspace.add_sorting(sorting=sorting_true, recording_id=R_id, label=sorting_label)',y=e=>"```python\n"+e+"\n```",f=({text:e})=>{const[t,n]=(0,r.useState)(!1),o=(0,r.useCallback)((()=>{window.isSecureContext?(navigator.clipboard.writeText(e),n(!0),setTimeout((()=>{n(!1)}),3e3)):window.alert("Unable to copy to clipbard (not a secure context). This is probably because this site uses http rather than https.")}),[e]);return i().createElement("button",{onClick:o},t?"Copied":"Copy to clipboard")},k=({workspaceRoute:e})=>{const t=t=>((e,t)=>{let n=e;for(let e in t)n=n.split(`{${e}}`).join(t[e]||"");return n})(t,{workspaceUri:e.workspaceUri});return i().createElement("div",null,i().createElement(h.Z,{source:"## Importing recordings\n\nTo import a recording into labbox-ephys, you can run a Python script on the computer where labbox-ephys is installed, or from a kachery node that has the appropriate access. See the example scripts below."}),i().createElement(p.Z,{label:"Import example simulated recording"},i().createElement(f,{text:t(b)}),i().createElement(h.Z,{source:y(t(b))})),i().createElement(p.Z,{label:"Import SpikeForest recordings"},i().createElement(f,{text:t(E)}),i().createElement(h.Z,{source:y(t(E))})),i().createElement(p.Z,{label:"Import NWB recordings"},i().createElement(f,{text:t(_)}),i().createElement(h.Z,{source:y(t(_))})))};var w=n(53167),x=n(22682),v=n(37450),R=n(2197),I=n(92378),S=n(62198),j=n(12930),C=n(39110),O=n(23801),Z=n(816),D=n(93379),U=n.n(D),M=n(45792);U()(M.Z,{insert:"head",singleton:!1}),M.Z.locals;const L=({title:e,rowKey:t,onDeleteRow:n})=>{const o=(0,r.useCallback)((()=>{n&&n(t)}),[n,t]);return i().createElement(C.Z,{title:e,onClick:o},i().createElement(O.Z,null))},T=({title:e,rowKey:t,onConfirmDeleteRow:n})=>{const o=(0,r.useCallback)((()=>{n&&n(t,!0)}),[n,t]),s=(0,r.useCallback)((()=>{n&&n(t,!1)}),[n,t]);return i().createElement("span",null,"Confirm delete?",i().createElement(C.Z,{title:e,onClick:o},i().createElement(O.Z,null)),i().createElement(C.Z,{title:"Cancel",onClick:s},"✖"))},P=({title:e,rowKey:t,onEditRow:n})=>i().createElement(C.Z,{title:e,onClick:()=>n&&n(t)},i().createElement(Z.Z,null)),F=({rows:e,columns:t,onDeleteRow:n,deleteRowLabel:o,onEditRow:s,editRowLabel:l,selectionMode:a="none",selectedRowKeys:c={},onSelectedRowKeysChanged:d})=>{const u=(0,r.useMemo)((()=>{const e={};return Object.keys(c).forEach((t=>{e[t]=c[t]})),e}),[c]),[g,m]=(0,r.useState)(null),p=(0,r.useCallback)((e=>{d&&("single"===a?e in u&&u[e]?d([]):d([e+""]):"multiple"===a&&d(Object.keys(u).filter((t=>t!=e&&u[t])).concat(u[e]?[]:[e.toString()])))}),[d,a,u]),h=(0,r.useCallback)((e=>{m(e)}),[]),b=(0,r.useCallback)(((e,t)=>{t&&n&&n(e),m(null)}),[n]),_=(0,r.useCallback)((e=>{s&&s(e)}),[s]);return i().createElement(x.Z,{className:"NiceTable"},i().createElement(v.Z,null,i().createElement(R.Z,null,i().createElement(I.Z,{key:"_first",style:{width:0}}),t.map((e=>i().createElement(I.Z,{key:e.key},i().createElement("span",null,e.label)))))),i().createElement(S.Z,null,e.map((e=>i().createElement(R.Z,{key:e.key},i().createElement(I.Z,null,n&&(g===e.key?i().createElement(T,{title:o||"",onConfirmDeleteRow:b,rowKey:e.key}):i().createElement(L,{title:o||"",onDeleteRow:h,rowKey:e.key})),s&&i().createElement(P,{title:l||"",onEditRow:_,rowKey:e.key}),"none"!==a&&i().createElement(j.Z,{checked:u[e.key]||!1,onClick:()=>p(e.key)})),t.map((t=>{return i().createElement(I.Z,{key:t.key},i().createElement("span",null,0==(n=e.columnValues[t.key])?n:n?"object"==typeof n?n.element?n.element:n.text||"":n:""));var n})))))))};var N=n(7756);U()(N.Z,{insert:"head",singleton:!1}),N.Z.locals;const A=e=>i().createElement("span",null,e.map((e=>{return t=e,i().createElement("span",{key:t.sortingId},t.sortingId," (","",")");var t}))),z=({recording:e,onClick:t})=>{const n=(0,r.useCallback)((()=>{t(e)}),[e,t]);return i().createElement(V,{title:"View recording",onClick:n},e.recordingLabel)},V=({title:e,children:t,onClick:n})=>i().createElement("button",{type:"button",className:"link-button",onClick:n},t),q=({recordings:e,sortings:t,onDeleteRecordings:n,readOnly:o,workspaceRouteDispatch:s})=>{const a=(0,r.useMemo)((()=>{const n={};return e.forEach((e=>{n[e.recordingId]=t.filter((t=>t.recordingId===e.recordingId))})),n}),[e,t]);var c;c="recordingLabel",e=e.sort((function(e,t){var n=e[c],r=t[c];return n<r?-1:n>r?1:0}));const d=(0,r.useCallback)((e=>{s({type:"gotoRecordingPage",recordingId:e.recordingId})}),[s]),u=(0,l.ZL)(e),g=(0,r.useMemo)((()=>e.map((e=>{const t=u[e.recordingId];return{key:e.recordingId,columnValues:{recording:e,recordingLabel:{text:e.recordingLabel,element:i().createElement(z,{onClick:d,recording:e})},numChannels:t?t.channel_ids.length:{element:i().createElement(w.Z,null)},samplingFrequency:t?t.sampling_frequency:"",durationMinutes:t?t.num_frames/t.sampling_frequency/60:"",sortings:{element:A(a[e.recordingId])}}}}))),[e,a,d,u]),m=(0,r.useCallback)((e=>{n&&n([e])}),[n]);return i().createElement("div",null,i().createElement(F,{rows:g,columns:[{key:"recordingLabel",label:"Recording"},{key:"numChannels",label:"Num. channels"},{key:"samplingFrequency",label:"Samp. freq. (Hz)"},{key:"durationMinutes",label:"Duration (min)"},{key:"sortings",label:"Sortings"}],deleteRowLabel:"Remove this recording",onDeleteRow:o?void 0:m}))},G=({width:e,height:t,sortings:n,recordings:o,onDeleteRecordings:s,workspaceRoute:l,workspaceRouteDispatch:a})=>{const[c,d]=(0,r.useState)(!1),u=(0,r.useCallback)((()=>{d(!0)}),[]);return i().createElement(m.Z,Object.assign({},{width:e,height:t},{initialPosition:300,positionFromRight:!0}),i().createElement("div",null,!c&&i().createElement("div",null,i().createElement(g.Z,{onClick:u},"Import recordings")),i().createElement(q,Object.assign({},{sortings:n,recordings:o,onDeleteRecordings:s,readOnly:!1,workspaceRouteDispatch:a}))),c&&i().createElement(k,{workspaceRoute:l}))};var K=n(81459),B=n(54514),X=n(13344);const H=({sampling_frequency:e,channel_ids:t,channel_groups:n,num_frames:r,noise_level:o})=>i().createElement(x.Z,{className:"NiceTable"},i().createElement(v.Z,null),i().createElement(S.Z,null,i().createElement(R.Z,null,i().createElement(I.Z,null,"Sampling frequency"),i().createElement(I.Z,null,e)),i().createElement(R.Z,null,i().createElement(I.Z,null,"Num. frames"),i().createElement(I.Z,null,r)),i().createElement(R.Z,null,i().createElement(I.Z,null,"Duration (min)"),i().createElement(I.Z,null,r/e/60)),i().createElement(R.Z,null,i().createElement(I.Z,null,"Num. channels"),i().createElement(I.Z,null,t.length)),i().createElement(R.Z,null,i().createElement(I.Z,null,"Channel IDs"),i().createElement(I.Z,null,t.length<20?W(t):W(t.slice(0,20))+" ...")),i().createElement(R.Z,null,i().createElement(I.Z,null,"Channel groups"),i().createElement(I.Z,null,n.length<20?W(n):W(n.slice(0,20))+" ...")),i().createElement(R.Z,null,i().createElement(I.Z,null,"Noise level"),i().createElement(I.Z,null,o))));function W(e){return e.map((e=>e+"")).join(", ")}const $=({recordingInfo:e,hideElectrodeGeometry:t})=>{const n=e,o=(0,r.useMemo)((()=>n?((e,t)=>{if(e&&t&&t.length!==e.length)throw Error("Electrode ID count does not match location count.");return t.map(((t,n)=>{const r=e[n];return{label:t+"",x:r[0],y:r[1],id:t}}))})(n.geom,n.channel_ids):[]),[n]),[s,l]=(0,r.useReducer)(c.Zl,{});return n?i().createElement(i().Fragment,null,i().createElement("div",{style:{width:600}},i().createElement(H,{sampling_frequency:n.sampling_frequency,num_frames:n.num_frames,channel_ids:n.channel_ids,channel_groups:n.channel_groups,noise_level:n.noise_level})),!t&&i().createElement(X.Z,{electrodes:o,selection:s,selectionDispatch:l,width:350,height:150})):i().createElement("div",null,"No recording info found for recording.")},J="# Prerequisites:\n#    SpikeInterface/spikesorters: `pip install spikesorters`\n#    SpyKING CIRCUS: `pip install spyking-circus`\n#    On Ubuntu, the following are required for spyking circus:\n#        pip install pyqt5\n#        apt install qt5-default\n#    For more information: https://spyking-circus.readthedocs.io/en/latest/introduction/install.html\n\nimport spikeextractors as se\nimport numpy as np\nimport labbox_ephys as le\nfrom labbox_ephys import sorters\nimport kachery_p2p as kp\n\nif __name__ == '__main__':\n    # adjust these values\n    workspace_uri = '{workspaceUri}'\n    recording_id = '{recordingId}' # {recordingLabel}\n\n    workspace = le.load_workspace(workspace_uri)\n    le_recording = workspace.get_recording(recording_id)\n    recording_object = le_recording['recordingObject']\n\n    sorting_object = sorters.spykingcircus(\n        recording_object=recording_object,\n        detect_sign=-1,\n        adjacency_radius=100,\n        detect_threshold=6,\n        template_width_ms=3,\n        filter=True,\n        merge_spikes=True,\n        auto_merge=0.75,\n        num_workers=None,\n        whitening_max_elts=1000,\n        clustering_max_elts=10000\n    )\n    sorting = le.LabboxEphysSortingExtractor(sorting_object)\n\n    S_id = workspace.add_sorting(\n        sorting=sorting,\n        recording_id=recording_id,\n        label='spykingcircus'\n    )",Y=({text:e})=>{const[t,n]=(0,r.useState)(!1),o=(0,r.useCallback)((()=>{window.isSecureContext?(navigator.clipboard.writeText(e),n(!0),setTimeout((()=>{n(!1)}),3e3)):window.alert("Unable to copy to clipbard (not a secure context). This is probably because this site uses http rather than https.")}),[e]);return i().createElement("button",{onClick:o},t?"Copied":"Copy to clipboard")},Q=({workspaceRoute:e,recordingId:t,recordingLabel:n})=>{const r=r=>((e,t)=>{let n=e;for(let e in t)n=n.split(`{${e}}`).join(t[e]||"");return n})(r,{workspaceUri:e.workspaceUri,recordingId:t,recordingLabel:n});return i().createElement("div",null,i().createElement(h.Z,{source:"## Spike sorting\n\nUse one of the following scripts to run spike sorting and import the result into this workspace. You must\nrun the script on the computer where labbox-ephys is installed, or from a kachery node that has the appropriate access."}),i().createElement(p.Z,{label:"SpyKING CIRCUS"},i().createElement(Y,{text:r(J)}),i().createElement(h.Z,{source:(o=r(J),"```python\n"+o+"\n```")})));var o};var ee=n(1845);const te=({sorting:e,onClick:t})=>{const n=(0,r.useCallback)((()=>{t(e)}),[e,t]);return i().createElement(ne,{title:"View recording",onClick:n},e.sortingLabel)},ne=({title:e,children:t,onClick:n})=>i().createElement("button",{type:"button",className:"link-button",onClick:n},t),re=({sortings:e,onDeleteSortings:t,readOnly:n,workspaceRouteDispatch:o})=>{const s=(0,r.useCallback)((e=>{o({type:"gotoSortingPage",recordingId:e.recordingId,sortingId:e.sortingId})}),[o]),l=(0,a.h)(e),c=(0,r.useMemo)((()=>{return t="sortingLabel",e.sort((function(e,n){var r=e[t],i=n[t];return r<i?-1:r>i?1:0}));var t}),[e]),d=(0,r.useMemo)((()=>c.map((e=>{const t=l[e.sortingId];return{key:e.sortingId,columnValues:{sorting:e,sortingLabel:{text:e.sortingLabel,element:i().createElement(te,{sorting:e,onClick:s})},numUnits:t?t.unit_ids.length:{element:i().createElement(w.Z,null)}}}}))),[c,s,l]),u=(0,r.useCallback)((e=>{t&&t([e])}),[t]);return i().createElement("div",null,i().createElement(F,{rows:d,columns:[{key:"sortingLabel",label:"Sorting"},{key:"numUnits",label:"Num. units"}],deleteRowLabel:"Remove this sorting",onDeleteRow:n?void 0:u}))},ie=({sortings:e,workspaceRouteDispatch:t,workspaceRoute:n,onDeleteSortings:r})=>i().createElement(ee.Z,null,i().createElement("h3",null,`${e.length} sortings`),i().createElement(re,{sortings:e,workspaceRouteDispatch:t,readOnly:!1,onDeleteSortings:r})),oe=(0,o.zy)({maxSimultaneous:6}),se=({recording:e,sortings:t,workspaceRoute:n,workspaceRouteDispatch:s,onDeleteSortings:a,width:d,height:u})=>{const h=(0,l.F0)(e.recordingObject),[b,_]=(0,r.useState)(!1),[E,y]=(0,r.useReducer)(c.Zl,{});(0,r.useEffect)((()=>{!E.timeRange&&h&&y({type:"SetTimeRange",timeRange:{min:0,max:Math.min(h.num_frames,h.sampling_frequency/10)}})}),[E,h]);const f=(0,r.useCallback)((()=>{s({type:"gotoRecordingsPage"})}),[s]),k=(0,o._m)(),w=(0,r.useMemo)((()=>(0,c._S)(k)),[k]);if(!h)return i().createElement("div",null,"Loading recording info");const x=i().createElement("div",{style:{margin:20}},i().createElement(K.Z,{container:!0,spacing:3},i().createElement(K.Z,{item:!0,xs:12,xl:6},i().createElement(g.Z,{onClick:f},"Back to recordings"),i().createElement("h2",null,e.recordingLabel),i().createElement("div",null,e.recordingPath),i().createElement($,{recordingInfo:h,hideElectrodeGeometry:!0})),i().createElement(K.Z,{item:!0,xs:12,xl:6},i().createElement(ie,{sortings:t,workspaceRouteDispatch:s,workspaceRoute:n,onDeleteSortings:a}))),(0,B.Z)(w).filter((e=>!e.disabled)).map((t=>i().createElement(p.Z,{label:t.label,defaultExpanded:!!t.defaultExpanded,key:"rv-"+t.name},i().createElement(t.component,{key:"rvc-"+t.name,calculationPool:oe,recording:e,recordingInfo:h,selection:E,selectionDispatch:y,width:d-40})))));return i().createElement(m.Z,Object.assign({},{width:d,height:u},{initialPosition:300,positionFromRight:!0}),i().createElement("div",null,!b&&i().createElement("div",null,i().createElement(g.Z,{onClick:()=>{_(!0)}},"Spike sorting")),x),b&&i().createElement(Q,{workspaceRoute:n,recordingId:e.recordingId,recordingLabel:e.recordingLabel}))},le=({workspace:e,workspaceDispatch:t,workspaceRoute:n,workspaceRouteDispatch:o,width:s=500,height:l=500})=>{const a=(0,r.useCallback)((e=>{t({type:"DELETE_RECORDINGS",recordingIds:e})}),[t]),c=(0,r.useCallback)((e=>{t({type:"DELETE_SORTINGS",sortingIds:e})}),[t]),d=(0,r.useCallback)((e=>{t(e)}),[t]);switch(n.page){case"recordings":return i().createElement(G,Object.assign({onDeleteRecordings:a},{width:s,height:l,recordings:e.recordings,sortings:e.sortings,workspaceRoute:n,workspaceRouteDispatch:o}));case"recording":{const t=n.recordingId,r=e.recordings.filter((e=>e.recordingId===t))[0];return r?i().createElement(se,Object.assign({onDeleteSortings:c},{width:s,height:l,recording:r,workspaceRouteDispatch:o,workspaceRoute:n},{sortings:e.sortings.filter((e=>e.recordingId===t))})):i().createElement("div",null,"Recording not found: ",t)}case"sorting":{const t=n.recordingId,r=e.recordings.filter((e=>e.recordingId===t))[0];if(!r)return i().createElement("div",null,"Recording not found: ",t);const a=n.sortingId,c=e.sortings.filter((e=>e.recordingId===t&&e.sortingId===a))[0];return c?i().createElement(u,{sorting:c,recording:r,onSetExternalUnitMetrics:e=>{},curationDispatch:d,width:s,height:l,readOnly:!1,workspaceRouteDispatch:o}):i().createElement("div",null,"Sorting not found: ",t,"/",a)}}}}}]);