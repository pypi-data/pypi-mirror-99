(self.webpackChunklabbox_ephys_widgets_jp=self.webpackChunklabbox_ephys_widgets_jp||[]).push([[818],{25497:(e,t,i)=>{"use strict";var n=i(50725),r=i(3805);t.Z=void 0;var s=r(i(69297)),a=(0,n(i(62265)).default)(s.createElement(s.Fragment,null,s.createElement("circle",{cx:"7",cy:"14",r:"3"}),s.createElement("circle",{cx:"11",cy:"6",r:"3"}),s.createElement("circle",{cx:"16.6",cy:"17.6",r:"3"})),"ScatterPlot");t.Z=a},15743:(e,t,i)=>{"use strict";i.d(t,{F0:()=>s,ZL:()=>a});var n=i(5443),r=i(69297);const s=e=>{const{result:t}=(0,n.lG)(e?"createjob_get_recording_info":"",{recording_object:e},{useClientCache:!0});return t},a=e=>{const t=(0,r.useContext)(n.Zo),i=(0,r.useRef)({}),[,s]=(0,r.useState)(0),a={};return e.forEach((e=>{const n=e.recordingId;if(!i.current[n]){const r=t.createHitherJob("createjob_get_recording_info",{recording_object:e.recordingObject},{useClientCache:!0});i.current[n]=r,r.wait().then((()=>{s((e=>e+1))})).catch((()=>{s((e=>e+1))}))}i.current[n].result&&(a[n]=i.current[n].result)})),a}},86729:(e,t,i)=>{"use strict";i.d(t,{Z:()=>c});var n=i(69297),r=i.n(n),s=i(10051),a=i(95849),l=i(3940);const c=({sorting:e,selection:t,selectionDispatch:i})=>{const n=(0,s.D)(e.sortingObject,e.recordingObject);if(!n)return r().createElement("div",null,"No sorting info");const c=((null==n?void 0:n.unit_ids)||[]).filter((i=>!t.applyMerges||(0,a.GI)(i,e.curation)));return r().createElement(l.Z,Object.assign({units:c},{selection:t,selectionDispatch:i,sorting:e}))}},36818:(e,t,i)=>{"use strict";i.r(t),i.d(t,{activate:()=>R});var n=i(25497),r=i(69297),s=i.n(r),a=i(5443),l=i(98946),c=i(15743),o=i(10051),u=i(89382),m=i(95849),d=i(88382);const p=["blue","green","red","orange","purple","cyan"],g=e=>{if(Array.isArray(e))return g(Math.min(...e));for(;e<0;)e+=p.length;return p[e%p.length]};class h{constructor(e,t){this.panels=e,this.labelString=t}setTimeRange(e){this.panels.forEach((t=>t.setTimeRange(e)))}paint(e,t){this.panels.forEach((i=>i.paint(e,t)))}paintYAxis(e,t,i){const n=this.panels[0];n&&n.paintYAxis&&n.paintYAxis(e,t,i)}label(){return this.labelString}register(e){this.panels.forEach((t=>t.register((()=>{e()}))))}}const b=(e,t)=>new h(e,t),x=class{constructor(e){this.args=e,this._updateHandler=null,this._timeRange=null,this._calculationScheduled=!1,this._calculationError=null,this._yrange=null,this._globalAmplitudeRange=null,this._includeZero=!0,this._amplitudes=void 0}setTimeRange(e){this._timeRange=e}paint(e,t){const i=this._timeRange;if(!i)return;const n={color:"black"},r={color:g(this.args.unitId)};if(!this.args.spikeAmplitudesData)return;const s=this.args.spikeAmplitudesData.getSpikeAmplitudes(this.args.unitId);if(s&&s.timepoints&&s.amplitudes){const{timepoints:t,amplitudes:a}=s;this._amplitudes=a;let l=this._yrange||this.autoYRange();if(!l)return;this._includeZero&&(l={min:Math.min(0,l.min),max:Math.max(0,l.max)}),e.drawLine(i.min,0,i.max,0,{color:"gray"});const c=t.length;for(let s=0;s<c;s++){const c=t[s],o=(a[s]-l.min)/(l.max-l.min);i.min<=c&&c<=i.max&&e.drawMarker([c,o],{radius:3,pen:n,brush:r})}}else e.drawText({rect:{xmin:i.min,xmax:i.max,ymin:0,ymax:1},alignment:{Horizontal:"AlignCenter",Vertical:"AlignCenter"},font:{pixelSize:12,family:"Arial"},pen:n,brush:r,text:"calculating"})}paintYAxis(e,t,i){((e,t,{label:i})=>{const{xmin:n,xmax:r,ymin:s,ymax:a}=t;e.drawLine(r,s,r,a,{color:"black"}),e.drawText({rect:{xmin:n,xmax:r-10-2,ymin:s,ymax:a},alignment:{Horizontal:"AlignRight",Vertical:"AlignCenter"},font:{family:"Arial",pixelSize:12},pen:{color:"black"},brush:{color:"black"},text:i,orientation:"Vertical"})})(e,{xmin:0,xmax:t,ymin:0,ymax:i},{label:"Spike amplitude"})}label(){return this.args.unitId+""}amplitudeRange(){return this._amplitudes?{min:(0,u.Gt)(this._amplitudes),max:(0,u.lR)(this._amplitudes)}:null}setGlobalAmplitudeRange(e){this._globalAmplitudeRange=e}autoYRange(){return this._globalAmplitudeRange?this._globalAmplitudeRange:this.amplitudeRange()}setYRange(e){this._yrange=e}register(e){this._updateHandler=e}},f=({spikeAmplitudesData:e,recording:t,sorting:i,unitIds:n,width:p,height:g,selection:h,selectionDispatch:f})=>{const _=(0,r.useContext)(a.Zo),y=(0,o.D)(i.sortingObject,i.recordingObject),A=(0,c.F0)(t.recordingObject),[k,j]=(0,l.Z)(m.SF,h,(0,r.useMemo)((()=>e=>{f({type:"Set",state:e})}),[f]),400),[w,E]=(0,r.useState)(null);(0,r.useEffect)((()=>{const r=[],s=[],a=[];n.forEach((n=>{const l=(0,m.kN)(n,i.curation,k.applyMerges),c=new x({spikeAmplitudesData:e,recording:t,sorting:i,unitId:l,hither:_}),o=e.getSpikeAmplitudes(l);o&&(s.push(o.minAmp),a.push(o.maxAmp)),r.push(c)})),0===r.length&&r.push(new x({spikeAmplitudesData:null,recording:t,sorting:i,unitId:-1,hither:_})),s.length>0&&r.forEach((e=>{e.setGlobalAmplitudeRange({min:(0,u.Gt)(s),max:(0,u.lR)(a)})})),E(r)}),[n,i,_,t,e,k]);const v=(0,r.useMemo)((()=>w?[b(w,"")]:[]),[w]);return y?A?s().createElement(d.Z,{panels:v,width:p,height:g,samplerate:y.samplerate,maxTimeSpan:60*y.samplerate*5,startTimeSpan:60*y.samplerate*1,numTimepoints:A.num_frames,selection:k,selectionDispatch:j}):s().createElement("div",null,"No recording info"):s().createElement("div",null,"No sorting info")};var _=i(45529),y=i(46826),A=function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function l(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,l)}c((n=n.apply(e,t||[])).next())}))};const k=(0,_.zy)({maxSimultaneous:6}),j=(e,t)=>{const i=(0,r.useContext)(_.Zo),n=(0,r.useMemo)((()=>n=>A(void 0,void 0,void 0,(function*(){switch(n.type){case"spikeAmplitudes":return yield(({hither:e,recordingObject:t,sortingObject:i,unitId:n})=>A(void 0,void 0,void 0,(function*(){const r=yield e.createHitherJob("createjob_fetch_spike_amplitudes",{recording_object:t,sorting_object:i,unit_id:n},{useClientCache:!0,calculationPool:k}).wait();return Object.assign(Object.assign({},r),{minAmp:(0,u.Gt)(r.amplitudes),maxAmp:(0,u.lR)(r.amplitudes)})})))({hither:i,recordingObject:e,sortingObject:t,unitId:n.unitId});default:throw Error("Unexpected query type")}}))),[i,e,t]),s=(0,y.Z)(n),a=(0,r.useMemo)((()=>e=>s.get({type:"spikeAmplitudes",unitId:e})),[s]);return(0,r.useMemo)((()=>({getSpikeAmplitudes:a})),[a])},w=e=>{const t=j(e.recording.recordingObject,e.sorting.sortingObject);return t?s().createElement(f,Object.assign({spikeAmplitudesData:t,recording:e.recording,sorting:e.sorting,unitIds:[e.unitId]},{width:e.width||500,height:e.height||500},{selection:e.selection,selectionDispatch:e.selectionDispatch})):s().createElement("div",null,"Creating spike amplitudes data...")};var E=i(3527),v=i(86729);const S=({recording:e,sorting:t,selection:i,selectionDispatch:n,width:r,height:a})=>{const l=j(e.recordingObject,t.sortingObject);return l?s().createElement(E.Z,{width:r||600,height:a||900,initialPosition:200},s().createElement(v.Z,{sorting:t,selection:i,selectionDispatch:n}),s().createElement(f,Object.assign({spikeAmplitudesData:l,recording:e,sorting:t,unitIds:i.selectedUnitIds||[]},{width:0,height:0},{selection:i,selectionDispatch:n}))):s().createElement("div",null,"Creating spike amplitudes data...")};function R(e){e.registerPlugin({type:"SortingView",name:"SpikeAmplitudes",label:"Spike amplitudes",priority:50,defaultExpanded:!1,component:S,singleton:!1,icon:s().createElement(n.Z,null)}),e.registerPlugin({type:"SortingUnitView",name:"SpikeAmplitudes",label:"Spike amplitudes",priority:50,fullWidth:!0,component:w,icon:s().createElement(n.Z,null)})}}}]);