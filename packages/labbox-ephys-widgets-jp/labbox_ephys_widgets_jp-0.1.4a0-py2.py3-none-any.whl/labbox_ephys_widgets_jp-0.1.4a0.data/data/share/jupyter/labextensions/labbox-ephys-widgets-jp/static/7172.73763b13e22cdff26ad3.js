(self.webpackChunklabbox_ephys_widgets_jp=self.webpackChunklabbox_ephys_widgets_jp||[]).push([[7172],{37172:(e,t,n)=>{"use strict";n.r(t),n.d(t,{activate:()=>E});var i=n(12931),s=n(56271),r=n.n(s),c=n(45829),l=n(45185),o=n(12240),a=n(49287),d=n(45157),u=n(16213),g=n(22874),m=n(17872);const p={},b=(e,t)=>{const{width:n,height:i,rect:s}=t;e.setTransformMatrix((0,d.As)((e=>{const t=(e[0]-s.xmin)/(s.xmax-s.xmin),r=1-(e[1]-s.ymin)/(s.ymax-s.ymin);return[5+t*(n-10),5+r*(i-10)]}))),e.scheduleRepaint()},h=(e,t,n)=>{const{x:i,y:s,selectedIndex:r}=t;e.wipe();const c=i.length,l={color:"black"},o={color:"blue"};for(let t=0;t<c;t++)e.drawMarker([i[t],s[t]],{radius:2,pen:l,brush:o});if(void 0!==n.hoverIndex){const t=n.hoverIndex,r={color:"gray",width:5},c={color:"blue"};e.drawMarker([i[t],s[t]],{radius:3,pen:r,brush:c})}if(void 0!==r){const t=r,n={color:"orange",width:4},c={color:"blue"};e.drawMarker([i[t],s[t]],{radius:3,pen:n,brush:c})}},y=(e,t)=>{const{x:n,y:i}=e,s=n.map(((e,t)=>t)),r=10*(e.rect.xmax-e.rect.xmin)/e.width;return s.filter((e=>(0,m.Xz)(t,[n[e],i[e]],r))).sort(((e,s)=>{const r=n[e]-t[0],c=i[e]-t[1],l=n[s]-t[0],o=i[s]-t[1];return r*r+c*c-(l*l+o*o)}))[0]},j=(e,t)=>{if(e.type!==u.II.Move)return;const n=t.getState(),i=y(t.getProps(),e.point);t.setState(Object.assign(Object.assign({},n),{hoverIndex:i})),t.scheduleRepaint()},v=(e,t)=>{if(e.type!==u.II.Release)return;const{onSelectedIndexChanged:n}=t.getProps(),i=y(t.getProps(),e.point);n&&n(i)},I=()=>new u.Fw(h,b,p,{dragHandlers:[],discreteMouseEventHandlers:[j,v]}),f=({x:e,y:t,width:n,height:i,selectedIndex:c,onSelectedIndexChanged:l})=>{const o=(0,s.useMemo)((()=>{const s=(0,g.Gt)(e),r=(0,g.lR)(e),o=(0,g.Gt)(t),a=(0,g.lR)(t);return{x:e,y:t,rect:{xmin:s,xmax:r,ymin:o,ymax:a},width:n,height:i,selectedIndex:c,onSelectedIndexChanged:l}}),[e,t,n,i,l,c]),a=(0,u.sJ)(I,o),m=(0,u.jU)([a]);return r().createElement(d.ZP,Object.assign({layers:m},{width:n,height:i}))},S=(0,l.createCalculationPool)({maxSimultaneous:6}),O=({recording:e,sorting:t,selection:n,selectionDispatch:i,unitId:c,width:d,height:u})=>{const{result:g,job:m}=(0,l.useHitherJob)("createjob_individual_cluster_features",{recording_object:e.recordingObject,sorting_object:t.sortingObject,unit_id:(0,a.kN)(c,t.curation,n.applyMerges)},{useClientCache:!0,calculationPool:S}),p=(0,s.useMemo)((()=>{const e=n.currentTimepoint;if(void 0!==e&&void 0!==g)for(let t=0;t<g.timepoints.length;t++)if(Math.abs(g.timepoints[t]-e)<20)return t}),[g,n]),b=(0,s.useCallback)((e=>{if(void 0===e)return;if(void 0===g)return;const t=g.timepoints[e];void 0!==t&&i({type:"SetCurrentTimepoint",currentTimepoint:t,ensureInRange:!0})}),[g,i]);return g?r().createElement(f,Object.assign({x:g.x,y:g.y},{width:d,height:u,selectedIndex:p},{onSelectedIndexChanged:b})):r().createElement(o.Z,Object.assign({},{job:m,width:d,height:u}))},x=({recording:e,sorting:t,selection:n,selectionDispatch:i})=>{const l=(0,s.useMemo)((()=>s=>r().createElement(O,Object.assign({},{recording:e,sorting:t,unitId:s,selection:n,selectionDispatch:i},{width:180,height:180}))),[t,e,n,i]);return r().createElement(c.Z,{sorting:t,selection:n,selectionDispatch:i,unitComponent:l})};function E(e){e.registerPlugin({type:"SortingView",name:"IndividualClustersView",label:"Clusters",priority:50,component:x,icon:r().createElement(i.BubbleChart,null)})}},12240:(e,t,n)=>{"use strict";n.d(t,{Z:()=>c});var i=n(47033),s=n(56271),r=n.n(s);const c=({job:e,message:t="",width:n=200,height:s=200})=>e?r().createElement(i.Box,{display:"flex",width:n,height:s},r().createElement(i.Box,{m:"auto"},"running"===e.status?r().createElement("span",null,"[",t,"] ",r().createElement(i.CircularProgress,null)):"error"===e.status?r().createElement("span",null,"Error: ",e.error_message," [",t,"]"):"pending"===e.status?r().createElement("span",null,t):r().createElement("span",null,"[",t,"] ",e.status))):r().createElement("div",null,"No job")},45829:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(47033),s=n(56271),r=n.n(s),c=n(49287),l=n(65405);const o=({sorting:e,selection:t,selectionDispatch:n,unitComponent:o})=>{const[a,d]=(0,s.useState)(30),u=(0,l.D)(e.sortingObject,e.recordingObject),g=t.visibleUnitIds;let m=(u?u.unit_ids:[]).filter((e=>!g||g.includes(e))).filter((n=>!t.applyMerges||(0,c.GI)(n,e.curation))),p=!1;m.length>a&&(m=m.slice(0,a),p=!0);const b=(0,s.useCallback)((e=>{const t=Number(e.currentTarget.dataset.unitId);n({type:"UnitClicked",unitId:t,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey})}),[n]);return r().createElement(i.Grid,{container:!0},m.map((e=>{var n;return r().createElement(i.Grid,{key:e,item:!0},r().createElement("div",{className:"plotWrapperStyle"},r().createElement("div",{"data-unit-id":e,className:(null===(n=t.selectedUnitIds)||void 0===n?void 0:n.includes(e))?"plotSelectedStyle":"plotUnselectedStyle",onClick:b},r().createElement("div",{className:"plotUnitLabel"},r().createElement("div",null,"Unit ",e)),o(e))))})),p&&r().createElement("div",{className:"plotWrapperStyle"},r().createElement("div",{className:"plotWrapperStyleButton"},r().createElement(i.Button,{onClick:()=>{d(a+60)}},"Show more units"))))}},65405:(e,t,n)=>{"use strict";n.d(t,{D:()=>r,h:()=>c});var i=n(45185),s=n(56271);const r=(e,t)=>{const{result:n}=(0,i.useHitherJob)(e?"createjob_get_sorting_info":"",{sorting_object:e,recording_object:t},{useClientCache:!0});return n},c=e=>{const t=(0,s.useContext)(i.HitherContext),n=(0,s.useRef)({}),[,r]=(0,s.useState)(0),c={};return e.forEach((e=>{const i=e.sortingId;if(!n.current[i]){const s=t.createHitherJob("createjob_get_sorting_info",{recording_object:e.recordingObject,sorting_object:e.sortingObject},{useClientCache:!0});n.current[i]=s,s.wait().then((()=>{r((e=>e+1))})).catch((()=>{r((e=>e+1))}))}n.current[i].result&&(c[i]=n.current[i].result)})),c}},49287:(e,t,n)=>{"use strict";n.d(t,{kN:()=>a,qG:()=>m,GI:()=>d,CC:()=>o,Zl:()=>c,_S:()=>b,SF:()=>u,fG:()=>y,fB:()=>h,Sd:()=>p,FO:()=>j});var i=n(45185),s=n(56271);const r=(e,t)=>{if(e.min<=t&&t<e.max)return e;const n=e.max-e.min,i=Math.max(0,Math.floor(t-n/2));return{min:i,max:i+n}},c=(e,t)=>{var n,i,s,c;if("SetRecordingSelection"===t.type)return Object.assign({},t.recordingSelection);if("SetSelectedElectrodeIds"===t.type)return Object.assign(Object.assign({},e),{selectedElectrodeIds:t.selectedElectrodeIds.filter((t=>!e.visibleElectrodeIds||e.visibleElectrodeIds.includes(t)))});if("SetVisibleElectrodeIds"===t.type)return Object.assign(Object.assign({},e),{visibleElectrodeIds:t.visibleElectrodeIds,selectedElectrodeIds:e.selectedElectrodeIds?e.selectedElectrodeIds.filter((e=>t.visibleElectrodeIds.includes(e))):void 0});if("SetCurrentTimepoint"===t.type)return Object.assign(Object.assign({},e),{currentTimepoint:t.currentTimepoint||void 0,timeRange:t.ensureInRange&&e.timeRange&&null!==t.currentTimepoint?r(e.timeRange,t.currentTimepoint):e.timeRange});if("SetTimeRange"===t.type)return Object.assign(Object.assign({},e),{timeRange:t.timeRange});if("ZoomTimeRange"===t.type){const s=9e6,r=e.currentTimepoint,c=e.timeRange;if(!c)return e;const o=null!==(n=t.direction)&&void 0!==n?n:"in",a=null!==(i=t.factor)&&void 0!==i?i:1.4,d="out"===o?1/a:a;if((c.max-c.min)/d>s)return e;let u;u=void 0===r||r<c.min?c.min:r>c.max?c.max:r;const g=l(c,d,u);return Object.assign(Object.assign({},e),{timeRange:g})}if("SetAmpScaleFactor"===t.type)return Object.assign(Object.assign({},e),{ampScaleFactor:t.ampScaleFactor});if("ScaleAmpScaleFactor"===t.type){const n=null!==(s=t.direction)&&void 0!==s?s:"up",i=null!==(c=t.multiplier)&&void 0!==c?c:1.4,r="down"===n?1/i:i;return Object.assign(Object.assign({},e),{ampScaleFactor:(e.ampScaleFactor||1)*r})}return"SetCurrentTimepointVelocity"===t.type?Object.assign(Object.assign({},e),{animation:Object.assign(Object.assign({},e.animation||{}),{currentTimepointVelocity:t.velocity})}):"SetWaveformsMode"===t.type?Object.assign(Object.assign({},e),{waveformsMode:t.waveformsMode}):"Set"===t.type?t.state:e},l=(e,t,n)=>{const i=n+(e.min-n)/t,s=n+(e.max-n)/t;return{min:Math.floor(i),max:Math.floor(s)}},o=(e,t)=>((t||{}).mergeGroups||[]).filter((t=>t.includes(e)))[0]||null,a=(e,t,n)=>n&&o(e,t)||e,d=(e,t)=>{const n=o(e,t);return!n||Math.min(...n)===e},u=(e,t)=>"SetSelection"===t.type?t.selection:"SetSelectedUnitIds"===t.type?Object.assign(Object.assign({},e),{selectedUnitIds:t.selectedUnitIds.filter((t=>{var n;return!e.visibleUnitIds||(null===(n=e.visibleUnitIds)||void 0===n?void 0:n.includes(t))}))}):"SetVisibleUnitIds"===t.type?Object.assign(Object.assign({},e),{selectedUnitIds:e.selectedUnitIds?e.selectedUnitIds.filter((e=>{var n;return null===(n=t.visibleUnitIds)||void 0===n?void 0:n.includes(e)})):void 0,visibleUnitIds:t.visibleUnitIds}):"UnitClicked"===t.type?((e,t)=>{const n=t.unitId;return t.ctrlKey?(e.selectedUnitIds||[]).includes(n)?Object.assign(Object.assign({},e),{selectedUnitIds:(e.selectedUnitIds||[]).filter((e=>e!==n))}):Object.assign(Object.assign({},e),{selectedUnitIds:[...e.selectedUnitIds||[],n]}):Object.assign(Object.assign({},e),{selectedUnitIds:[n]})})(e,t):"Set"===t.type?t.state:"ToggleApplyMerges"===t.type?g(Object.assign(Object.assign({},e),{applyMerges:!e.applyMerges}),t.curation):c(e,t),g=(e,t)=>e.applyMerges&&t?Object.assign(Object.assign({},e),{selectedUnitIds:e.selectedUnitIds?e.selectedUnitIds.filter((e=>d(e,t))):void 0}):e,m=e=>e.filter((e=>!e.disabled&&!e.development)),p=e=>m(e).filter((e=>"SortingView"===e.type)).map((e=>e)),b=e=>m(e).filter((e=>"RecordingView"===e.type)).map((e=>e)),h=e=>m(e).filter((e=>"SortingUnitView"===e.type)).map((e=>e)),y=e=>m(e).filter((e=>"SortingUnitMetric"===e.type)).map((e=>e)),j=()=>{const e=(0,i.usePlugins)();return(0,s.useMemo)((()=>e.filter((e=>"WorkspaceView"===e.type)).map((e=>e))),[e])}}}]);