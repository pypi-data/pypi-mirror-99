(self.webpackChunklabbox_ephys_widgets_jp=self.webpackChunklabbox_ephys_widgets_jp||[]).push([[1353],{88493:(e,t,r)=>{"use strict";r.d(t,{Z:()=>c});var n=r(56271),s=r.n(n),o=r(13090),i=r.n(o);const c=e=>{var t,r,o;const{width:c,height:a,initialPosition:l,onChange:d,adjustable:u=!0,positionFromRight:g=!1}=e,[h,p]=(0,n.useState)(l);if(!e.children)throw Error("Unexpected: no props.children");let m,f;if(Array.isArray(e.children)){const t=e.children.filter((e=>void 0!==e));m=t[0],f=t[1]||null}else m=e.children,f=null;if(!f)return s().createElement(m.type,Object.assign({},m.props,{width:c,height:a}));const b=g?c-h:h,y=u?null!==(t=e.gripThickness)&&void 0!==t?t:10:0,E=u?null!==(r=e.gripInnerThickness)&&void 0!==r?r:4:0,v=u?null!==(o=e.gripMargin)&&void 0!==o?o:2:0,x=b-y/2-v,_=c-x-y-2*v;let j={top:0,left:0,width:c,height:a},O={left:0,top:0,width:x,height:a,zIndex:0,overflowY:"auto",overflowX:"hidden"},S={left:x+y+2*v,top:0,width:_,height:a,zIndex:0,overflowY:"auto",overflowX:"hidden"},C={left:0,top:0,width:y+2*v,height:a,backgroundColor:"transparent",cursor:"col-resize",zIndex:9998},w={left:v,top:0,width:y,height:a,background:"rgb(230, 230, 230)",cursor:"col-resize"},R={top:0,left:(y-E)/2,width:E,height:a,background:"gray",cursor:"col-resize"};return s().createElement("div",{className:"splitter",style:Object.assign(Object.assign({},j),{position:"relative"})},s().createElement("div",{key:"child1",style:Object.assign(Object.assign({},O),{position:"absolute"}),className:"SplitterChild"},s().createElement(m.type,Object.assign({},m.props,{width:x,height:a}))),u&&s().createElement(i(),{key:"drag",position:{x:b-y/2-v,y:0},axis:"x",onDrag:(e,t)=>{},onStop:(e,t)=>((e,t)=>{const r=t.x;if(r===b)return;const n=g?c-r:r;p(n),d&&d(n)})(0,t)},s().createElement("div",{style:Object.assign(Object.assign({},C),{position:"absolute"})},s().createElement("div",{style:Object.assign(Object.assign({},w),{position:"absolute"})},s().createElement("div",{style:Object.assign(Object.assign({},R),{position:"absolute"})})))),s().createElement("div",{key:"child2",style:Object.assign(Object.assign({},S),{position:"absolute"}),className:"SplitterChild"},s().createElement(f.type,Object.assign({},f.props,{width:_,height:a}))))}},76827:(e,t,r)=>{"use strict";r.d(t,{Z:()=>l});var n=r(81410),s=r.n(n),o=r(56271);const i={data:{},activeFetches:{}},c=(e,t)=>{switch(t.type){case"clear":return i;case"startFetch":return Object.assign(Object.assign({},e),{activeFetches:Object.assign(Object.assign({},e.activeFetches),{[t.queryHash]:!0})});case"setData":return Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{[t.queryHash]:t.data}),activeFetches:Object.assign(Object.assign({},e.activeFetches),{[t.queryHash]:!1})});default:throw Error("Unexpected action in fetchCacheReducer")}},a=e=>s()(e),l=e=>{const[t,r]=(0,o.useState)(0);t<0&&console.info(t);const n=(0,o.useRef)(e),[s,l]=(0,o.useReducer)(c,i),d=(0,o.useRef)({});(0,o.useEffect)((()=>{e!==n.current&&(n.current=e,l({type:"clear"}))}),[e]);const u=(0,o.useMemo)((()=>e=>{const t=a(e),n=s.data[t];return void 0===n&&(d.current[t]=e,r((e=>e+1))),n}),[s.data]),g=(0,o.useMemo)((()=>t=>{const r=a(t);void 0===s.data[r]&&(s.activeFetches[r]||(l({type:"startFetch",queryHash:r}),e(t).then((e=>{l({type:"setData",queryHash:r,data:e})})).catch((e=>{console.warn(e),console.warn("Problem fetching data",t)}))))}),[s.data,s.activeFetches,e]);return(0,o.useEffect)((()=>{const e=Object.keys(d.current);if(0!==e.length){for(let t of e)g(d.current[t]);d.current={}}})),(0,o.useMemo)((()=>({get:u})),[u])}},85155:(e,t,r)=>{"use strict";r.d(t,{F0:()=>o,ZL:()=>i});var n=r(45185),s=r(56271);const o=e=>{const{result:t}=(0,n.useHitherJob)(e?"createjob_get_recording_info":"",{recording_object:e},{useClientCache:!0});return t},i=e=>{const t=(0,s.useContext)(n.HitherContext),r=(0,s.useRef)({}),[,o]=(0,s.useState)(0),i={};return e.forEach((e=>{const n=e.recordingId;if(!r.current[n]){const s=t.createHitherJob("createjob_get_recording_info",{recording_object:e.recordingObject},{useClientCache:!0});r.current[n]=s,s.wait().then((()=>{o((e=>e+1))})).catch((()=>{o((e=>e+1))}))}r.current[n].result&&(i[n]=r.current[n].result)})),i}},61353:(e,t,r)=>{"use strict";r.r(t),r.d(t,{activate:()=>C});var n=r(63847),s=r(56271),o=r.n(s),i=r(88493),c=r(3660),a=r(45157),l=r(16213),d=r(85155),u=r(7916),g=r(17872),h=r(22874);const p={BASE:"rgb(0, 0, 255)",SELECTED:"rgb(196, 196, 128)",HOVER:"rgb(128, 128, 255)",SELECTEDHOVER:"rgb(200, 200, 196)",DRAGGED:"rgb(0, 0, 196)",DRAGGEDSELECTED:"rgb(180, 180, 150)",DRAGRECT:"rgba(196, 196, 196, 0.5)"},m={electrodeBoundingBoxes:[],dragRegion:null,draggedElectrodeIds:[],hoveredElectrodeId:null,radius:0,pixelRadius:0,lastProps:{electrodes:[],selectedElectrodeIds:[],onSelectedElectrodeIdsChanged:()=>{},width:0,height:0}},f=new Map,b=(e,t)=>{const r=e.getState(),{width:n,height:s,electrodes:o}=t,i=n-20,c=s-20,l=i/c,d=(e=>{const t=JSON.stringify(e),r=f.get(t);if(void 0!==r)return r;let n=Number.MAX_VALUE;e.forEach((t=>{e.forEach((e=>{const r=(0,u.norm)([t.x-e.x,t.y-e.y]);0!==r&&(n=Math.min(n,r))}))}));const s=.4*n;return f.set(t,s),s})(o);let p,m=((e,t)=>({xmin:(0,h.Gt)(e.map((e=>e.x)))-t,xmax:(0,h.lR)(e.map((e=>e.x)))+t,ymin:(0,h.Gt)(e.map((e=>e.y)))-t,ymax:(0,h.lR)(e.map((e=>e.y)))+t}))(o,d),b=(0,g.dz)(m)/(0,g.Cr)(m),y=o;b>1!=l>1&&(y=o.map((e=>Object.assign(Object.assign({},e),{x:e.y,y:-e.x}))),m={xmin:m.ymin,xmax:m.ymax,ymin:-m.xmax,ymax:-m.xmin},b=(0,g.dz)(m)/(0,g.Cr)(m)),p=b>l?i/(0,g.dz)(m):c/(0,g.Cr)(m),p=Math.min(p,32/d);const E=(n-(0,g.dz)(m)*p)/2,v=(s-(0,g.Cr)(m)*p)/2,x=(0,a.As)((e=>[E+(e[0]-m.xmin)*p,v+(e[1]-m.ymin)*p])),_=y.map((e=>{const t=e.x,r=e.y;return{label:e.label,id:parseInt(e.label),x:t,y:r,br:(0,g.jU)([t,r],d,d),color:e.color}}));e.setTransformMatrix(x);const j=(0,g.ur)(x,[d,0])[0];e.setState(Object.assign(Object.assign({},r),{electrodeBoundingBoxes:_,radius:d,pixelRadius:j,lastProps:t})),e.scheduleRepaint()},y=(e,t,r)=>{var n,s;e.wipe();const o=r.pixelRadius>5;for(let i of r.electrodeBoundingBoxes){const c=(null===(n=t.selectedElectrodeIds)||void 0===n?void 0:n.includes(i.id))||!1,a=r.hoveredElectrodeId===i.id,l=(null===(s=r.draggedElectrodeIds)||void 0===s?void 0:s.includes(i.id))||!1,d=i.color||(c?l?p.DRAGGEDSELECTED:a?p.SELECTEDHOVER:p.SELECTED:l?p.DRAGGED:a?p.HOVER:p.BASE);if(e.fillEllipse(i.br,{color:d}),o){const t=[p.SELECTED,p.DRAGGEDSELECTED,p.HOVER,p.SELECTEDHOVER].includes(d)?"rgb(32, 32, 32)":"rgb(228, 228, 228)";e.drawText({rect:i.br,alignment:{Horizontal:"AlignCenter",Vertical:"AlignCenter"},font:{pixelSize:r.pixelRadius,family:"Arial"},pen:{color:t},brush:{color:t},text:i.label})}}r.dragRegion&&e.fillRect(r.dragRegion,{color:p.DRAGRECT})},E=(e,t)=>{var r,n,s,o;const i=e.getState();if(null===i)return;const c=null!==(r=i.electrodeBoundingBoxes.filter((e=>(0,g.Qv)(e.br,t.dragRect))))&&void 0!==r?r:[];if(t.released){const r=t.shift&&null!==(s=null===(n=e.getProps())||void 0===n?void 0:n.selectedElectrodeIds)&&void 0!==s?s:[];null===(o=e.getProps())||void 0===o||o.onSelectedElectrodeIdsChanged([...r,...c.map((e=>e.id))]),e.setState(Object.assign(Object.assign({},i),{dragRegion:null,draggedElectrodeIds:[]}))}else e.setState(Object.assign(Object.assign({},i),{dragRegion:t.dragRect,draggedElectrodeIds:c.map((e=>e.id))}));e.scheduleRepaint()},v=(e,t)=>{var r,n,s;if(e.type!==l.II.Release)return;const o=t.getState();if(null===o)return;const i=o.electrodeBoundingBoxes.filter((t=>(0,g.Xz)(e.point,[t.x,t.y],o.radius))).map((e=>e.id));if(0===i.length)return void(e.modifiers.ctrl||e.modifiers.shift||o.dragRegion||null===(r=t.getProps())||void 0===r||r.onSelectedElectrodeIdsChanged([]));const c=i[0],a=(null===(n=t.getProps())||void 0===n?void 0:n.selectedElectrodeIds)||[],d=e.modifiers.ctrl?a.includes(c)?a.filter((e=>e!==c)):[...a,c]:e.modifiers.shift?[...a,c]:[c];null===(s=t.getProps())||void 0===s||s.onSelectedElectrodeIdsChanged(d),t.scheduleRepaint()},x=(e,t)=>{if(e.type!==l.II.Move)return;const r=t.getState();if(null===r)return;const n=r.electrodeBoundingBoxes.filter((t=>(0,g.Xz)(e.point,[t.x,t.y],r.radius))).map((e=>e.id));t.setState(Object.assign(Object.assign({},r),{hoveredElectrodeId:0===n.length?null:n[0]})),t.scheduleRepaint()},_=()=>new l.Fw(y,b,m,{dragHandlers:[E],discreteMouseEventHandlers:[v,x]}),j=(e,t)=>e+1,O=({recording:e,timeseriesData:t,selection:r,width:n,height:i})=>{const c=r.selectedElectrodeIds,[u,g]=(0,s.useState)({}),[h,p]=(0,s.useReducer)(j,0);(0,s.useEffect)((()=>{const e=r.currentTimepoint;if(void 0===e||!c||!t)return void g({});const n={};for(let r of c){const s=t.getChannelData(r,Math.floor(e),Math.floor(e)+1,1);n[r+""]=s[0]}g(n),Object.values(n).filter((e=>isNaN(e))).length>0&&setTimeout((()=>{p({type:"increment"})}),500)}),[t,r,c,g,h,p]);const m=(0,d.F0)(e.recordingObject),f={electrodes:(0,s.useMemo)((()=>{const e=(r.ampScaleFactor||1)/((null==m?void 0:m.noise_level)||1)*1/5,t=t=>{const r=u[t];return isNaN(r)?"lightgray":(e=>{if(e<=0)return"black";if(e>=1)return"white";const t=Math.floor(255*e);return`rgb(${t}, ${t}, ${t})`})(-r*e)};return(m?((e,t)=>{if(e&&t&&t.length!==e.length)throw Error("Electrode ID count does not match location count.");return t.map(((t,r)=>{const n=e[r];return{label:t+"",x:n[0],y:n[1],electrodeId:t}}))})(m.geom,m.channel_ids):[]).map((e=>Object.assign(Object.assign({},e),{id:e.electrodeId,color:t(e.electrodeId)})))}),[m,u,r.ampScaleFactor]),selectedElectrodeIds:(0,s.useMemo)((()=>r.selectedElectrodeIds||[]),[r.selectedElectrodeIds]),onSelectedElectrodeIdsChanged:(0,s.useMemo)((()=>e=>{}),[]),width:n,height:i},b=(0,l.sJ)(_,f),y=(0,l.jU)([b]);return o().createElement(a.ZP,Object.assign({layers:y},{width:n,height:i}))},S=({recording:e,recordingInfo:t,sorting:r,selection:n,selectionDispatch:a,width:l,height:d})=>{var u;const g=(0,s.useCallback)((e=>{a({type:"SetCurrentTimepointVelocity",velocity:0})}),[a]),h=(0,s.useCallback)((e=>{a({type:"SetCurrentTimepointVelocity",velocity:50})}),[a]),p=(0,c.Z)(e.recordingObject,t);return o().createElement(i.Z,{width:l||400,height:d||400,initialPosition:150},o().createElement("div",null,(null===(u=n.animation)||void 0===u?void 0:u.currentTimepointVelocity)?o().createElement("button",{onClick:g},"Stop animation"):o().createElement("button",{onClick:h},"Start animation")),o().createElement(O,Object.assign({},{recording:e,timeseriesData:p,selection:n},{width:0,height:0})))};function C(e){e.registerPlugin({type:"SortingView",name:"FireTrack",label:"FireTrack",priority:50,component:S,icon:o().createElement(n.Z,null)})}},3660:(e,t,r)=>{"use strict";r.d(t,{Z:()=>a});var n=r(45185),s=r(56271),o=r(76827),i=function(e,t,r,n){return new(r||(r=Promise))((function(s,o){function i(e){try{a(n.next(e))}catch(e){o(e)}}function c(e){try{a(n.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,c)}a((n=n.apply(e,t||[])).next())}))};const c=(0,n.createCalculationPool)({maxSimultaneous:4,method:"stack"}),a=(e,t)=>{const r=(0,s.useContext)(n.HitherContext),a=(0,s.useMemo)((()=>t=>i(void 0,void 0,void 0,(function*(){switch(t.type){case"dataSegment":return yield(n={hither:r,recordingObject:e,ds_factor:t.ds_factor,segment_num:t.segment_num,segment_size:t.segment_size},i(void 0,void 0,void 0,(function*(){const{hither:e,recordingObject:t,ds_factor:r,segment_num:s,segment_size:o}=n;return(yield e.createHitherJob("createjob_get_timeseries_segment",{recording_object:t,ds_factor:r,segment_num:s,segment_size:o},{useClientCache:!0,calculationPool:c}).wait()).traces})))}var n}))),[r,e]),l=(0,o.Z)(a),d=t.channel_ids.length,u=Math.ceil(1e5/d),g=(0,s.useMemo)((()=>(e,r,n,s)=>{const o=Math.floor(Math.max(0,r)/u),i=Math.ceil((Math.min(n,t.num_frames)-1)/u),c=[];for(let e=o;e<=i;e++)e===o&&e===i?c.push({segment_num:e,t1:e*u,t2:(e+1)*u,src1:r-e*u,src2:n-e*u,dst1:0,dst2:n-r}):e===o?c.push({segment_num:e,t1:e*u,t2:(e+1)*u,src1:r-e*u,src2:u,dst1:0,dst2:u+e*u-r}):e===i?c.push({segment_num:e,t1:e*u,t2:(e+1)*u,src1:0,src2:n-e*u,dst1:e*u-r,dst2:n-r}):c.push({segment_num:e,t1:e*u,t2:(e+1)*u,src1:0,src2:u,dst1:e*u-r,dst2:(e+1)*u-r});const a=[];if(1===s){for(let e=r;e<n;e++)a.push(NaN);for(let t of c){const r=l.get({type:"dataSegment",ds_factor:s,segment_num:t.segment_num,segment_size:u});if(r)for(let n=0;n<t.src2-t.src1;n++)a[t.dst1+n]=r[e][t.src1+n]}}else{for(let e=r;e<n;e++)a.push(NaN),a.push(NaN);for(let t of c){const r=l.get({type:"dataSegment",ds_factor:s,segment_num:t.segment_num,segment_size:u});if(r)for(let n=0;n<t.src2-t.src1;n++)a[2*(t.dst1+n)]=r[e][2*(t.src1+n)],a[2*(t.dst1+n)+1]=r[e][2*(t.src1+n)+1]}}return a}),[l,t.num_frames,u]);return(0,s.useMemo)((()=>({getChannelData:g,requestChannelData:g,numChannels:()=>t.channel_ids.length,numTimepoints:()=>t.num_frames,getSampleRate:()=>t.sampling_frequency})),[g,t])}},95318:e=>{e.exports=function(e){return e&&e.__esModule?e:{default:e}},e.exports.default=e.exports,e.exports.__esModule=!0},20862:(e,t,r)=>{var n=r(50008).default;function s(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return s=function(){return e},e}e.exports=function(e){if(e&&e.__esModule)return e;if(null===e||"object"!==n(e)&&"function"!=typeof e)return{default:e};var t=s();if(t&&t.has(e))return t.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e)if(Object.prototype.hasOwnProperty.call(e,i)){var c=o?Object.getOwnPropertyDescriptor(e,i):null;c&&(c.get||c.set)?Object.defineProperty(r,i,c):r[i]=e[i]}return r.default=e,t&&t.set(e,r),r},e.exports.default=e.exports,e.exports.__esModule=!0},50008:e=>{function t(r){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?(e.exports=t=function(e){return typeof e},e.exports.default=e.exports,e.exports.__esModule=!0):(e.exports=t=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.default=e.exports,e.exports.__esModule=!0),t(r)}e.exports=t,e.exports.default=e.exports,e.exports.__esModule=!0},63847:(e,t,r)=>{"use strict";var n=r(95318),s=r(20862);t.Z=void 0;var o=s(r(56271)),i=(0,n(r(2108)).default)(o.createElement("path",{d:"M10 12c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM6 8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12-8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-4 8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm4-4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-4-4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-4-4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"}),"Grain");t.Z=i},2108:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.createSvgIcon}});var n=r(28546)}}]);